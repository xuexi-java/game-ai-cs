# å¤šé˜¶æ®µæ„å»º - æ„å»ºé˜¶æ®µ
# ä½¿ç”¨å›½å†…é•œåƒæºä»¥é¿å…ç½‘ç»œé—®é¢˜
FROM node:20.19.5-alpine AS builder

# âœ… å®‰è£… OpenSSL å’Œå¿…è¦çš„æ„å»ºå·¥å…·ï¼ˆPrisma éœ€è¦ï¼‰
RUN apk add --no-cache openssl openssl-dev libc6-compat

WORKDIR /app

# å¤åˆ¶ package æ–‡ä»¶
COPY package*.json ./

# å¤åˆ¶ prisma schemaï¼ˆç°åœ¨åœ¨ backend ç›®å½•ä¸‹ï¼‰
COPY prisma ./prisma/

# å®‰è£…ä¾èµ–ï¼ˆåŒ…æ‹¬devDependenciesï¼Œå› ä¸ºéœ€è¦prismaå’Œtypescriptï¼‰
RUN npm ci --legacy-peer-deps

# å¼ºåˆ¶å®‰è£…æ­£ç¡®ç‰ˆæœ¬çš„ @prisma/client å’Œ prisma CLIï¼ˆç¡®ä¿ç‰ˆæœ¬åŒ¹é…ï¼‰
# è¿™ç¡®ä¿å³ä½¿ package-lock.json ä¸­æœ‰å…¶ä»–ç‰ˆæœ¬ï¼Œä¹Ÿä¼šå®‰è£…æ­£ç¡®çš„ç‰ˆæœ¬
RUN npm install @prisma/client@5.7.0 prisma@5.7.0 --save-dev --legacy-peer-deps --no-save

# è®¾ç½®å ä½ç¬¦ DATABASE_URL ç¯å¢ƒå˜é‡ï¼ˆprisma generate éœ€è¦è¯»å– schema ä¸­çš„ env("DATABASE_URL")ï¼‰
# prisma generate ä¸éœ€è¦çœŸå®çš„æ•°æ®åº“è¿æ¥ï¼Œåªéœ€è¦ç¯å¢ƒå˜é‡å­˜åœ¨å³å¯
ENV DATABASE_URL="postgresql://placeholder:placeholder@localhost:5432/placeholder?schema=public"

# ç”Ÿæˆ Prisma Clientï¼ˆä¸ºäº† TypeScript ç¼–è¯‘èƒ½é€šè¿‡ï¼‰
# éªŒè¯å¿…è¦æ–‡ä»¶å­˜åœ¨ï¼Œç„¶åç”Ÿæˆ Client
# è®¾ç½®é‡è¯•æœºåˆ¶ä»¥å¤„ç†ç½‘ç»œé—®é¢˜
RUN echo "Current directory: $(pwd)" && \
    echo "Prisma schema exists: $(test -f ./prisma/schema.prisma && echo 'yes' || echo 'no')" && \
    echo "@prisma/client version: $(npm list @prisma/client 2>/dev/null | grep @prisma/client || echo 'not found')" && \
    echo "Prisma CLI version: $(./node_modules/.bin/prisma --version 2>/dev/null || echo 'not found')" && \
    echo "Prisma CLI available: $(test -f ./node_modules/.bin/prisma && echo 'yes' || echo 'no')" && \
    (./node_modules/.bin/prisma generate --schema=./prisma/schema.prisma || \
     (echo "First attempt failed, retrying..." && sleep 5 && ./node_modules/.bin/prisma generate --schema=./prisma/schema.prisma))

# å¤åˆ¶åç«¯æºä»£ç 
COPY . .

# ç¼–è¯‘ seed.ts æ–‡ä»¶ï¼ˆç¡®ä¿ seed.js å­˜åœ¨ï¼‰
RUN echo "ç¼–è¯‘ seed.ts æ–‡ä»¶..." && \
    if [ -f prisma/seed.ts ]; then \
      npx tsc prisma/seed.ts --outDir prisma --module commonjs --esModuleInterop --resolveJsonModule --skipLibCheck && \
      echo "âœ“ seed.ts ç¼–è¯‘å®Œæˆ"; \
    else \
      echo "âš ï¸  prisma/seed.ts ä¸å­˜åœ¨ï¼Œè·³è¿‡ç¼–è¯‘"; \
    fi

# æ„å»ºåº”ç”¨ï¼ˆæ·»åŠ é”™è¯¯å¤„ç†å’ŒéªŒè¯ï¼‰
RUN echo "Starting build process..." && \
    echo "Current directory: $(pwd)" && \
    echo "Checking source files..." && \
    ls -la src/ | head -5 && \
    echo "Checking tsconfig files..." && \
    cat tsconfig.json | grep -E "(outDir|include|exclude)" && \
    cat tsconfig.build.json && \
    cat nest-cli.json && \
    echo "Running build command..." && \
    npm run build 2>&1 && \
    echo "Build command completed" && \
    echo "Checking if JS files were generated..." && \
    if [ -z "$(find dist -name '*.js' -type f 2>/dev/null | head -1)" ]; then \
      echo "WARNING: No JS files found after nest build, compiling with tsc directly..." && \
      rm -rf dist && \
      echo "Running tsc compilation (showing all output)..." && \
      npx tsc --project tsconfig.build.json 2>&1 && \
      TSC_EXIT=$? && \
      echo "Tsc exit code: $TSC_EXIT" && \
      if [ $TSC_EXIT -ne 0 ]; then \
        echo "ERROR: Tsc compilation failed with exit code $TSC_EXIT" && \
        exit 1; \
      fi && \
      echo "Checking if dist directory was created..." && \
      if [ ! -d dist ]; then \
        echo "ERROR: dist directory was not created!" && \
        echo "Listing all files in current directory:" && \
        ls -la . && \
        echo "Checking for TypeScript errors above..." && \
        exit 1; \
      fi && \
      echo "Dist directory created successfully" && \
      echo "Tsc compilation completed"; \
    fi && \
    echo "Checking dist directory structure..." && \
    if [ ! -d dist ]; then \
      echo "ERROR: dist directory does not exist after compilation!" && \
      echo "Checking current directory contents:" && \
      ls -la . && \
      echo "Checking for any compilation errors above..." && \
      exit 1; \
    fi && \
    find dist -type f -name "*.js" | head -10 && \
    ls -la dist/ && \
    MAIN_JS=$(find dist -name "main.js" -type f 2>/dev/null | head -1) && \
    if [ -z "$MAIN_JS" ] && [ -f dist/src/main.js ]; then \
      MAIN_JS="dist/src/main.js"; \
    fi && \
    if [ -z "$MAIN_JS" ]; then \
      echo "ERROR: main.js not found after build!"; \
      echo "Searching for main.js:"; \
      find . -name "main.js" -type f 2>/dev/null || echo "main.js not found anywhere"; \
      echo "Dist directory tree:"; \
      find dist -type f | head -30; \
      exit 1; \
    fi && \
    echo "âœ“ Build verification passed: main.js found at $MAIN_JS" && \
    ls -lh "$MAIN_JS"

# --- ç”Ÿäº§é˜¶æ®µ ---
# ä½¿ç”¨å›½å†…é•œåƒæºä»¥é¿å…ç½‘ç»œé—®é¢˜
FROM node:20.19.5-alpine AS production

# âœ… å®‰è£… OpenSSLï¼ˆè¿è¡Œæ—¶ä¹Ÿéœ€è¦ï¼‰
RUN apk add --no-cache openssl libc6-compat

WORKDIR /app

ENV NODE_ENV=production

# å¤åˆ¶ package æ–‡ä»¶å’Œ prisma schema
COPY package*.json ./
COPY prisma ./prisma/

# å®‰è£…ç”Ÿäº§ä¾èµ–
RUN npm ci --only=production --legacy-peer-deps && npm cache clean --force

# å®‰è£… Prisma CLIï¼ˆç”¨äºè¿ç§»å’Œç”Ÿæˆï¼‰
RUN npm install -g prisma@5.7.0

# å®‰è£… ts-nodeï¼ˆç”¨äºè¿è¡Œæµ‹è¯•è„šæœ¬ï¼‰
RUN npm install -g ts-node@^10.9.2 typescript@^5.3.3

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶æ„å»ºäº§ç‰©ã€è„šæœ¬å’Œé…ç½®æ–‡ä»¶
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/scripts ./scripts
COPY --from=builder /app/tsconfig.json ./tsconfig.json

# éªŒè¯æ„å»ºäº§ç‰©å·²æˆåŠŸå¤åˆ¶
RUN echo "Verifying build artifacts..." && \
    MAIN_JS=$(find dist -name "main.js" -type f 2>/dev/null | head -1) && \
    if [ -z "$MAIN_JS" ]; then \
      echo "ERROR: main.js not found after copy from builder stage!"; \
      echo "Dist directory contents:"; \
      ls -la dist/ || echo "Dist directory does not exist!"; \
      find dist -type f | head -20; \
      exit 1; \
    fi && \
    echo "âœ“ Build artifacts verification passed: main.js found at $MAIN_JS"

# åˆ›å»ºä¸Šä¼ ç›®å½•å’Œæ—¥å¿—ç›®å½•
RUN mkdir -p uploads/avatars logs

# æš´éœ²ç«¯å£
EXPOSE 21101

# å¯åŠ¨åº”ç”¨ï¼ˆç›´æ¥ä½¿ç”¨ CMDï¼Œä¾èµ–å¥åº·æ£€æŸ¥ç¡®ä¿æ•°æ®åº“å°±ç»ªï¼‰
# æ³¨æ„ï¼šç”±äºä½¿ç”¨äº† depends_on çš„ condition: service_healthyï¼Œæ•°æ®åº“å·²ç»å°±ç»ª
# prisma ä¼šè‡ªåŠ¨æŸ¥æ‰¾ ./prisma/schema.prisma
# è¿è¡Œæ•°æ®åº“è¿ç§»å’Œç§å­æ•°æ®åˆå§‹åŒ–
# ç§å­æ•°æ®åˆå§‹åŒ–é€»è¾‘ï¼š
#   - é¦–æ¬¡éƒ¨ç½²ï¼šè‡ªåŠ¨æ£€æµ‹æ–°æ•°æ®åº“å¹¶åˆå§‹åŒ–ç§å­æ•°æ®
#   - åç»­æ›´æ–°ï¼šæ£€æµ‹åˆ°æ•°æ®åº“å·²åˆå§‹åŒ–ï¼Œè‡ªåŠ¨è·³è¿‡ï¼ˆé€šè¿‡æ£€æŸ¥ admin ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼‰
#   - å¼ºåˆ¶è·³è¿‡ï¼šè®¾ç½®ç¯å¢ƒå˜é‡ SKIP_SEED=true
CMD ["sh", "-c", "echo 'ğŸ”§ ç”Ÿæˆ Prisma Client...' && prisma generate && echo 'ğŸ“Š è¿è¡Œæ•°æ®åº“è¿ç§»...' && prisma migrate deploy && echo 'ğŸŒ± æ£€æŸ¥å¹¶åˆå§‹åŒ–ç§å­æ•°æ®...' && (npx prisma db seed || echo 'âš ï¸  ç§å­æ•°æ®åˆå§‹åŒ–å¤±è´¥æˆ–å·²å­˜åœ¨ï¼Œç»§ç»­å¯åŠ¨æœåŠ¡...') && echo 'ğŸš€ å¯åŠ¨åº”ç”¨...' && MAIN_JS=$(find dist -name 'main.js' -type f 2>/dev/null | head -1) && if [ -z \"$MAIN_JS\" ]; then echo 'âŒ é”™è¯¯: æ‰¾ä¸åˆ° main.js æ–‡ä»¶'; exit 1; fi && node \"$MAIN_JS\""]
