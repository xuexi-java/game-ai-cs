# 队列一致性测试脚本

## 简介

`test-queue-consistency.ts` 是一个用于验证 Redis 队列数据一致性保障机制的测试脚本。

## 功能

该脚本会测试以下内容：

1. **Redis 连接** - 验证 Redis 服务是否可用
2. **数据库连接** - 验证数据库连接是否正常
3. **队列操作** - 测试添加、查询、移除操作
4. **数据一致性** - 检查数据库和 Redis 中的数据是否一致
5. **队列位置计算** - 验证排队位置是否正确
6. **队列键格式** - 检查 Redis 键的格式是否正确
7. **重试机制** - 验证重试机制是否已实现
8. **定时任务配置** - 检查定时任务配置
9. **启动恢复机制** - 验证启动时的数据恢复

## 使用方法

### ⚠️ 重要提示

**此脚本必须在 Docker 容器中运行**，因为需要连接到容器内的 Redis 和数据库服务。

### 方法 1: 在 Docker 容器中运行（推荐）

```bash
# 在项目根目录执行
docker-compose exec backend npm run test:queue
```

### 方法 2: 进入容器后运行

```bash
# 进入后端容器
docker-compose exec backend sh

# 在容器内运行
npm run test:queue
```

### 方法 3: 如果需要在宿主机运行（不推荐）

脚本会自动检测环境，如果在宿主机运行，会尝试连接到映射的端口：
- Redis: localhost:22102
- 数据库: localhost:22101

但建议在容器内运行以确保环境一致。

## 环境要求

- Node.js 20.19.5+
- Redis 服务运行中
- 数据库连接正常
- 环境变量已设置（REDIS_HOST, REDIS_PORT 等）

## 测试结果说明

### ✅ 通过
- 所有测试项都通过，系统运行正常

### ❌ 失败
- 某些测试项失败，需要检查：
  1. Redis 服务是否正常运行
  2. 数据库连接是否正常
  3. 是否有数据不一致的情况
  4. 定时任务是否正常运行

## 常见问题

### Q: 测试显示数据不一致怎么办？

A: 这是正常的，如果发现不一致：
1. 等待 5 分钟，让一致性检查任务自动修复
2. 再次运行测试脚本验证
3. 如果仍然不一致，检查应用日志

### Q: 如何测试重试机制？

A: 重试机制需要在 Redis 临时故障时测试：
1. 停止 Redis: `docker-compose stop redis`
2. 创建会话（会触发重试）
3. 观察日志中的重试信息
4. 重启 Redis: `docker-compose start redis`

### Q: 如何验证定时任务是否运行？

A: 查看应用日志：
```bash
docker-compose logs backend | grep -i "一致性检查\|同步队列"
```

## 输出示例

```
🚀 开始队列一致性测试...

============================================================

✅ Redis 连接: Redis 连接正常
✅ 数据库连接: 数据库连接正常

📋 执行功能测试...

✅ 队列操作-添加: 成功添加测试会话 test-1234567890
✅ 队列操作-查询: 成功查询到会话位置: 1
✅ 队列操作-移除: 成功移除会话
✅ 数据一致性检查: 所有 5 个会话都在 Redis 中
✅ 队列位置计算: 所有 5 个会话的位置都正确
✅ 队列键格式: 所有 3 个队列键格式正确
✅ 重试机制: 重试机制已实现
✅ 定时任务配置: 定时任务已配置
✅ 启动恢复机制: 所有会话都在 Redis 中

============================================================

📊 测试总结:

总计: 9 个测试
通过: 9 ✅
失败: 0 

============================================================
```

