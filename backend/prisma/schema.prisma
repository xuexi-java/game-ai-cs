// Prisma Schema for AI 客服系统
// 数据库设计文档的完整实现

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== 游戏配置 ====================

model Game {
  id          String   @id @default(uuid())
  name        String   @unique
  icon        String?
  enabled     Boolean  @default(true)
  difyApiKey  String   @db.Text // 加密存储
  difyBaseUrl String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  // 关系
  servers Server[]
  tickets Ticket[]

  @@index([enabled])
  @@index([name])
  @@map("Game")
}

// ==================== 区服 ====================

model Server {
  id        String   @id @default(uuid())
  gameId    String
  name      String
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  // 关系
  game   Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  tickets Ticket[]

  @@index([gameId])
  @@index([gameId, enabled])
  @@map("Server")
}

// ==================== 工单 ====================

enum IdentityStatus {
  NOT_VERIFIED
  VERIFIED_PAYMENT
}

enum TicketStatus {
  IN_PROGRESS
  WAITING
  RESOLVED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model Ticket {
  id              String         @id @default(uuid())
  ticketNo        String         @unique
  gameId          String
  serverId        String?
  serverName      String? // 玩家输入的区服
  playerIdOrName  String
  description     String         @db.Text
  occurredAt      DateTime?
  paymentOrderNo  String?
  identityStatus  IdentityStatus @default(NOT_VERIFIED)
  status          TicketStatus   @default(IN_PROGRESS)
  priority        Priority       @default(NORMAL)
  priorityScore   Int            @default(50) // 新增：优先级分数
  token           String         @unique
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  closedAt        DateTime?
  deletedAt       DateTime?

  // 关系
  game            Game              @relation(fields: [gameId], references: [id], onDelete: Cascade)
  server          Server?          @relation(fields: [serverId], references: [id], onDelete: SetNull)
  attachments     TicketAttachment[]
  sessions        Session[]
  messages        TicketMessage[]
  satisfactionRatings SatisfactionRating[]
  ticketIssueTypes TicketIssueType[] // 新增：关联的问题类型

  @@index([ticketNo])
  @@index([gameId, playerIdOrName])
  @@index([status])
  @@index([priority])
  @@index([priorityScore(desc)]) // 新增：优先级分数索引
  @@index([createdAt])
  @@index([token])
  @@map("Ticket")
}

// ==================== 工单附件 ====================

model TicketAttachment {
  id        String   @id @default(uuid())
  ticketId  String
  fileUrl   String
  fileName  String
  fileType  String
  fileSize  Int
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  // 关系
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@map("TicketAttachment")
}

// ==================== 会话 ====================

enum SessionStatus {
  PENDING
  QUEUED
  IN_PROGRESS
  CLOSED
}

enum Urgency {
  URGENT
  NON_URGENT
}

model Session {
  id            String        @id @default(uuid())
  ticketId      String
  agentId       String?
  status        SessionStatus @default(PENDING)
  detectedIntent String?
  aiUrgency     Urgency?
  playerUrgency Urgency?
  priorityScore Int          @default(0)
  queuePosition Int?
  queuedAt      DateTime?
  transferAt    DateTime?
  startedAt     DateTime?
  closedAt      DateTime?
  difyConversationId String?
  difyStatus    String?
  allowManualTransfer Boolean @default(true)
  transferReason String?
  transferIssueTypeId String?
  manuallyAssigned Boolean @default(false) // 是否手动分配过
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  metadata      Json?         // 存储会话级元数据，如：{ "playerLanguage": "en", "detectionHistory": [...] }

  // 关系
  ticket            Ticket              @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  agent             User?              @relation(fields: [agentId], references: [id], onDelete: SetNull)
  messages          Message[]
  satisfactionRating SatisfactionRating?

  @@index([ticketId])
  @@index([agentId])
  @@index([status])
  @@index([queuedAt])
  @@index([priorityScore(desc), queuedAt(asc)])
  @@map("Session")
}

// ==================== 消息 ====================

enum SenderType {
  PLAYER
  AI
  AGENT
  SYSTEM
}

enum MessageType {
  TEXT
  IMAGE
  SYSTEM_NOTICE
  QUICK_OPTION
}

model Message {
  id          String      @id @default(uuid())
  sessionId   String
  senderType  SenderType
  senderId    String? // Agent ID (当senderType为AGENT时)
  content     String      @db.Text
  messageType MessageType @default(TEXT)
  metadata    Json?
  createdAt   DateTime    @default(now())

  // 关系
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  agent   User?   @relation(fields: [senderId], references: [id], onDelete: SetNull)

  @@index([sessionId])
  @@index([createdAt])
  @@index([sessionId, createdAt])
  @@map("Message")
}

// ==================== 工单消息 ====================

model TicketMessage {
  id        String   @id @default(uuid())
  ticketId  String
  senderId  String? // Agent ID
  content   String   @db.Text
  createdAt DateTime @default(now())

  // 关系
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  sender User?  @relation("TicketMessages", fields: [senderId], references: [id], onDelete: SetNull)

  @@index([ticketId])
  @@index([createdAt])
  @@map("TicketMessage")
}

// ==================== 用户 ====================

enum UserRole {
  ADMIN
  AGENT
}

model User {
  id          String    @id @default(uuid())
  username    String    @unique
  password    String // BCrypt加密
  role        UserRole
  realName    String?
  email       String?
  phone       String?
  avatar      String?
  isOnline    Boolean   @default(false)
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  // 关系
  sessions                 Session[]            @relation
  messages                 Message[]
  ticketMessages           TicketMessage[]      @relation("TicketMessages")
  satisfactionRatings      SatisfactionRating[]
  quickReplyCategories     QuickReplyCategory[] @relation("QuickReplyCategories")
  quickReplies             QuickReply[]         @relation("QuickReplies")
  quickReplyFavorites      QuickReplyFavorite[] @relation("QuickReplyFavorites")

  @@index([username])
  @@index([role])
  @@index([isOnline])
  @@map("User")
}

// ==================== 紧急排序规则 ====================

model UrgencyRule {
  id            String   @id @default(uuid())
  name          String
  enabled       Boolean  @default(true)
  priorityWeight Int      // 1-100
  description   String?  @db.Text
  conditions    Json     // 匹配条件JSON
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?

  @@index([enabled])
  @@index([priorityWeight(desc)])
  @@map("UrgencyRule")
}

// ==================== 满意度评价 ====================

model SatisfactionRating {
  id        String   @id @default(uuid())
  sessionId String   @unique
  ticketId  String
  agentId   String?
  rating    Int      // 1-5
  tags      String[]
  comment   String?  @db.Text
  createdAt DateTime @default(now())

  // 关系
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  ticket  Ticket  @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  agent   User?   @relation(fields: [agentId], references: [id], onDelete: SetNull)

  @@index([sessionId])
  @@index([ticketId])
  @@index([agentId])
  @@index([rating])
  @@map("SatisfactionRating")
}



// ==================== 问题类型 ====================

model IssueType {
  id                    String   @id @default(uuid())
  name                  String   // 问题类型名称
  description           String?  @db.Text // 问题描述
  priorityWeight        Int      @default(50) // 优先级权重 1-100
  enabled               Boolean  @default(true) // 是否启用
  sortOrder             Int      @default(0) // 显示排序
  icon                  String?  // 图标
  requireDirectTransfer Boolean  @default(false) // 是否需要直接转接人工客服
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  deletedAt             DateTime?

  // 关系
  ticketIssueTypes TicketIssueType[]

  @@index([enabled, sortOrder])
  @@index([priorityWeight(desc)])
  @@index([requireDirectTransfer])
  @@map("IssueType")
}

// ==================== 工单-问题类型关联 ====================

model TicketIssueType {
  id          String   @id @default(uuid())
  ticketId    String
  issueTypeId String
  createdAt   DateTime @default(now())

  // 关系
  ticket    Ticket    @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  issueType IssueType @relation(fields: [issueTypeId], references: [id], onDelete: Cascade)

  @@unique([ticketId, issueTypeId])
  @@index([ticketId])
  @@index([issueTypeId])
  @@map("TicketIssueType")
}

// ==================== 快捷回复分类 ====================

model QuickReplyCategory {
  id        String   @id @default(uuid())
  name      String
  isGlobal  Boolean  @default(false)
  creatorId String?
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  // 关系
  replies   QuickReply[]
  creator   User?    @relation("QuickReplyCategories", fields: [creatorId], references: [id])

  // ✅ 允许不同用户创建相同名称的分类，但同一用户不能创建重复名称的分类
  @@unique([name, creatorId])
  @@index([isGlobal, isActive, deletedAt])
  @@index([creatorId, isActive, deletedAt])
  @@map("QuickReplyCategory")
}

// ==================== 快捷回复 ====================

model QuickReply {
  id            String   @id @default(uuid())
  categoryId    String
  content       String   @db.Text
  isGlobal      Boolean  @default(false)
  creatorId     String?
  isActive      Boolean  @default(true)
  sortOrder     Int      @default(0)
  usageCount    Int      @default(0)
  favoriteCount Int      @default(0)
  lastUsedAt    DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?

  // 关系
  category      QuickReplyCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  creator       User?              @relation("QuickReplies", fields: [creatorId], references: [id], onDelete: SetNull)
  favorites     QuickReplyFavorite[]

  @@index([categoryId, isActive, deletedAt])
  @@index([isGlobal, isActive, deletedAt])
  @@index([creatorId, isActive, deletedAt])
  @@index([usageCount(desc)])
  @@index([favoriteCount(desc)])
  @@index([lastUsedAt(desc)])
  @@map("QuickReply")
}

// ==================== 快捷回复收藏 ====================

model QuickReplyFavorite {
  id        String   @id @default(uuid())
  userId    String
  replyId   String
  createdAt DateTime @default(now())

  // 关系
  user  User       @relation("QuickReplyFavorites", fields: [userId], references: [id], onDelete: Cascade)
  reply QuickReply @relation(fields: [replyId], references: [id], onDelete: Cascade)

  @@unique([userId, replyId])
  @@index([userId])
  @@index([replyId])
  @@map("QuickReplyFavorite")
}
