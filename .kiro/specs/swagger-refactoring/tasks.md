# 实现计划

- [x] 1. 创建 BaseResponse DTO
  - [x] 1.1 创建 `src/common/dto/base-response.dto.ts` 文件
    - 定义泛型类 `BaseResponse<T>`
    - 添加 `code`、`message`、`timestamp` 属性及 `@ApiProperty` 装饰器
    - `data` 属性不添加 `@ApiProperty`（由装饰器动态处理）
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 2. 创建 @ApiResult 装饰器
  - [x] 2.1 创建 `src/common/decorators/api-result.decorator.ts` 文件
    - 实现 `ApiResult<TModel extends Type<any>>(model: TModel, isArray?: boolean)` 函数
    - 使用 `ApiExtraModels` 注册 `BaseResponse` 和传入的 `model`
    - 使用 `ApiOkResponse` 配合 `allOf` 组合 Schema
    - 处理 `isArray` 参数，正确生成数组类型 Schema
    - _Requirements: 2.6, 2.7, 2.8, 2.9_
  - [ ]* 2.2 编写 @ApiResult 装饰器单元测试
    - 测试正常情况：单个 DTO 模型
    - 测试数组情况：`isArray: true`
    - 测试边界情况：空模型或无效输入
    - **Property 3: 数组类型响应 Schema 正确性**
    - **Validates: Requirements 2.9**

- [x] 3. 创建 Swagger 工具函数并配置文档拆分
  - [x] 3.1 创建 `src/common/swagger/swagger-filter.util.ts` 工具文件
    - 实现 `isAdminEndpoint(path: string, tags: string[]): boolean` 函数
    - 实现 `isPlayerEndpoint(path: string, tags: string[]): boolean` 函数
    - 提取过滤逻辑便于单元测试
    - _Requirements: 1.2, 1.5_
  - [x] 3.2 修改 `src/main.ts` 配置管理端 Swagger 文档
    - 创建 Admin DocumentBuilder 实例
    - 设置路径为 `/api/v1/docs/admin`
    - 启用 `.addBearerAuth()` 认证
    - 实现基于 security 字段的过滤逻辑（需要认证的接口）
    - _Requirements: 1.1, 1.2, 1.3_
  - [x] 3.3 修改 `src/main.ts` 配置玩家端 Swagger 文档
    - 创建 Player DocumentBuilder 实例
    - 设置路径为 `/api/v1/docs/player`
    - 实现基于 security 字段的过滤逻辑（公开接口）
    - _Requirements: 1.4, 1.5_
  - [x] 3.4 确保全局配置保留
    - 验证 ValidationPipe、Cors、GlobalPrefix 等配置不受影响
    - _Requirements: 1.6_
  - [ ]* 3.5 编写过滤函数单元测试
    - 测试 `isAdminEndpoint`: 路径以 `/admin` 开头、标签以 `Admin` 开头、混合情况
    - 测试 `isPlayerEndpoint`: 路径以 `/app` 或 `/client` 开头、标签以 `App` 开头
    - 测试边界情况：空路径、空标签数组
    - **Property 1: 管理端文档过滤正确性**
    - **Property 2: 玩家端文档过滤正确性**
    - **Validates: Requirements 1.2, 1.5**

- [x] 4. 应用装饰器到示例控制器
  - [x] 4.1 修改 AuthController 应用 @ApiResult 装饰器
    - 在 `login` 端点使用 `@ApiResult(LoginResponseDto)` 替换原有 `@ApiResponse`
    - 确保无 TypeScript 编译错误
    - _Requirements: 3.1, 3.2, 3.3_
  - [ ]* 4.2 编写集成测试验证 Swagger 输出
    - 验证 `/api/v1/docs/admin` 返回 HTTP 200
    - 验证 `/api/v1/docs/player` 返回 HTTP 200
    - 验证 Swagger JSON 中 `components/schemas` 包含 `BaseResponse`
    - 验证响应 Schema 中 `$ref` 正确引用 `LoginResponseDto`
    - _Requirements: 3.4_

- [x] 5. 检查点 - 确保所有测试通过
  - 验证所有核心功能正常工作
  - 确认 Swagger 文档正确拆分并显示
  - 确认 @ApiResult 装饰器正确生成响应 Schema
