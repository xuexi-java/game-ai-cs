# 数据库创建指南

本指南将帮助您快速创建和初始化数据库。

## 前置要求

- Node.js 18+ 已安装
- Docker Desktop 已安装并运行（用于本地开发）
- 或者已安装 PostgreSQL 14+（如果不使用Docker）

## 快速开始（推荐）

### Windows 用户

1. **打开 PowerShell 或 CMD，进入项目目录**

```powershell
cd E:\game-ai-cs
```

2. **运行初始化脚本**

```powershell
.\scripts\init-db.ps1
```

脚本会自动完成：
- 检查并创建 .env 文件
- 启动 Docker 服务（PostgreSQL + Redis）
- 安装依赖
- 生成 Prisma Client
- 运行数据库迁移
- 初始化种子数据

### Linux/Mac 用户

1. **打开终端，进入项目目录**

```bash
cd /path/to/game-ai-cs
```

2. **运行初始化脚本**

```bash
chmod +x scripts/init-db.sh
./scripts/init-db.sh
```

## 手动步骤

如果您想手动执行每个步骤：

### 步骤 1: 安装依赖

```bash
npm install
```

### 步骤 2: 启动 Docker 服务

```bash
# 启动 PostgreSQL 和 Redis
npm run docker:up

# 或者
docker-compose up -d
```

### 步骤 3: 检查数据库连接

等待几秒钟让数据库启动，然后检查：

```bash
docker-compose ps
```

应该看到 `postgres` 和 `redis` 服务都在运行。

### 步骤 4: 生成 Prisma Client

```bash
npm run db:generate
```

### 步骤 5: 运行数据库迁移

```bash
npm run db:migrate
```

这会：
- 创建所有数据表
- 创建所有索引
- 创建所有关系

### 步骤 6: 初始化种子数据

```bash
npm run db:seed
```

这会创建：
- 默认管理员账户（admin / admin123）
- 默认客服账户（agent1 / agent123）
- 示例游戏配置（弹弹堂）
- 示例区服（一区、二区）
- 示例紧急排序规则

## 验证数据库

### 使用 Prisma Studio（可视化工具）

```bash
npm run db:studio
```

这会打开浏览器，您可以在图形界面中查看和编辑数据。

### 使用命令行

```bash
# 连接到 PostgreSQL
docker-compose exec postgres psql -U postgres -d game_ai_cs

# 查看所有表
\dt

# 查看用户表
SELECT * FROM "User";

# 退出
\q
```

## 常见问题

### 1. Docker 未运行

**错误**: `Cannot connect to the Docker daemon`

**解决**: 启动 Docker Desktop

### 2. 端口被占用

**错误**: `port 5432 is already allocated`

**解决**: 
- 检查是否有其他 PostgreSQL 实例在运行
- 修改 `docker-compose.yml` 中的端口映射
- 修改 `.env` 中的 `DATABASE_URL`

### 3. 迁移失败

**错误**: `Migration failed`

**解决**:
```bash
# 重置数据库（会删除所有数据）
npm run db:reset

# 然后重新迁移
npm run db:migrate
```

### 4. Prisma Client 未生成

**错误**: `Cannot find module '@prisma/client'`

**解决**:
```bash
npm run db:generate
```

## 数据库结构

创建完成后，数据库包含以下表：

- `Game` - 游戏配置
- `Server` - 区服
- `Ticket` - 工单
- `TicketAttachment` - 工单附件
- `Session` - 会话
- `Message` - 消息
- `TicketMessage` - 工单消息
- `User` - 用户（管理员/客服）
- `UrgencyRule` - 紧急排序规则
- `SatisfactionRating` - 满意度评价

详细设计请参考 [数据库设计文档](./数据库设计文档.md)

## 下一步

数据库创建完成后，您可以：

1. 查看数据库：`npm run db:studio`
2. 开始开发后端API
3. 开始开发前端界面

## 生产环境部署

生产环境请：

1. 修改 `.env` 中的数据库连接字符串
2. 修改默认密码（使用 bcrypt 加密）
3. 使用 `npm run db:migrate:deploy` 部署迁移
4. 配置数据库备份策略

