# 运维部署命令

## 1. 启动服务

### 1.1 启动主应用（后端 + 数据库 + 前端）

```bash
# 启动所有主服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f backend
```

### 1.2 启动监控服务（Prometheus + Grafana）

```bash
# 启动监控服务
docker-compose -f docker-compose.monitoring.yml up -d

# 查看监控服务状态
docker-compose -f docker-compose.monitoring.yml ps

# 查看监控日志
docker-compose -f docker-compose.monitoring.yml logs -f
```

### 1.3 一键启动所有服务

```bash
docker-compose up -d && docker-compose -f docker-compose.monitoring.yml up -d
```

---

## 2. 停止服务

### 2.1 停止主应用

```bash
docker-compose down
```

### 2.2 停止监控服务

```bash
docker-compose -f docker-compose.monitoring.yml down
```

### 2.3 停止所有服务

```bash
docker-compose down && docker-compose -f docker-compose.monitoring.yml down
```

---

## 3. 重启服务

### 3.1 重启后端服务

```bash
docker-compose restart backend
```

### 3.2 重启监控服务

```bash
docker-compose -f docker-compose.monitoring.yml restart prometheus
docker-compose -f docker-compose.monitoring.yml restart grafana
```

---

## 4. 查看日志

### 4.1 查看后端日志

```bash
# 实时查看
docker-compose logs -f backend

# 查看最近 100 行
docker-compose logs --tail=100 backend
```

### 4.2 查看 Prometheus 日志

```bash
docker-compose -f docker-compose.monitoring.yml logs -f prometheus
```

### 4.3 查看 Grafana 日志

```bash
docker-compose -f docker-compose.monitoring.yml logs -f grafana
```

---

## 5. 数据库操作

### 5.1 进入 PostgreSQL

```bash
docker exec -it game-ai-cs-postgres psql -U postgres -d game_ai_cs
```

### 5.2 数据库备份

```bash
docker exec game-ai-cs-postgres pg_dump -U postgres game_ai_cs > backup.sql
```

### 5.3 数据库恢复

```bash
cat backup.sql | docker exec -i game-ai-cs-postgres psql -U postgres -d game_ai_cs
```

---

## 6. Redis 操作

### 6.1 进入 Redis CLI

```bash
docker exec -it game-ai-cs-redis redis-cli
```

### 6.2 查看 Redis 键

```bash
docker exec -it game-ai-cs-redis redis-cli KEYS "*"
```

### 6.3 清空 Redis

```bash
docker exec -it game-ai-cs-redis redis-cli FLUSHALL
```

---

## 7. 访问地址

### 7.1 应用访问

- 后端 API: http://localhost:21101/api/v1
- 管理端文档: http://localhost:21101/api/v1/docs/admin
- 玩家端文档: http://localhost:21101/api/v1/docs/player
- 管理端前端: http://localhost:20102
- 玩家端前端: http://localhost:20101

### 7.2 监控访问

- Prometheus: http://localhost:9090
- Grafana: http://localhost:3000
  - 默认用户名: `admin`
  - 默认密码: `admin`
- Metrics 端点: http://localhost:21101/api/v1/metrics

---

## 8. 健康检查

### 8.1 检查后端健康

```bash
curl http://localhost:21101/api/v1/metrics
```

### 8.2 检查 Prometheus 目标状态

访问: http://localhost:9090/targets

应显示 `game-ai-backend` 状态为 `UP`

### 8.3 检查 Grafana Dashboard

访问: http://localhost:3000/dashboards

应看到 `Game AI Backend - Overview` Dashboard

---

## 9. 清理数据

### 9.1 清理所有容器和数据卷

```bash
# 停止并删除主应用容器和数据卷
docker-compose down -v

# 停止并删除监控容器和数据卷
docker-compose -f docker-compose.monitoring.yml down -v
```

### 9.2 清理 Docker 镜像

```bash
docker image prune -a
```

---

## 10. 故障排查

### 10.1 后端无法连接数据库

```bash
# 检查数据库容器状态
docker-compose ps postgres

# 查看数据库日志
docker-compose logs postgres

# 重启数据库
docker-compose restart postgres
```

### 10.2 Prometheus 无法抓取指标

```bash
# 检查后端是否启动
docker-compose ps backend

# 检查 metrics 端点
curl http://localhost:21101/api/v1/metrics

# 检查网络连接
docker network inspect game-ai-cs-network
```

### 10.3 Grafana 无数据

```bash
# 检查 Prometheus 数据源
# 访问 Grafana -> Configuration -> Data Sources

# 检查 Prometheus 是否有数据
# 访问 http://localhost:9090/graph
# 执行查询: sum(queue_length)
```

---

## 11. 更新部署

### 11.1 更新后端代码

```bash
# 停止后端
docker-compose stop backend

# 重新构建
docker-compose build backend

# 启动后端
docker-compose up -d backend
```

### 11.2 更新监控配置

```bash
# 修改配置文件后重启
docker-compose -f docker-compose.monitoring.yml restart prometheus
docker-compose -f docker-compose.monitoring.yml restart grafana
```

---

## 12. 生产环境注意事项

### 12.1 环境变量

确保在 `.env` 文件中配置：

```bash
# 数据库
DATABASE_URL=postgresql://postgres:postgres@postgres:5432/game_ai_cs

# JWT
JWT_SECRET=your-production-secret-key

# Redis
REDIS_HOST=redis
REDIS_PORT=6379

# 前端地址
FRONTEND_URL=https://your-domain.com
```

### 12.2 数据持久化

数据卷位置：
- PostgreSQL: `postgres_data`
- Redis: `redis_data`
- Prometheus: `prometheus_data`
- Grafana: `grafana_data`

### 12.3 备份策略

建议定期备份：
- 数据库（每天）
- Redis（每小时）
- Grafana Dashboard 配置（每次修改后）
