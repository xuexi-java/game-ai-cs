# è¿ç»´éƒ¨ç½²å‘½ä»¤

> ğŸ“ **æ—¥å¿—è¯´æ˜**: ç³»ç»Ÿæ—¥å¿—ä¸º JSON å•è¡Œæ ¼å¼ï¼Œstdout/stderr åˆ†æµï¼Œæ”¯æŒ ELK/Lokiã€‚è¯¦è§ [æ—¥å¿—é…ç½®è¯´æ˜](./æ—¥å¿—é…ç½®è¯´æ˜.md)

## 1. å¯åŠ¨æœåŠ¡

### 1.1 å¯åŠ¨ä¸»åº”ç”¨ï¼ˆåç«¯ + æ•°æ®åº“ + å‰ç«¯ï¼‰

```bash
# å¯åŠ¨æ‰€æœ‰ä¸»æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f backend
```

### 1.2 å¯åŠ¨ç›‘æ§æœåŠ¡ï¼ˆPrometheus + Grafanaï¼‰

```bash
# å¯åŠ¨ç›‘æ§æœåŠ¡
docker-compose -f docker-compose.monitoring.yml up -d

# æŸ¥çœ‹ç›‘æ§æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.monitoring.yml ps

# æŸ¥çœ‹ç›‘æ§æ—¥å¿—
docker-compose -f docker-compose.monitoring.yml logs -f
```

### 1.3 ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
docker-compose up -d && docker-compose -f docker-compose.monitoring.yml up -d
```

---

## 2. åœæ­¢æœåŠ¡

### 2.1 åœæ­¢ä¸»åº”ç”¨

```bash
docker-compose down
```

### 2.2 åœæ­¢ç›‘æ§æœåŠ¡

```bash
docker-compose -f docker-compose.monitoring.yml down
```

### 2.3 åœæ­¢æ‰€æœ‰æœåŠ¡

```bash
docker-compose down && docker-compose -f docker-compose.monitoring.yml down
```

---

## 3. é‡å¯æœåŠ¡

### 3.1 é‡å¯åç«¯æœåŠ¡

```bash
docker-compose restart backend
```

### 3.2 é‡å¯ç›‘æ§æœåŠ¡

```bash
docker-compose -f docker-compose.monitoring.yml restart prometheus
docker-compose -f docker-compose.monitoring.yml restart grafana
```

---

## 4. æ—¥å¿—ç®¡ç†

### 4.1 æŸ¥çœ‹æ—¥å¿—

#### Docker ç¯å¢ƒ

```bash
# å®æ—¶æŸ¥çœ‹åç«¯æ—¥å¿—
docker-compose logs -f backend

# æŸ¥çœ‹æœ€è¿‘ 100 è¡Œ
docker-compose logs --tail=100 backend

# æŸ¥çœ‹ Prometheus æ—¥å¿—
docker-compose -f docker-compose.monitoring.yml logs -f prometheus

# æŸ¥çœ‹ Grafana æ—¥å¿—
docker-compose -f docker-compose.monitoring.yml logs -f grafana
```

#### PM2 ç¯å¢ƒ

```bash
# æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
pm2 logs game-ai-backend

# åªæŸ¥çœ‹ stdoutï¼ˆINFO/WARNï¼‰
pm2 logs game-ai-backend --out

# åªæŸ¥çœ‹ stderrï¼ˆERRORï¼‰
pm2 logs game-ai-backend --err

# æ¸…ç©ºæ—¥å¿—
pm2 flush
```

### 4.2 æ—¥å¿—æ–‡ä»¶ä½ç½®

```bash
# Docker ç¯å¢ƒï¼ˆå®¹å™¨å†…ï¼‰
/app/logs/access.log    # stdout æ—¥å¿—ï¼ˆINFO/WARNï¼‰
/app/logs/error.log     # stderr æ—¥å¿—ï¼ˆERRORï¼‰
/app/logs/cleanup.log   # æ¸…ç†æ—¥å¿—

# PM2 ç¯å¢ƒï¼ˆå®¿ä¸»æœºï¼‰
backend/logs/access.log    # stdout æ—¥å¿—
backend/logs/error.log     # stderr æ—¥å¿—
backend/logs/cleanup.log   # æ¸…ç†æ—¥å¿—
```

### 4.3 æ—¥å¿—æŸ¥è¯¢

#### æŒ‰ traceId æŸ¥è¯¢å®Œæ•´è¯·æ±‚é“¾è·¯

```bash
# Docker ç¯å¢ƒ
docker exec game-ai-cs-backend grep "a1b2c3d4-e5f6-7890" /app/logs/access.log /app/logs/error.log

# PM2 ç¯å¢ƒ
grep "a1b2c3d4-e5f6-7890" backend/logs/access.log backend/logs/error.log
```

#### æŒ‰æ—¥å¿—çº§åˆ«æŸ¥è¯¢

```bash
# æŸ¥è¯¢æ‰€æœ‰ ERROR æ—¥å¿—
grep '"level":"ERROR"' backend/logs/error.log | jq .

# æŸ¥è¯¢æ‰€æœ‰ WARN æ—¥å¿—
grep '"level":"WARN"' backend/logs/access.log | jq .
```

#### æŒ‰ä¸šåŠ¡æ“ä½œæŸ¥è¯¢

```bash
# æŸ¥è¯¢å·¥å•åˆ›å»ºæ—¥å¿—
grep '"action":"ticket_created"' backend/logs/access.log | jq .

# æŸ¥è¯¢ä¼šè¯è½¬äººå·¥æ—¥å¿—
grep '"action":"session_transferred"' backend/logs/access.log | jq .
```

### 4.4 æ—¥å¿—è½®è½¬ä¸æ¸…ç†

#### è‡ªåŠ¨è½®è½¬ï¼ˆæŒ‰å¤§å°ï¼‰

æ—¥å¿—æ–‡ä»¶è¾¾åˆ° 100MB è‡ªåŠ¨è½®è½¬ï¼Œä¿ç•™æœ€è¿‘ 10 ä¸ªæ–‡ä»¶ã€‚

```bash
# PM2 è‡ªåŠ¨è½®è½¬é…ç½®ï¼ˆå·²é…ç½®ï¼‰
# max_size: 100M
# max_files: 10

# Docker è‡ªåŠ¨è½®è½¬é…ç½®ï¼ˆå·²é…ç½®ï¼‰
# max-size: 100m
# max-file: 10
```

#### å®šæœŸæ¸…ç†ï¼ˆæŒ‰æ—¶é—´ï¼‰

è‡ªåŠ¨åˆ é™¤ 3 ä¸ªæœˆå‰çš„æ—¥å¿—æ–‡ä»¶ã€‚

**Linux/macOS ç¯å¢ƒï¼š**

```bash
# 1. è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼ˆæ¯æœˆ 1 å·å‡Œæ™¨ 2:00 æ‰§è¡Œï¼‰
cd /path/to/project
chmod +x scripts/setup-log-cleanup-cron.sh
./scripts/setup-log-cleanup-cron.sh

# 2. æŸ¥çœ‹å®šæ—¶ä»»åŠ¡
crontab -l

# 3. æ‰‹åŠ¨æ‰§è¡Œæ¸…ç†
./scripts/clean-logs.sh

# 4. æŸ¥çœ‹æ¸…ç†æ—¥å¿—
cat backend/logs/cleanup.log
```

**Windows ç¯å¢ƒï¼š**

```powershell
# 1. ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ PowerShell
# 2. è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼ˆæ¯æœˆ 1 å·å‡Œæ™¨ 2:00 æ‰§è¡Œï¼‰
cd C:\path\to\project
.\scripts\setup-log-cleanup-task.ps1

# 3. æŸ¥çœ‹å®šæ—¶ä»»åŠ¡
Get-ScheduledTask -TaskName "GameAI-LogCleanup"

# 4. æ‰‹åŠ¨æ‰§è¡Œæ¸…ç†
powershell -ExecutionPolicy Bypass -File .\scripts\clean-logs.ps1

# 5. æŸ¥çœ‹æ¸…ç†æ—¥å¿—
Get-Content backend\logs\cleanup.log
```

#### æ¸…ç†ç­–ç•¥

| æ“ä½œ | è§¦å‘æ¡ä»¶ | æ‰§è¡Œæ–¹å¼ | è¯´æ˜ |
|------|----------|----------|------|
| æ—¥å¿—è½®è½¬ | æ–‡ä»¶å¤§å° > 100MB | PM2/Docker è‡ªåŠ¨ | åˆ›å»º .log.1, .log.2 ç­‰ |
| æ—¥å¿—å‹ç¼© | æ–‡ä»¶ä¿®æ”¹æ—¶é—´ > 7 å¤© | æ¸…ç†è„šæœ¬è‡ªåŠ¨ | å‹ç¼©ä¸º .log.*.gz |
| æ—¥å¿—åˆ é™¤ | æ–‡ä»¶ä¿®æ”¹æ—¶é—´ > 90 å¤© | æ¸…ç†è„šæœ¬è‡ªåŠ¨ | æ°¸ä¹…åˆ é™¤ |

### 4.5 æ—¥å¿—ç›‘æ§å‘Šè­¦

å»ºè®®ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š

```bash
# 1. æ—¥å¿—ç›®å½•å¤§å°
du -sh backend/logs

# 2. ERROR æ—¥å¿—æ•°é‡ï¼ˆæœ€è¿‘ 1 å°æ—¶ï¼‰
grep '"level":"ERROR"' backend/logs/error.log | grep "$(date -u +%Y-%m-%dT%H)" | wc -l

# 3. æ…¢è¯·æ±‚æ•°é‡ï¼ˆæœ€è¿‘ 1 å°æ—¶ï¼‰
grep '"costMs":[0-9]\{4,\}' backend/logs/access.log | grep "$(date -u +%Y-%m-%dT%H)" | wc -l
```

---

## 5. æ•°æ®åº“æ“ä½œ

### 5.1 è¿›å…¥ PostgreSQL

```bash
docker exec -it game-ai-cs-postgres psql -U postgres -d game_ai_cs
```

### 5.2 æ•°æ®åº“å¤‡ä»½

```bash
docker exec game-ai-cs-postgres pg_dump -U postgres game_ai_cs > backup.sql
```

### 5.3 æ•°æ®åº“æ¢å¤

```bash
cat backup.sql | docker exec -i game-ai-cs-postgres psql -U postgres -d game_ai_cs
```

---

## 6. Redis æ“ä½œ

### 6.1 è¿›å…¥ Redis CLI

```bash
docker exec -it game-ai-cs-redis redis-cli
```

### 6.2 æŸ¥çœ‹ Redis é”®

```bash
docker exec -it game-ai-cs-redis redis-cli KEYS "*"
```

### 6.3 æ¸…ç©º Redis

```bash
docker exec -it game-ai-cs-redis redis-cli FLUSHALL
```

---

## 7. è®¿é—®åœ°å€

### 7.1 åº”ç”¨è®¿é—®

- åç«¯ API: http://localhost:21101/api/v1
- ç®¡ç†ç«¯æ–‡æ¡£: http://localhost:21101/api/v1/docs/admin
- ç©å®¶ç«¯æ–‡æ¡£: http://localhost:21101/api/v1/docs/player
- ç®¡ç†ç«¯å‰ç«¯: http://localhost:20101
- ç©å®¶ç«¯å‰ç«¯: http://localhost:20102

### 7.2 ç›‘æ§è®¿é—®

- Prometheus: http://localhost:23101
- Grafana: http://localhost:23103
- Loki: http://localhost:23102
  - é»˜è®¤ç”¨æˆ·å: `admin`
  - é»˜è®¤å¯†ç : `admin`
- Metrics ç«¯ç‚¹: http://localhost:21101/api/v1/metrics

---

## 8. å¥åº·æ£€æŸ¥

### 8.1 æ£€æŸ¥åç«¯å¥åº·

```bash
curl http://localhost:21101/api/v1/metrics
```

### 8.2 æ£€æŸ¥ Prometheus ç›®æ ‡çŠ¶æ€

è®¿é—®: http://localhost:23101/targets

åº”æ˜¾ç¤º `game-ai-backend` çŠ¶æ€ä¸º `UP`

### 8.3 æ£€æŸ¥ Grafana Dashboard

è®¿é—®: http://localhost:23103/dashboards

åº”çœ‹åˆ° `Game AI Backend - Overview` Dashboard

---

## 9. æ¸…ç†æ•°æ®

### 9.1 æ¸…ç†æ‰€æœ‰å®¹å™¨å’Œæ•°æ®å·

```bash
# åœæ­¢å¹¶åˆ é™¤ä¸»åº”ç”¨å®¹å™¨å’Œæ•°æ®å·
docker-compose down -v

# åœæ­¢å¹¶åˆ é™¤ç›‘æ§å®¹å™¨å’Œæ•°æ®å·
docker-compose -f docker-compose.monitoring.yml down -v
```

### 9.2 æ¸…ç† Docker é•œåƒ

```bash
docker image prune -a
```

---

## 10. æ•…éšœæ’æŸ¥

### 10.1 åç«¯æ— æ³•è¿æ¥æ•°æ®åº“

```bash
# æ£€æŸ¥æ•°æ®åº“å®¹å™¨çŠ¶æ€
docker-compose ps postgres

# æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
docker-compose logs postgres

# é‡å¯æ•°æ®åº“
docker-compose restart postgres
```

### 10.2 Prometheus æ— æ³•æŠ“å–æŒ‡æ ‡

```bash
# æ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨
docker-compose ps backend

# æ£€æŸ¥ metrics ç«¯ç‚¹
curl http://localhost:21101/api/v1/metrics

# æ£€æŸ¥ç½‘ç»œè¿æ¥
docker network inspect game-ai-cs-network
```

### 10.3 Grafana æ— æ•°æ®

```bash
# æ£€æŸ¥ Prometheus æ•°æ®æº
# è®¿é—® Grafana -> Configuration -> Data Sources

# æ£€æŸ¥ Prometheus æ˜¯å¦æœ‰æ•°æ®
# è®¿é—® http://localhost:23101/graph
# æ‰§è¡ŒæŸ¥è¯¢: sum(queue_length)
```

---

## 11. æ›´æ–°éƒ¨ç½²

### 11.1 æ›´æ–°åç«¯ä»£ç 

```bash
# åœæ­¢åç«¯
docker-compose stop backend

# é‡æ–°æ„å»º
docker-compose build backend

# å¯åŠ¨åç«¯
docker-compose up -d backend
```

### 11.2 æ›´æ–°ç›‘æ§é…ç½®

```bash
# ä¿®æ”¹é…ç½®æ–‡ä»¶åé‡å¯
docker-compose -f docker-compose.monitoring.yml restart prometheus
docker-compose -f docker-compose.monitoring.yml restart grafana
```

---

## 12. ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹

### 12.1 ç¯å¢ƒå˜é‡

ç¡®ä¿åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®ï¼š

```bash
# æ•°æ®åº“
DATABASE_URL=postgresql://postgres:postgres@postgres:5432/game_ai_cs

# JWT
JWT_SECRET=your-production-secret-key

# Redis
REDIS_HOST=redis
REDIS_PORT=6379

# å‰ç«¯åœ°å€
FRONTEND_URL=https://your-domain.com
```

### 12.2 æ•°æ®æŒä¹…åŒ–

æ•°æ®å·ä½ç½®ï¼š
- PostgreSQL: `postgres_data`
- Redis: `redis_data`
- Prometheus: `prometheus_data`
- Grafana: `grafana_data`

### 12.3 æ—¥å¿—ç®¡ç†

ç”Ÿäº§ç¯å¢ƒå¿…é¡»é…ç½®ï¼š

```bash
# 1. è®¾ç½®æ—¥å¿—çº§åˆ«
LOG_LEVEL=INFO

# 2. é…ç½®æ—¥å¿—è½®è½¬ï¼ˆå·²è‡ªåŠ¨é…ç½®ï¼‰
# PM2: max_size=100M, max_files=10
# Docker: max-size=100m, max-file=10

# 3. é…ç½®å®šæœŸæ¸…ç†ï¼ˆæ¯æœˆ 1 å·å‡Œæ™¨ 2:00ï¼‰
# Linux/macOS: è¿è¡Œ scripts/setup-log-cleanup-cron.sh
# Windows: è¿è¡Œ scripts/setup-log-cleanup-task.ps1

# 4. ç›‘æ§æ—¥å¿—ç›®å½•å¤§å°
du -sh backend/logs

# 5. å®šæœŸæ£€æŸ¥æ¸…ç†æ—¥å¿—
cat backend/logs/cleanup.log
```

### 12.4 å¤‡ä»½ç­–ç•¥

å»ºè®®å®šæœŸå¤‡ä»½ï¼š
- æ•°æ®åº“ï¼ˆæ¯å¤©ï¼‰
- Redisï¼ˆæ¯å°æ—¶ï¼‰
- Grafana Dashboard é…ç½®ï¼ˆæ¯æ¬¡ä¿®æ”¹åï¼‰
- æ—¥å¿—æ–‡ä»¶ï¼ˆä¿ç•™ 3 ä¸ªæœˆï¼Œè‡ªåŠ¨æ¸…ç†ï¼‰
