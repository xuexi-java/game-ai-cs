## 1. 整体接入流程
```text
玩家
  │
  │ 0. 点击 客服中心
  ▼
游戏客户端
  │
  │ 1. 向游戏服请求客服URL
  ▼
游戏服务器
  │
  │ 2. 按规则拼接客服URL
  ▼
游戏客户端
  │
  │ 3. 根据客服URL,打开对应客服前端
  ▼
客服页面
```
## 2. 核心数据协议  
  
### 2.1 认证接口定义 (游戏客户端向游戏服务器)  
#### 请求参数  
| 字段名      | 类型     | 必填  | 说明        |     |
| :------- | :----- | :-- | :-------- | --- |
| `uid`    | String | 是   | 玩家唯一 ID   |     |
| `areaid` | String | 是   | 玩家所在区服 ID |     |
  
#### 成功响应示例
```json
{
  "success": true,
  "data": {
	  "gameid": "10001",
	  "uid": "player_001",
	  "areaid": "1",
	  "playerName": "测试玩家",
	  "ts": 1737003600000,
	  "nonce": "n7k9m2x4p6q8w3e5",
	  "sign": "981efc6fd37795c635fb038c6b466d6d",
	  "h5Url": "https://cs-web.yourgame.com"
	  }
}  
```  
  
---  
  
### 2.2 认证参数字段说明 (服务器端)
gameid 映射参考：  
- 新弹弹堂: "10001"  
- 弹弹堂大冒险: "10002"  
- 页游弹弹堂: "10003"  
  
| 参数名          | 类型     | 说明         |     |
| :----------- | :----- | :--------- | --- |
| `gameid`     | String | 游戏标识       |     |
| `uid`        | String | 玩家唯一 ID    |     |
| `areaid`     | String | 玩家所在区服     |     |
| `playerName` | String | 玩家昵称       |     |
| `ts`         | Long   | 过期时间戳 (毫秒) |     |
| `nonce`      | String | 固定随机串      |     |
| `sign`       | String | 服务器计算好的签名  |     |
| `h5Url`      | String | 客服前端部署地址   |     |
  
---  
  
### 2.3 URL 拼接规则（游戏客户端）  
当前采用 URL 传参模式（减少 Android 端开发量），游戏客户端需要拼接完整 URL 并打开 WebView。  
  
**最终 URL 拼接示例**：  
`${h5Url}/?gameid=${gameid}&uid=${uid}&areaid=${areaid}&ts=${ts}&nonce=${nonce}&sign=${sign}&playerName=${playerName}&platform=android 
  
**注意事项**：  
- `ts`/`sign` 由游戏服务器生成，客户端不计算，不传 `secret`  
- 必须包含 `gameid/uid/areaid/ts/nonce/sign/playerName`  
- `ts` 有效期 2 小时，过期需重新获取并刷新 URL  
- Android 端不要注入 `AndroidBridge`，否则 H5 会优先走 Bridge 而忽略 URL  
  
---  
  
## 3. 签名计算规则(服务器端)     
*   **算法**：`MD5`
*   **公式**：`sign = md5(gameid|uid|areaid|ts|nonce|secret).toLowerCase()`
*   **注意**：各参数用 `|` 分隔拼接  
计算示例

| 参数     | 值                                |
| ------ | -------------------------------- |
| gameid | 10001                            |
| uid    | player002                        |
| areaid | 1                                |
| ts     | 1737003600000                    |
| nonce  | n7k9m2x4p6q8w3e5                 |
| secret | s3cr3t_k7m9n2p4q6x8w1e5r0t2y4u6  |
| sign   | 8149c825a2f85d7a034cda231f10903d |

---  
  
## 4. 各平台接入示例与权限配置

### 4.1 Android 平台

#### 4.1.1 权限声明 (`AndroidManifest.xml`)
```xml
<!-- 网络权限 -->
<uses-permission android:name="android.permission.INTERNET" />
<!-- 相册权限 (Android 13+) -->
<uses-permission android:name="android.permission.READ_MEDIA_IMAGES" />
```

#### 4.1.2 接入代码 (Kotlin)
```kotlin
class CustomerServiceActivity : AppCompatActivity() {

    private lateinit var webView: WebView
    private var fileChooserCallback: ValueCallback<Array<Uri>>? = null

    companion object {
        private const val FILE_CHOOSER_REQUEST_CODE = 1001

        /**
         * 启动客服页面
         * @param uid 玩家UID
         * @param areaid 区服ID
         */
        fun start(context: Context, uid: String, areaid: String) {
            val intent = Intent(context, CustomerServiceActivity::class.java).apply {
                putExtra("uid", uid)
                putExtra("areaid", areaid)
            }
            context.startActivity(intent)
        }
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        val uid = intent.getStringExtra("uid") ?: return finish()
        val areaid = intent.getStringExtra("areaid") ?: return finish()

        // 1. 向游戏服务器请求签名参数
        requestSignedParams(uid, areaid)
    }

    /**
     * 步骤1: 向游戏服务器请求签名参数
     */
    private fun requestSignedParams(uid: String, areaid: String) {
        // 替换为你的游戏服务器接口
        val url = "https://your-game-server.com/api/getCustomerServiceUrl"

        // 使用 OkHttp / Retrofit 等网络库发起请求
        val request = Request.Builder()
            .url(url)
            .post(FormBody.Builder()
                .add("uid", uid)
                .add("areaid", areaid)
                .build())
            .build()

        OkHttpClient().newCall(request).enqueue(object : Callback {
            override fun onFailure(call: Call, e: IOException) {
                runOnUiThread {
                    Toast.makeText(this@CustomerServiceActivity, "网络错误", Toast.LENGTH_SHORT).show()
                    finish()
                }
            }

            override fun onResponse(call: Call, response: Response) {
                val json = response.body?.string() ?: return
                val result = Gson().fromJson(json, SignedParamsResponse::class.java)

                if (result.success && result.data != null) {
                    runOnUiThread {
                        // 2. 设置 WebView 并加载客服页面
                        setupWebView()
                        loadCustomerServiceUrl(result.data)
                    }
                } else {
                    runOnUiThread {
                        Toast.makeText(this@CustomerServiceActivity, "获取客服地址失败", Toast.LENGTH_SHORT).show()
                        finish()
                    }
                }
            }
        })
    }

    /**
     * 步骤2: 配置 WebView
     */
    private fun setupWebView() {
        webView = WebView(this).apply {
            layoutParams = ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT)
        }
        setContentView(webView)

        webView.settings.apply {
            javaScriptEnabled = true
            domStorageEnabled = true
            allowFileAccess = true
            mixedContentMode = WebSettings.MIXED_CONTENT_ALWAYS_ALLOW
        }

        // 注入 Bridge (仅用于关闭页面)
        webView.addJavascriptInterface(object {
            @JavascriptInterface
            fun close() = runOnUiThread { finish() }
        }, "AndroidBridge")

        // 处理文件选择 (图片上传)
        webView.webChromeClient = object : WebChromeClient() {
            override fun onShowFileChooser(
                webView: WebView?,
                callback: ValueCallback<Array<Uri>>?,
                params: FileChooserParams?
            ): Boolean {
                fileChooserCallback?.onReceiveValue(null)
                fileChooserCallback = callback
                startActivityForResult(
                    Intent(Intent.ACTION_PICK).apply { type = "image/*" },
                    FILE_CHOOSER_REQUEST_CODE
                )
                return true
            }
        }
    }

    /**
     * 步骤3: 拼接 URL 并加载
     */
    private fun loadCustomerServiceUrl(params: SignedParams) {
        val url = buildString {
            append(params.h5Url)
            append("/?gameid=${params.gameid}")
            append("&uid=${params.uid}")
            append("&areaid=${params.areaid}")
            append("&ts=${params.ts}")
            append("&nonce=${params.nonce}")
            append("&sign=${params.sign}")
            append("&playerName=${URLEncoder.encode(params.playerName, "UTF-8")}")
            append("&platform=android")
        }
        webView.loadUrl(url)
    }

    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
        super.onActivityResult(requestCode, resultCode, data)
        if (requestCode == FILE_CHOOSER_REQUEST_CODE) {
            // 重要：无论成功与否都必须回调，否则 WebView 会锁死
            fileChooserCallback?.onReceiveValue(
                if (resultCode == RESULT_OK) data?.data?.let { arrayOf(it) } else null
            )
            fileChooserCallback = null
        }
    }

    override fun onBackPressed() {
        if (webView.canGoBack()) webView.goBack() else super.onBackPressed()
    }

    override fun onDestroy() {
        webView.destroy()
        super.onDestroy()
    }
}

// 游戏服务器响应数据类
data class SignedParamsResponse(val success: Boolean, val data: SignedParams?)
data class SignedParams(
    val h5Url: String,
    val gameid: String,
    val uid: String,
    val areaid: String,
    val playerName: String,
    val ts: Long,
    val nonce: String,
    val sign: String
)
```

#### 4.1.3 调用示例
```kotlin
// 玩家点击"客服中心"按钮时
btnCustomerService.setOnClickListener {
    CustomerServiceActivity.start(this, uid = "player_001", areaid = "1")
}
```

---

### 4.2 iOS 平台

#### 4.2.1 权限声明 (`Info.plist`)
```xml
<!-- 相册访问权限 -->
<key>NSPhotoLibraryUsageDescription</key>
<string>我们需要访问您的相册以提供截图上传功能</string>
```

#### 4.2.2 接入代码 (Swift)
```swift
import UIKit
import WebKit

class CustomerServiceViewController: UIViewController {

    private var webView: WKWebView!
    private var imagePickerCompletion: (([URL]?) -> Void)?

    // 玩家信息 (由外部传入)
    var uid: String = ""
    var areaid: String = ""

    override func viewDidLoad() {
        super.viewDidLoad()
        // 1. 向游戏服务器请求签名参数
        requestSignedParams()
    }

    // MARK: - 步骤1: 请求签名参数
    private func requestSignedParams() {
        guard let url = URL(string: "https://your-game-server.com/api/getCustomerServiceUrl") else { return }

        var request = URLRequest(url: url)
        request.httpMethod = "POST"
        request.setValue("application/json", forHTTPHeaderField: "Content-Type")
        request.httpBody = try? JSONSerialization.data(withJSONObject: ["uid": uid, "areaid": areaid])

        URLSession.shared.dataTask(with: request) { [weak self] data, _, error in
            guard let self = self, let data = data, error == nil else {
                DispatchQueue.main.async { self?.showErrorAndClose("网络错误") }
                return
            }

            do {
                let response = try JSONDecoder().decode(SignedParamsResponse.self, from: data)
                if response.success, let params = response.data {
                    DispatchQueue.main.async {
                        // 2. 设置 WebView 并加载
                        self.setupWebView()
                        self.loadCustomerServiceUrl(params: params)
                    }
                } else {
                    DispatchQueue.main.async { self.showErrorAndClose("获取客服地址失败") }
                }
            } catch {
                DispatchQueue.main.async { self.showErrorAndClose("数据解析失败") }
            }
        }.resume()
    }

    // MARK: - 步骤2: 配置 WebView
    private func setupWebView() {
        let config = WKWebViewConfiguration()
        let userContentController = WKUserContentController()

        // 注册 Bridge (仅用于关闭页面)
        userContentController.add(self, name: "iosBridge")
        config.userContentController = userContentController
        config.allowsInlineMediaPlayback = true

        webView = WKWebView(frame: view.bounds, configuration: config)
        webView.autoresizingMask = [.flexibleWidth, .flexibleHeight]
        webView.uiDelegate = self
        view.addSubview(webView)
    }

    // MARK: - 步骤3: 拼接 URL 并加载
    private func loadCustomerServiceUrl(params: SignedParams) {
        var components = URLComponents(string: params.h5Url)!
        components.queryItems = [
            URLQueryItem(name: "gameid", value: params.gameid),
            URLQueryItem(name: "uid", value: params.uid),
            URLQueryItem(name: "areaid", value: params.areaid),
            URLQueryItem(name: "ts", value: String(params.ts)),
            URLQueryItem(name: "nonce", value: params.nonce),
            URLQueryItem(name: "sign", value: params.sign),
            URLQueryItem(name: "playerName", value: params.playerName),
            URLQueryItem(name: "platform", value: "ios")
        ]
        if let url = components.url {
            webView.load(URLRequest(url: url))
        }
    }

    private func showErrorAndClose(_ message: String) {
        let alert = UIAlertController(title: "提示", message: message, preferredStyle: .alert)
        alert.addAction(UIAlertAction(title: "确定", style: .default) { _ in self.closeVC() })
        present(alert, animated: true)
    }

    private func closeVC() {
        if let nav = navigationController { nav.popViewController(animated: true) }
        else { dismiss(animated: true) }
    }

    deinit {
        webView?.configuration.userContentController.removeScriptMessageHandler(forName: "iosBridge")
    }
}

// MARK: - Bridge 处理 (仅关闭)
extension CustomerServiceViewController: WKScriptMessageHandler {
    func userContentController(_ userContentController: WKUserContentController, didReceive message: WKScriptMessage) {
        guard message.name == "iosBridge",
              let body = message.body as? [String: Any],
              let action = body["action"] as? String,
              action == "close" else { return }
        closeVC()
    }
}

// MARK: - 文件选择 (图片上传)
extension CustomerServiceViewController: WKUIDelegate, UIImagePickerControllerDelegate, UINavigationControllerDelegate {
    func webView(_ webView: WKWebView, runOpenPanelWith parameters: WKOpenPanelParameters,
                 initiatedByFrame frame: WKFrameInfo, completionHandler: @escaping ([URL]?) -> Void) {
        imagePickerCompletion = completionHandler
        let picker = UIImagePickerController()
        picker.sourceType = .photoLibrary
        picker.delegate = self
        present(picker, animated: true)
    }

    func imagePickerController(_ picker: UIImagePickerController, didFinishPickingMediaWithInfo info: [UIImagePickerController.InfoKey: Any]) {
        picker.dismiss(animated: true) {
            self.imagePickerCompletion?(info[.imageURL] as? URL != nil ? [info[.imageURL] as! URL] : nil)
            self.imagePickerCompletion = nil
        }
    }

    func imagePickerControllerDidCancel(_ picker: UIImagePickerController) {
        picker.dismiss(animated: true) {
            self.imagePickerCompletion?(nil)
            self.imagePickerCompletion = nil
        }
    }
}

// MARK: - 数据模型
struct SignedParamsResponse: Codable {
    let success: Bool
    let data: SignedParams?
}

struct SignedParams: Codable {
    let h5Url: String
    let gameid: String
    let uid: String
    let areaid: String
    let playerName: String
    let ts: Int64
    let nonce: String
    let sign: String
}
```

#### 4.2.3 调用示例
```swift
// 玩家点击"客服中心"按钮时
@IBAction func onCustomerServiceTap(_ sender: Any) {
    let vc = CustomerServiceViewController()
    vc.uid = "player_001"
    vc.areaid = "1"
    present(vc, animated: true)
}
```

---

### 4.3 Flash / 网页平台 (Iframe 嵌入)

#### 4.3.1 接入代码
```html
<!DOCTYPE html>
<html>
<head>
    <title>客服中心</title>
    <style>
        .cs-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; }
        .cs-modal.active { display:flex; justify-content:center; align-items:center; }
        .cs-container { width:800px; height:600px; background:#fff; border-radius:8px; overflow:hidden; }
        .cs-iframe { width:100%; height:100%; border:none; }
    </style>
</head>
<body>
    <div id="cs_modal" class="cs-modal">
        <div class="cs-container">
            <iframe id="cs_frame" class="cs-iframe"></iframe>
        </div>
    </div>

    <script>
    const CustomerService = {
        init() {
            // 监听 H5 关闭消息
            window.addEventListener('message', (e) => {
                if (e.data?.type === 'cs-close') this.close();
            });
        },

        /**
         * 打开客服 (需先请求游戏服务器获取签名参数)
         */
        async open(uid, areaid) {
            // 1. 向游戏服务器请求签名参数
            const res = await fetch('/api/getCustomerServiceUrl', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ uid, areaid })
            });
            const { success, data } = await res.json();

            if (!success) {
                alert('获取客服地址失败');
                return;
            }

            // 2. 拼接 URL 并打开
            const params = new URLSearchParams({
                gameid: data.gameid, uid: data.uid, areaid: data.areaid,
                ts: data.ts, nonce: data.nonce, sign: data.sign,
                playerName: data.playerName,
                platform: 'iframe'
            });
            document.getElementById('cs_frame').src = `${data.h5Url}/?${params}`;
            document.getElementById('cs_modal').classList.add('active');
        },

        close() {
            document.getElementById('cs_modal').classList.remove('active');
            document.getElementById('cs_frame').src = 'about:blank';
        }
    };

    CustomerService.init();
    </script>
</body>
</html>
```

#### 4.3.2 调用示例
```javascript
// 玩家点击"客服中心"按钮时
document.getElementById('btnCS').onclick = () => {
    CustomerService.open('player_001', '1');
};
```

#### 4.3.3 消息交互
H5 通过 `postMessage` 发送关闭消息：`{ type: 'cs-close' }`

---

### 4.4 微信小程序

#### 4.4.1 域名配置
在微信公众平台 → 开发管理 → 业务域名中添加客服前端域名。

#### 4.4.2 接入代码

**WXML**
```html
<web-view wx:if="{{csUrl}}" src="{{csUrl}}" bindmessage="onMessage"></web-view>
<view wx:else class="loading">正在加载...</view>
```

**JS**
```javascript
Page({
    data: { csUrl: '' },

    onLoad(options) {
        this.loadCustomerServiceUrl(options.uid, options.areaid);
    },

    // 向游戏服务器请求签名参数
    async loadCustomerServiceUrl(uid, areaid) {
        try {
            const res = await new Promise((resolve, reject) => {
                wx.request({
                    url: 'https://your-game-server.com/api/getCustomerServiceUrl',
                    method: 'POST',
                    data: { uid, areaid },
                    success: resolve,
                    fail: reject
                });
            });

            if (res.data.success) {
                const p = res.data.data;
                const url = `${p.h5Url}/?gameid=${p.gameid}&uid=${p.uid}&areaid=${p.areaid}` +
                    `&ts=${p.ts}&nonce=${p.nonce}&sign=${p.sign}` +
                    `&playerName=${encodeURIComponent(p.playerName)}&platform=wxapp`;
                this.setData({ csUrl: url });
            } else {
                wx.showToast({ title: '加载失败', icon: 'error' });
                setTimeout(() => wx.navigateBack(), 1500);
            }
        } catch (e) {
            wx.showToast({ title: '网络错误', icon: 'error' });
        }
    },

    onMessage(e) {
        if (e.detail.data?.[0] === 'close') wx.navigateBack();
    }
});
```

#### 4.4.3 调用示例
```javascript
// 跳转到客服页面
wx.navigateTo({
    url: '/pages/customer-service/index?uid=player_001&areaid=1'
});
```
