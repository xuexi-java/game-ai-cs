## 1. 整体接入流程

```text
玩家
  │
  │ 0. 点击 客服中心
  ▼
游戏客户端
  │
  │ 1. 向游戏服请求客服URL
  ▼
游戏服务器
  │
  │ 2. 按规则拼接客服URL
  ▼
游戏客户端
  │
  │ 3. 根据客服URL,打开对应客服前端
  ▼
客服页面
```

## 2. 核心数据协议

### 2.1 认证接口定义 (游戏客户端向游戏服务器)

#### 请求参数

| 字段名     | 类型   | 必填 | 说明            |  |
| :--------- | :----- | :--- | :-------------- | - |
| `uid`    | String | 是   | 玩家唯一 ID     |  |
| `areaid` | String | 是   | 玩家所在区服 ID |  |

#### 成功响应示例

```json
{
  "success": true,
  "data": {
	  "gameid": "10001",
	  "uid": "player_001",
	  "areaid": "1",
	  "playerName": "测试玩家",
	  "ts": 1737003600000,
	  "nonce": "n7k9m2x4p6q8w3e5",
	  "sign": "981efc6fd37795c635fb038c6b466d6d",
	  "h5Url": "https://cs-web.yourgame.com"
	  }
}  
```

---

### 2.2 认证参数字段说明 (服务器端)

gameid 映射参考：

- 新弹弹堂: "10001"
- 弹弹堂大冒险: "10002"
- 页游弹弹堂: "10003"

| 参数名          | 类型     | 说明                                      |     |
| :----------- | :----- | :-------------------------------------- | --- |
| `gameid`     | String | 游戏标识                                    |     |
| `uid`        | String | 玩家唯一 ID                                 |     |
| `areaid`     | String | 玩家所在区服                                  |     |
| `playerName` | String | 玩家昵称                                    |     |
| `ts`         | Long   | 生成签名的时间戳 (毫秒)                           |     |
| `nonce`      | String | 固定随机串                                   |     |
| `sign`       | String | 服务器计算好的签名                               |     |
| `h5Url`      | String | 客服前端部署地址                                |     |
| platform     | String | 来自什么端(如:Android\H5\iOS\mini_wx\mini_dy) |     |

---
### 2.3 URL 拼接规则（游戏客户端）

当前使用URL 传参模式，游戏客户端需要拼接完整 URL 并打开 WebView。
**最终 URL 拼接示例**：
`{h5Url}[/]?gameid={gameid}&uid={uid}&areaid={areaid}&ts={ts}&nonce={nonce}&sign={sign}&playerName={PlayerName}&platform=android`
示例:
`http://localhost:5173/?gameid=10001&uid=player002&areaid=1&playerName=Test+Player&ts=1737003600000&nonce=n7k9m2x4p6q8w3e5&sign=8149c825a2f85d7a034cda231f10903d&apiUrl=http%3A%2F%2Flocalhost%3A21101&platform=web`

---
## 3. 签名计算规则(服务器端)

* **算法**：`MD5`
* **公式**：`sign = md5(gameid|uid|areaid|ts|nonce|secret).toLowerCase()`
* 例:
* `sign = md5(10001 + "|" + player002+ "|" + 1 + "|" + 1737003600000 + "|" +"n7k9m2x4p6q8w3e5"+ "|" + "s3cr3t_k7m9n2p4q6x8w1e5r0t2y4u6").toLowerCase()`
* sign = "8149c825a2f85d7a034cda231f10903d"
* 使用  |  进行分割
---
## 4. 各平台接入示例

### 4.1 Android 平台

#### 4.1.1 权限声明 (`AndroidManifest.xml`)

```xml
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.READ_MEDIA_IMAGES" /> <!-- 图片上传需要 -->
```
#### 4.1.2 核心接入代码 (Kotlin)

**入口调用（玩家点击客服按钮时触发）**

```kotlin
// 保存当前玩家的签名参数，供 JS Bridge 使用
private var currentParams: SignedParams? = null


fun openCustomerService(uid: String, areaid: String) {
    // 向游戏服务器请求签名参数 (参考)
    requestSignedParams(uid, areaid)
}

private fun requestSignedParams(uid: String, areaid: String) {
    lifecycleScope.launch {
        try {
            val params = YourGameApi.getCustomerServiceAuth(uid, areaid)
            if (params != null) {
                currentParams = params  // 保存参数，供 JS Bridge 的 getPlayerInfo() 使用
                setupWebView() //如果没配置WebView则需要配置
                loadCustomerServiceUrl(params)  // 加载 H5 客服页面
            } else {
                Toast.makeText(this@Activity, "获取客服参数失败", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            Toast.makeText(this@Activity, "网络请求失败: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }
}
```
**WebView 配置**

```kotlin
@SuppressLint("SetJavaScriptEnabled")
private fun setupWebView() {
    webView.settings.apply {
        javaScriptEnabled = true                                  // 必须：H5 需要 JavaScript
        domStorageEnabled = true                                  // 必须：H5 使用 localStorage
        allowFileAccess = true                                    // 图片上传需要文件访问权限
        mixedContentMode = WebSettings.MIXED_CONTENT_ALWAYS_ALLOW // 允许 HTTPS 加载 HTTP 资源
    }
    // 注册 JS Bridge，名称必须是 "roadWebViewService"，H5 通过此名称调用原生方法
    webView.addJavascriptInterface(CustomerServiceBridge(), "roadWebViewService")
}
@Keep // 防止混淆
inner class CustomerServiceBridge {
    @JavascriptInterface
    fun close() = runOnUiThread { finish() }  // H5 调用 roadWebViewService.close() 关闭页面
    @JavascriptInterface
    fun getPlayerInfo(): String = currentParams?.let { Gson().toJson(it) } ?: "{}"  // H5 调用获取玩家信息
}
```

**URL 拼接与加载**

```kotlin
private fun loadCustomerServiceUrl(params: SignedParams) {
    val url = Uri.parse(params.h5Url).buildUpon().apply {
        appendQueryParameter("gameid", params.gameid)
        appendQueryParameter("uid", params.uid)
        appendQueryParameter("areaid", params.areaid)
        appendQueryParameter("ts", params.ts.toString())
        appendQueryParameter("nonce", params.nonce)
        appendQueryParameter("sign", params.sign)
        appendQueryParameter("playerName", params.playerName) // 自动处理 URL 编码
        appendQueryParameter("platform", "android")
    }.build().toString()
    webView.loadUrl(url)
}
```

**图片上传支持**

```kotlin
// 保存 H5 文件选择器的回调引用
private var fileChooserCallback: ValueCallback<Array<Uri>>? = null

private val pickImageLauncher = registerForActivityResult(
    ActivityResultContracts.StartActivityForResult()
) { result ->
    // 图片选择完成后的回调处理
    val uri = if (result.resultCode == RESULT_OK) {
        result.data?.data?.let { arrayOf(it) }  // 用户选择了图片，包装成数组
    } else {
        null  
    }
    fileChooserCallback?.onReceiveValue(uri)  // 将结果返回给 H5
    fileChooserCallback = null                
}

webView.webChromeClient = object : WebChromeClient() {
    // 当 H5 触发 <input type="file"> 时，系统会调用此方法
    override fun onShowFileChooser(
        webView: WebView?,
        callback: ValueCallback<Array<Uri>>?,
        params: FileChooserParams?
    ): Boolean {
        fileChooserCallback?.onReceiveValue(null)  
        fileChooserCallback = callback             // 保存当前回调
        // 启动系统图片选择器
        pickImageLauncher.launch(Intent(Intent.ACTION_PICK).apply { type = "image/*" })
        return true  // 返回 true 表示已处理该请求
    }
}
```
#### 4.1.3 数据类定义

```kotlin
data class SignedParams(
    val h5Url: String,
    val gameid: String,
    val uid: String,
    val areaid: String,
    val playerName: String,
    val ts: Long,
    val nonce: String,
    val sign: String
)
```
---
### 4.2 Flash / H5 (Iframe 嵌入)

#### 4.2.1 接入代码

```html
<head>
    <script src="./customer-service.js"></script>
</head>
<body>
    <!-- 打开客服按钮 -->
    <button onclick="openCS()">打开客服</button>
    <script>
        function openCS() {
            CustomerService.open(
                'player001',                              // 玩家UID
                '1',                                      // 区服ID
                'http://localhost:3001/api/get-cs-auth' // 游戏服务器签名接口
            );
        }
    </script>
</body>
```
---
### 4.2 iOS 平台
### 4.4 微信小程序

### 4.5抖音小游戏
