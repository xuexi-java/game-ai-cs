# AI 客服系统 - 数据库设计文档

## 文档信息

- **文档版本**: V1.0
- **项目代号**: game-ai-cs
- **数据库类型**: PostgreSQL
- **ORM**: Prisma
- **最后更新**: 2024

## 1. 数据库概述

本系统采用 PostgreSQL 作为主数据库，使用 Prisma ORM 进行数据访问。数据库设计遵循以下原则：

- **规范化设计**: 遵循第三范式，减少数据冗余
- **索引优化**: 为常用查询字段建立索引
- **软删除**: 关键业务数据使用软删除机制
- **审计字段**: 所有表包含创建时间、更新时间等审计字段

## 2. 数据表设计

### 2.1. 游戏配置表 (Game)

存储游戏基本信息和 Dify API 配置。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | String | PK, UUID | 游戏ID（唯一标识） |
| name | String | NOT NULL, UNIQUE | 游戏名称 |
| icon | String? | NULL | 游戏图标URL |
| enabled | Boolean | NOT NULL, DEFAULT true | 启用状态 |
| difyApiKey | String | NOT NULL | Dify API Key（加密存储） |
| difyBaseUrl | String | NOT NULL | Dify Base URL |
| createdAt | DateTime | NOT NULL | 创建时间 |
| updatedAt | DateTime | NOT NULL | 更新时间 |
| deletedAt | DateTime? | NULL | 软删除时间 |

**索引**:
- `idx_game_enabled`: (enabled) WHERE enabled = true
- `idx_game_name`: (name)

**关系**:
- 一对多: Game -> Ticket
- 一对多: Game -> Server

---

### 2.2. 区服表 (Server)

存储游戏的区服信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | String | PK, UUID | 区服ID |
| gameId | String | FK, NOT NULL | 所属游戏ID |
| name | String | NOT NULL | 区服名称 |
| enabled | Boolean | NOT NULL, DEFAULT true | 启用状态 |
| createdAt | DateTime | NOT NULL | 创建时间 |
| updatedAt | DateTime | NOT NULL | 更新时间 |
| deletedAt | DateTime? | NULL | 软删除时间 |

**索引**:
- `idx_server_gameId`: (gameId)
- `idx_server_gameId_enabled`: (gameId, enabled) WHERE enabled = true

**关系**:
- 多对一: Server -> Game
- 一对多: Server -> Ticket

---

### 2.3. 工单表 (Ticket)

存储玩家提交的工单信息，是系统的核心业务表。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | String | PK, UUID | 工单ID |
| ticketNo | String | NOT NULL, UNIQUE | 工单编号（如：T-20240101-001） |
| gameId | String | FK, NOT NULL | 游戏ID |
| serverId | String? | FK, NULL | 区服ID（可为空，支持玩家输入） |
| serverName | String? | NULL | 区服名称（玩家输入的区服） |
| playerIdOrName | String | NOT NULL | 玩家角色ID或昵称 |
| description | String | NOT NULL | 问题描述 |
| occurredAt | DateTime? | NULL | 问题发生时间 |
| paymentOrderNo | String? | NULL | 充值订单号 |
| identityStatus | Enum | NOT NULL, DEFAULT NOT_VERIFIED | 身份验证状态 |
| status | Enum | NOT NULL, DEFAULT NEW | 工单状态 |
| priority | Enum | NOT NULL, DEFAULT NORMAL | 优先级 |
| token | String | NOT NULL, UNIQUE | 访问令牌（用于玩家端访问） |
| createdAt | DateTime | NOT NULL | 创建时间 |
| updatedAt | DateTime | NOT NULL | 更新时间 |
| closedAt | DateTime? | NULL | 关闭时间 |
| deletedAt | DateTime? | NULL | 软删除时间 |

**枚举类型**:

```prisma
enum IdentityStatus {
  NOT_VERIFIED      // 未验证
  VERIFIED_PAYMENT  // 已验证（通过充值订单）
}

enum TicketStatus {
  NEW           // 新建
  IN_PROGRESS   // 处理中
  WAITING       // 等待回复
  RESOLVED      // 已解决
  CLOSED        // 已关闭
}

enum Priority {
  LOW      // 低
  NORMAL   // 普通
  HIGH     // 高
  URGENT   // 紧急
}
```

**索引**:
- `idx_ticket_ticketNo`: (ticketNo)
- `idx_ticket_gameId_playerId`: (gameId, playerIdOrName)
- `idx_ticket_status`: (status)
- `idx_ticket_priority`: (priority)
- `idx_ticket_createdAt`: (createdAt)
- `idx_ticket_token`: (token)

**关系**:
- 多对一: Ticket -> Game
- 多对一: Ticket -> Server (可选)
- 一对多: Ticket -> TicketAttachment
- 一对多: Ticket -> Session
- 一对多: Ticket -> TicketMessage

---

### 2.4. 工单附件表 (TicketAttachment)

存储工单相关的截图等附件。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | String | PK, UUID | 附件ID |
| ticketId | String | FK, NOT NULL | 所属工单ID |
| fileUrl | String | NOT NULL | 文件URL |
| fileName | String | NOT NULL | 文件名称 |
| fileType | String | NOT NULL | 文件类型（image/jpeg, image/png等） |
| fileSize | Int | NOT NULL | 文件大小（字节） |
| sortOrder | Int | NOT NULL, DEFAULT 0 | 排序顺序 |
| createdAt | DateTime | NOT NULL | 创建时间 |

**索引**:
- `idx_attachment_ticketId`: (ticketId)

**关系**:
- 多对一: TicketAttachment -> Ticket

---

### 2.5. 会话表 (Session)

存储玩家与客服/AI的会话信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | String | PK, UUID | 会话ID |
| ticketId | String | FK, NOT NULL | 所属工单ID |
| agentId | String? | FK, NULL | 分配的客服ID（NULL表示AI会话） |
| status | Enum | NOT NULL, DEFAULT PENDING | 会话状态 |
| detectedIntent | String? | NULL | AI识别的意图 |
| aiUrgency | Enum? | NULL | AI判断的紧急性 |
| playerUrgency | Enum? | NULL | 玩家确认的紧急性 |
| priorityScore | Int | NOT NULL, DEFAULT 0 | 优先级分数（用于排队排序） |
| queuedAt | DateTime? | NULL | 进入队列时间 |
| startedAt | DateTime? | NULL | 会话开始时间 |
| closedAt | DateTime? | NULL | 会话结束时间 |
| createdAt | DateTime | NOT NULL | 创建时间 |
| updatedAt | DateTime | NOT NULL | 更新时间 |

**枚举类型**:

```prisma
enum SessionStatus {
  PENDING      // 待处理（AI引导中）
  QUEUED       // 排队中
  IN_PROGRESS  // 进行中（客服已接入）
  CLOSED       // 已关闭
}

enum Urgency {
  URGENT     // 紧急
  NON_URGENT // 不紧急
}
```

**索引**:
- `idx_session_ticketId`: (ticketId)
- `idx_session_agentId`: (agentId)
- `idx_session_status`: (status)
- `idx_session_queuedAt`: (queuedAt)
- `idx_session_priorityScore`: (priorityScore DESC, queuedAt ASC) // 用于排队排序

**关系**:
- 多对一: Session -> Ticket
- 多对一: Session -> Agent (可选)
- 一对多: Session -> Message
- 一对多: Session -> SatisfactionRating

---

### 2.6. 消息表 (Message)

存储会话中的所有消息（玩家、AI、客服的消息）。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | String | PK, UUID | 消息ID |
| sessionId | String | FK, NOT NULL | 所属会话ID |
| senderType | Enum | NOT NULL | 发送者类型 |
| senderId | String? | NULL | 发送者ID（AI消息为NULL） |
| content | String | NOT NULL | 消息内容 |
| messageType | Enum | NOT NULL, DEFAULT TEXT | 消息类型 |
| metadata | Json? | NULL | 扩展元数据（JSON格式） |
| createdAt | DateTime | NOT NULL | 创建时间 |

**枚举类型**:

```prisma
enum SenderType {
  PLAYER  // 玩家
  AI      // AI
  AGENT   // 客服
  SYSTEM  // 系统
}

enum MessageType {
  TEXT           // 文本
  IMAGE          // 图片
  SYSTEM_NOTICE  // 系统通知
  QUICK_OPTION   // 快捷选项
}
```

**索引**:
- `idx_message_sessionId`: (sessionId)
- `idx_message_createdAt`: (createdAt)
- `idx_message_sessionId_createdAt`: (sessionId, createdAt)

**关系**:
- 多对一: Message -> Session
- 多对一: Message -> Agent (可选，当senderType为AGENT时)

---

### 2.7. 用户表 (User)

存储管理员和客服的用户信息。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | String | PK, UUID | 用户ID |
| username | String | NOT NULL, UNIQUE | 用户名 |
| password | String | NOT NULL | 密码（BCrypt加密） |
| role | Enum | NOT NULL | 角色 |
| realName | String? | NULL | 真实姓名 |
| email | String? | NULL | 邮箱 |
| phone | String? | NULL | 手机号 |
| avatar | String? | NULL | 头像URL |
| isOnline | Boolean | NOT NULL, DEFAULT false | 是否在线 |
| lastLoginAt | DateTime? | NULL | 最后登录时间 |
| createdAt | DateTime | NOT NULL | 创建时间 |
| updatedAt | DateTime | NOT NULL | 更新时间 |
| deletedAt | DateTime? | NULL | 软删除时间 |

**枚举类型**:

```prisma
enum UserRole {
  ADMIN  // 管理员
  AGENT  // 客服
}
```

**索引**:
- `idx_user_username`: (username)
- `idx_user_role`: (role)
- `idx_user_isOnline`: (isOnline) WHERE isOnline = true

**关系**:
- 一对多: User -> Session (当role为AGENT时)
- 一对多: User -> Message (当role为AGENT时)

---

### 2.8. 紧急排序规则表 (UrgencyRule)

存储管理员配置的紧急排序规则。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | String | PK, UUID | 规则ID |
| name | String | NOT NULL | 规则名称 |
| enabled | Boolean | NOT NULL, DEFAULT true | 是否启用 |
| priorityWeight | Int | NOT NULL | 优先级权重（1-100） |
| description | String? | NULL | 规则描述 |
| conditions | Json | NOT NULL | 匹配条件（JSON格式） |
| createdAt | DateTime | NOT NULL | 创建时间 |
| updatedAt | DateTime | NOT NULL | 更新时间 |
| deletedAt | DateTime? | NULL | 软删除时间 |

**conditions JSON 结构示例**:

```json
{
  "keywords": ["充值", "支付"],
  "intent": "payment_issue",
  "identityStatus": "VERIFIED_PAYMENT",
  "gameId": "dandan-tang-1",
  "serverId": "server-001",
  "priority": "URGENT"
}
```

**索引**:
- `idx_rule_enabled`: (enabled) WHERE enabled = true
- `idx_rule_priorityWeight`: (priorityWeight DESC)

**关系**:
- 无直接关系（通过JSON条件匹配Ticket和Session）

---

### 2.9. 满意度评价表 (SatisfactionRating)

存储玩家对客服服务的满意度评价。

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | String | PK, UUID | 评价ID |
| sessionId | String | FK, NOT NULL | 所属会话ID |
| ticketId | String | FK, NOT NULL | 所属工单ID |
| agentId | String? | FK, NULL | 被评价的客服ID |
| rating | Int | NOT NULL | 评分（1-5星） |
| tags | String[] | NOT NULL, DEFAULT [] | 评价标签数组 |
| comment | String? | NULL | 文字评价 |
| createdAt | DateTime | NOT NULL | 创建时间 |

**索引**:
- `idx_rating_sessionId`: (sessionId)
- `idx_rating_ticketId`: (ticketId)
- `idx_rating_agentId`: (agentId)
- `idx_rating_rating`: (rating)

**关系**:
- 多对一: SatisfactionRating -> Session
- 多对一: SatisfactionRating -> Ticket
- 多对一: SatisfactionRating -> User (可选)

---

## 3. 数据库关系图

```
Game (游戏)
  ├── Server (区服) [1:N]
  └── Ticket (工单) [1:N]

Ticket (工单)
  ├── TicketAttachment (附件) [1:N]
  ├── Session (会话) [1:N]
  └── TicketMessage (工单消息) [1:N]

Session (会话)
  ├── Message (消息) [1:N]
  ├── SatisfactionRating (满意度评价) [1:1]
  └── Agent (客服) [N:1]

User (用户)
  ├── Session (会话) [1:N, role=AGENT]
  └── Message (消息) [1:N, senderType=AGENT]

UrgencyRule (紧急排序规则)
  └── (通过JSON条件匹配Ticket和Session)
```

## 4. 数据库初始化脚本

### 4.1. 创建初始管理员账户

```sql
-- 密码: admin123 (需要在实际使用时修改)
INSERT INTO "User" (id, username, password, role, "realName", "createdAt", "updatedAt")
VALUES (
  gen_random_uuid(),
  'admin',
  '$2b$10$YourHashedPasswordHere', -- BCrypt hash
  'ADMIN',
  '系统管理员',
  NOW(),
  NOW()
);
```

### 4.2. 创建示例游戏配置

```sql
-- 示例：弹弹堂游戏
INSERT INTO "Game" (id, name, "difyApiKey", "difyBaseUrl", enabled, "createdAt", "updatedAt")
VALUES (
  gen_random_uuid(),
  '弹弹堂',
  'your-dify-api-key',
  'https://api.dify.ai/v1',
  true,
  NOW(),
  NOW()
);
```

## 5. 数据迁移策略

### 5.1. 版本控制

使用 Prisma Migrate 进行数据库版本控制：

```bash
# 创建迁移
npx prisma migrate dev --name init

# 应用迁移
npx prisma migrate deploy
```

### 5.2. 数据备份

- **定期备份**: 每天自动备份数据库
- **备份策略**: 保留最近30天的备份
- **恢复测试**: 每月进行一次恢复测试

## 6. 性能优化建议

### 6.1. 索引优化

- 为常用查询字段建立索引
- 定期分析慢查询，优化索引策略
- 使用复合索引优化多条件查询

### 6.2. 查询优化

- 使用分页查询，避免一次性加载大量数据
- 使用 JOIN 替代多次查询
- 对大数据量表使用分区策略

### 6.3. 缓存策略

- 游戏配置信息缓存（Redis）
- 在线客服列表缓存
- 紧急排序规则缓存

## 7. 安全考虑

### 7.1. 数据加密

- 密码使用 BCrypt 加密存储
- Dify API Key 使用 AES 加密存储
- 敏感数据传输使用 HTTPS

### 7.2. 访问控制

- 数据库用户权限最小化
- 使用连接池限制并发连接数
- 定期审计数据库访问日志

### 7.3. 数据备份加密

- 备份文件加密存储
- 备份传输使用安全通道

## 8. 附录

### 8.1. Prisma Schema 完整定义

见项目根目录 `prisma/schema.prisma` 文件。

### 8.2. 数据库版本

- PostgreSQL: 14.0+
- Prisma: 5.0+

### 8.3. 字符集

- 数据库字符集: UTF8
- 排序规则: utf8_general_ci

