# AI å®¢æœç³»ç»Ÿ - ä¸šåŠ¡é€»è¾‘æ€»ç»“

## ðŸ“‹ ç›®å½•

- [ä¸€ã€ç³»ç»Ÿæ¦‚è¿°](#ä¸€ç³»ç»Ÿæ¦‚è¿°)
- [äºŒã€æ ¸å¿ƒä¸šåŠ¡æµç¨‹](#äºŒæ ¸å¿ƒä¸šåŠ¡æµç¨‹)
- [ä¸‰ã€å·²å®žçŽ°çš„æ ¸å¿ƒåŠŸèƒ½](#ä¸‰å·²å®žçŽ°çš„æ ¸å¿ƒåŠŸèƒ½)
- [å››ã€æ•°æ®åº“æ ¸å¿ƒæ¨¡åž‹](#å››æ•°æ®åº“æ ¸å¿ƒæ¨¡åž‹)
- [äº”ã€å…³é”®æŠ€æœ¯å®žçŽ°](#äº”å…³é”®æŠ€æœ¯å®žçŽ°)
- [å…­ã€ç³»ç»Ÿç‰¹ç‚¹æ€»ç»“](#å…­ç³»ç»Ÿç‰¹ç‚¹æ€»ç»“)

---

## ä¸€ã€ç³»ç»Ÿæ¦‚è¿°

### 1.1 ç³»ç»Ÿå®šä½

ä¸€ä¸ªåŸºäºŽ **NestJS + React** çš„å¤šæ¸¸æˆ AI å®¢æœå¹³å°ï¼Œæ ¸å¿ƒè®¾è®¡ç†å¿µæ˜¯ **"å‰ç½®åˆ†æµ"** å’Œ **"æ™ºèƒ½è·¯ç”±"**ã€‚

### 1.2 æŠ€æœ¯æž¶æž„

- **åŽç«¯æ¡†æž¶**: NestJS + Prisma + PostgreSQL
- **å‰ç«¯æ¡†æž¶**: React + Vite + Zustand
- **å®žæ—¶é€šä¿¡**: WebSocket (Socket.io)
- **AI å¼•æ“Ž**: Dify (æ”¯æŒå·¥ä½œæµå’Œå¯¹è¯ API)
- **éƒ¨ç½²æ–¹å¼**: Docker + Docker Compose

### 1.3 æ ¸å¿ƒè®¾è®¡ç†å¿µ

1. **å‰ç½®åˆ†æµ**: çŽ©å®¶å…ˆå¡«å†™è¡¨å•æ”¶é›†å®Œæ•´ä¿¡æ¯ï¼Œå†è¿›å…¥å’¨è¯¢æµç¨‹
2. **æ™ºèƒ½è·¯ç”±**: AI è‡ªåŠ¨åˆ¤æ–­é—®é¢˜ç´§æ€¥ç¨‹åº¦ï¼Œæ™ºèƒ½åˆ†é…åˆ°äººå·¥æˆ–å·¥å•
3. **æ— éœ€ç™»å½•**: é€šè¿‡æ¸¸æˆä¿¡æ¯ï¼ˆgameId + playerIdOrNameï¼‰éªŒè¯èº«ä»½

---

## äºŒã€æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### 2.1 å·¥å•åˆ›å»ºæµç¨‹ï¼ˆå‰ç½®åˆ†æµï¼‰

**å®žçŽ°ä½ç½®**: `backend/src/ticket/ticket.service.ts` - `create()`

**æ ¸å¿ƒé€»è¾‘**:
1. éªŒè¯é—®é¢˜ç±»åž‹ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰"ç›´æŽ¥è½¬äººå·¥"æ ‡å¿—
2. æ ¹æ®é—®é¢˜ç±»åž‹æƒé‡è®¡ç®—ä¼˜å…ˆçº§åˆ†æ•°ï¼ˆå…¬å¼ï¼š`maxWeight + sumOfOtherWeights * 0.3`ï¼‰
3. å¦‚æžœéœ€è¦ç›´æŽ¥è½¬äººå·¥ä¸”åœ¨çº¿å®¢æœï¼Œè‡ªåŠ¨åˆ›å»ºä¼šè¯å¹¶åˆ†é…

**å…³é”®ç‚¹**:
- âœ… é—®é¢˜ç±»åž‹å¯é…ç½®"ç›´æŽ¥è½¬äººå·¥"æ ‡å¿—ï¼ˆ`requireDirectTransfer`ï¼‰
- âœ… è‡ªåŠ¨è®¡ç®—ä¼˜å…ˆçº§åˆ†æ•°ï¼ˆåŸºäºŽé—®é¢˜ç±»åž‹æƒé‡ï¼‰
- âœ… å¦‚æžœæœ‰åœ¨çº¿å®¢æœï¼Œè‡ªåŠ¨åˆ›å»ºä¼šè¯å¹¶åˆ†é…

---

### 2.2 ä¼šè¯åˆ›å»ºä¸Ž AI å¼•å¯¼

**å®žçŽ°ä½ç½®**: `backend/src/session/session.service.ts` - `create()`

**æ ¸å¿ƒé€»è¾‘**:
1. åˆ›å»ºä¼šè¯ï¼ˆçŠ¶æ€ï¼šPENDINGï¼‰
2. è°ƒç”¨ Dify AI çš„ `triage()` æ–¹æ³•åˆ†æžé—®é¢˜ï¼ˆæ”¯æŒå·¥ä½œæµAPIå’Œå¯¹è¯APIï¼‰
3. ä¿å­˜ AI åˆ†æžç»“æžœï¼ˆ`detectedIntent`ã€`aiUrgency`ï¼‰
4. åˆ›å»º AI æ¶ˆæ¯å¹¶æŽ¨é€ç»™çŽ©å®¶ï¼ˆåŒ…å«å»ºè®®é€‰é¡¹ï¼‰

**å…³é”®ç‚¹**:
- âœ… ä¼šè¯åˆ›å»ºæ—¶ç«‹å³è°ƒç”¨ AI åˆ†æž
- âœ… ä¿å­˜ AI æ£€æµ‹çš„æ„å›¾å’Œç´§æ€¥ç¨‹åº¦
- âœ… æä¾›å»ºè®®é€‰é¡¹å¼•å¯¼çŽ©å®¶

---

### 2.3 çŽ©å®¶æ¶ˆæ¯å¤„ç†ä¸Ž AI å¯¹è¯

**å®žçŽ°ä½ç½®**: `backend/src/session/session.service.ts` - `handlePlayerMessage()`

**æ ¸å¿ƒé€»è¾‘**:
1. ä¿å­˜çŽ©å®¶æ¶ˆæ¯
2. åˆ¤æ–­ä¼šè¯çŠ¶æ€ï¼šå¦‚æžœå·²è¢«å®¢æœæŽ¥å…¥ï¼ˆIN_PROGRESSï¼‰æˆ–å·²è½¬äººå·¥ï¼ˆQUEUEDï¼‰ï¼Œä¸è§¦å‘ AI
3. è°ƒç”¨ Dify AI çš„ `sendChatMessage()` è¿›è¡Œå¯¹è¯ï¼ˆæ”¯æŒ `conversationId` ä¼šè¯æŒä¹…åŒ–ï¼‰
4. ä¿å­˜ `conversationId` ç”¨äºŽåŽç»­å¯¹è¯ä¸Šä¸‹æ–‡
5. åˆ›å»º AI å›žå¤æ¶ˆæ¯ï¼ˆè‡ªåŠ¨æ£€æµ‹å…³é”®è¯ï¼Œå¦‚åŒ…å«"è½¬äººå·¥"ç­‰ï¼Œä¼šæ·»åŠ è½¬äººå·¥é€‰é¡¹ï¼‰

**å…³é”®ç‚¹**:
- âœ… æ”¯æŒä¼šè¯æŒä¹…åŒ–ï¼ˆconversationIdï¼‰ï¼Œä¿æŒå¯¹è¯ä¸Šä¸‹æ–‡
- âœ… å®¢æœæŽ¥å…¥åŽä¸å†è§¦å‘ AI
- âœ… è‡ªåŠ¨æ£€æµ‹å…³é”®è¯ï¼Œå»ºè®®è½¬äººå·¥

---

### 2.4 è½¬äººå·¥æµç¨‹ï¼ˆæ™ºèƒ½è·¯ç”±ï¼‰

**å®žçŽ°ä½ç½®**: `backend/src/session/session.service.ts` - `transferToAgent()`

**æ ¸å¿ƒé€»è¾‘**:
1. æ£€æŸ¥æ˜¯å¦æœ‰åœ¨çº¿å®¢æœï¼ˆåŒ…æ‹¬ç®¡ç†å‘˜ï¼‰
2. **æ— åœ¨çº¿å®¢æœ**ï¼šå…³é—­ä¼šè¯ï¼Œå°†å·¥å•è½¬ä¸ºåŠ æ€¥çŠ¶æ€ï¼ˆWAITING + URGENTï¼‰ï¼Œåˆ›å»ºç³»ç»Ÿæ¶ˆæ¯å‘ŠçŸ¥çŽ©å®¶
3. **æœ‰åœ¨çº¿å®¢æœ**ï¼š
   - æ›´æ–°ä¼šè¯çŠ¶æ€ä¸º QUEUEDï¼ˆæŽ’é˜Ÿä¸­ï¼‰
   - è®¡ç®—ä¼˜å…ˆçº§åˆ†æ•°ï¼ˆåŸºäºŽ UrgencyRule è§„åˆ™ï¼‰
   - é‡æ–°æŽ’åºé˜Ÿåˆ—
   - è‡ªåŠ¨åˆ†é…å®¢æœï¼ˆè´Ÿè½½å‡è¡¡ï¼‰

**å…³é”®ç‚¹**:
- âœ… æ— åœ¨çº¿å®¢æœæ—¶è½¬ä¸ºåŠ æ€¥å·¥å•ï¼Œç­‰å¾…åŽç»­å¤„ç†
- âœ… æœ‰åœ¨çº¿å®¢æœæ—¶è¿›å…¥æŽ’é˜Ÿå¹¶è‡ªåŠ¨åˆ†é…
- âœ… è½¬äººå·¥æ—¶é‡æ–°è®¡ç®—ä¼˜å…ˆçº§åˆ†æ•°ï¼ˆåŸºäºŽ UrgencyRule è§„åˆ™ï¼‰

---

### 2.5 æ™ºèƒ½æŽ’é˜Ÿä¸Žå®¢æœåˆ†é…

**å®žçŽ°ä½ç½®**: `backend/src/session/session.service.ts` - `reorderQueue()`

**æ ¸å¿ƒé€»è¾‘**:
1. **å·²åˆ†é…ä¼šè¯**ï¼šæŒ‰å®¢æœIDåˆ†ç»„ï¼Œåœ¨æ¯ä¸ªå®¢æœçš„é˜Ÿåˆ—ä¸­æŒ‰ä¼˜å…ˆçº§åˆ†æ•°å’ŒæŽ’é˜Ÿæ—¶é—´æŽ’åºï¼Œè®¡ç®—æŽ’é˜Ÿä½ç½®
2. **æœªåˆ†é…ä¼šè¯**ï¼šå…¨å±€æŒ‰ä¼˜å…ˆçº§åˆ†æ•°å’ŒæŽ’é˜Ÿæ—¶é—´æŽ’åºï¼Œè®¡ç®—å…¨å±€æŽ’å
3. è®¡ç®—é¢„è®¡ç­‰å¾…æ—¶é—´ï¼š
   - å·²åˆ†é…ï¼š`queuePosition * 5åˆ†é’Ÿ`
   - æœªåˆ†é…ï¼š`(queuePosition / åœ¨çº¿å®¢æœæ•°) * 5åˆ†é’Ÿ`
4. æ›´æ–°æ•°æ®åº“ä¸­çš„ `queuePosition`ï¼Œé€šè¿‡ WebSocket æŽ¨é€æŽ’é˜Ÿä½ç½®å’Œé¢„è®¡ç­‰å¾…æ—¶é—´

**å…³é”®ç‚¹**:
- âœ… å·²åˆ†é…ä¼šè¯æŒ‰å®¢æœåˆ†ç»„è®¡ç®—ä½ç½®ï¼ˆæ¯ä¸ªå®¢æœæœ‰ç‹¬ç«‹é˜Ÿåˆ—ï¼‰
- âœ… æœªåˆ†é…ä¼šè¯è®¡ç®—å…¨å±€æŽ’å
- âœ… é¢„è®¡ç­‰å¾…æ—¶é—´å®žæ—¶è®¡ç®—ï¼Œä¸å­˜å‚¨åœ¨æ•°æ®åº“ï¼Œé€šè¿‡ WebSocket æŽ¨é€
- âœ… æŽ’åºè§„åˆ™ï¼šä¼˜å…ˆçº§åˆ†æ•°é™åºï¼Œç›¸åŒåˆ†æ•°æŒ‰æŽ’é˜Ÿæ—¶é—´å‡åº

---

### 2.6 å®¢æœæŽ¥å…¥ä¼šè¯

**å®žçŽ°ä½ç½®**: `backend/src/session/session.service.ts` - `acceptSession()`

**æ ¸å¿ƒé€»è¾‘**:
1. æ£€æŸ¥ä¼šè¯çŠ¶æ€ï¼ˆå…è®¸ QUEUEDã€PENDING æˆ– CLOSED ä½†å·¥å•ä¸º WAITINGï¼‰
2. æ›´æ–°ä¼šè¯çŠ¶æ€ä¸º IN_PROGRESSï¼Œåˆ†é…å®¢æœIDï¼Œæ¸…é™¤æŽ’é˜Ÿç›¸å…³å­—æ®µ
3. æ›´æ–°å·¥å•çŠ¶æ€ä¸º IN_PROGRESS
4. é‡æ–°æŽ’åºé˜Ÿåˆ—ï¼ˆç§»é™¤å·²æŽ¥å…¥çš„ä¼šè¯ï¼‰

**å…³é”®ç‚¹**:
- âœ… å®¢æœå¯ä»¥æŽ¥å…¥ QUEUED æˆ– WAITING çŠ¶æ€çš„ä¼šè¯
- âœ… æŽ¥å…¥åŽçŠ¶æ€å˜ä¸º IN_PROGRESSï¼Œæ¸…é™¤æŽ’é˜Ÿä½ç½®
- âœ… è‡ªåŠ¨æ›´æ–°å·¥å•çŠ¶æ€

---

### 2.7 å·¥å•çŠ¶æ€è‡ªåŠ¨æ›´æ–°

**å®žçŽ°ä½ç½®**: `backend/src/ticket/ticket.service.ts` - `checkAndUpdateTicketStatus()`

**æ ¸å¿ƒé€»è¾‘**:
1. æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ä¼šè¯éƒ½å·²å…³é—­
2. åˆ¤æ–­æ˜¯å¦æœ‰å®¢æœä»‹å…¥ï¼š
   - æ£€æŸ¥æ˜¯å¦æœ‰å®¢æœæ¶ˆæ¯ï¼ˆ`TicketMessage` ä¸­ `senderId` ä¸ä¸º nullï¼‰
   - æ£€æŸ¥æ˜¯å¦æœ‰ä¼šè¯è¢«åˆ†é…ç»™å®¢æœï¼ˆ`Session.agentId` ä¸ä¸º nullï¼‰
3. æ›´æ–°å·¥å•çŠ¶æ€ï¼š
   - æœ‰å®¢æœä»‹å…¥ â†’ RESOLVEDï¼ˆå·²è§£å†³ï¼‰
   - æ— å®¢æœä»‹å…¥ â†’ WAITINGï¼ˆç­‰å¾…åŽç»­å¤„ç†ï¼‰

**å…³é”®ç‚¹**:
- âœ… æ‰€æœ‰ä¼šè¯å…³é—­æ—¶è‡ªåŠ¨åˆ¤æ–­å·¥å•çŠ¶æ€
- âœ… æœ‰å®¢æœä»‹å…¥ â†’ RESOLVED
- âœ… æ— å®¢æœä»‹å…¥ â†’ WAITINGï¼ˆç­‰å¾…åŽç»­å¤„ç†ï¼‰

---

## ä¸‰ã€å·²å®žçŽ°çš„æ ¸å¿ƒåŠŸèƒ½

### 3.1 å‰ç½®åˆ†æµ âœ…

- âœ… å·¥å•åˆ›å»ºæ—¶æ”¶é›†å®Œæ•´ä¿¡æ¯ï¼ˆæ¸¸æˆã€åŒºæœã€çŽ©å®¶IDã€é—®é¢˜æè¿°ã€é—®é¢˜ç±»åž‹ï¼‰
- âœ… é—®é¢˜ç±»åž‹å¯é…ç½®"ç›´æŽ¥è½¬äººå·¥"æ ‡å¿—
- âœ… è‡ªåŠ¨è®¡ç®—ä¼˜å…ˆçº§ï¼ˆåŸºäºŽé—®é¢˜ç±»åž‹æƒé‡ï¼‰

### 3.2 AI æ™ºèƒ½å¼•å¯¼ âœ…

- âœ… ä¼šè¯åˆ›å»ºæ—¶ AI åˆå§‹åˆ†æž
- âœ… æ”¯æŒå¤šè½®å¯¹è¯ï¼ˆä¼šè¯æŒä¹…åŒ–ï¼‰
- âœ… è‡ªåŠ¨æ£€æµ‹æ„å›¾å’Œç´§æ€¥ç¨‹åº¦
- âœ… æä¾›å»ºè®®é€‰é¡¹å¼•å¯¼çŽ©å®¶

### 3.3 æ™ºèƒ½è·¯ç”± âœ…

- âœ… è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦è½¬äººå·¥
- âœ… æ— åœ¨çº¿å®¢æœæ—¶è½¬ä¸ºåŠ æ€¥å·¥å•
- âœ… æœ‰åœ¨çº¿å®¢æœæ—¶è¿›å…¥æŽ’é˜Ÿ

### 3.4 æ™ºèƒ½æŽ’é˜Ÿ âœ…

- âœ… æŒ‰ä¼˜å…ˆçº§åˆ†æ•°å’ŒæŽ’é˜Ÿæ—¶é—´æŽ’åº
- âœ… è‡ªåŠ¨åˆ†é…å®¢æœï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
- âœ… å®žæ—¶æ˜¾ç¤ºæŽ’é˜Ÿä½ç½®å’Œé¢„è®¡ç­‰å¾…æ—¶é—´
- âœ… æ”¯æŒæŒ‰å®¢æœåˆ†ç»„æŽ’é˜Ÿ

### 3.5 å®žæ—¶é€šä¿¡ âœ…

- âœ… WebSocket å®žæ—¶æ¶ˆæ¯æŽ¨é€
- âœ… ä¼šè¯çŠ¶æ€å®žæ—¶æ›´æ–°
- âœ… æŽ’é˜Ÿä½ç½®å®žæ—¶æ›´æ–°

### 3.6 å·¥å•ç®¡ç† âœ…

- âœ… å®Œæ•´çš„å·¥å•ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆåˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€å…³é—­ï¼‰
- âœ… è‡ªåŠ¨çŠ¶æ€æ›´æ–°ï¼ˆä¼šè¯å…³é—­æ—¶è‡ªåŠ¨åˆ¤æ–­ï¼‰
- âœ… æ”¯æŒé™„ä»¶ä¸Šä¼ ï¼ˆå›¾ç‰‡ã€æ–‡ä»¶ï¼Œæœ¬åœ°æ–‡ä»¶å­˜å‚¨ï¼‰
- âœ… èº«ä»½éªŒè¯ï¼ˆæ”¯ä»˜è®¢å•éªŒè¯ï¼Œç›®å‰ä¸ºæ¨¡æ‹ŸéªŒè¯ï¼‰
- âœ… æ£€æŸ¥æœªå…³é—­å·¥å•ï¼ˆé˜²æ­¢é‡å¤æäº¤ï¼‰
- âœ… å®šæ—¶ä»»åŠ¡ï¼šè¶…è¿‡3å¤©æœªå¤„ç†çš„å·¥å•è‡ªåŠ¨æ ‡è®°ä¸ºå·²è§£å†³

### 3.7 å¿«æ·å›žå¤ âœ…

- âœ… åˆ†ç±»ç®¡ç†
- âœ… ä¸ªäººåå¥½è®¾ç½®
- âœ… ä½¿ç”¨é¢‘çŽ‡ç»Ÿè®¡

### 3.8 æ»¡æ„åº¦è¯„ä»· âœ…

- âœ… ä¼šè¯ç»“æŸåŽæ”¶é›†è¯„ä»·
- âœ… æ”¯æŒè¯„åˆ†å’Œåé¦ˆ

### 3.9 AI ä¼˜åŒ–å›žå¤ âœ…

- âœ… å®¢æœå›žå¤å†…å®¹ AI æ™ºèƒ½ä¼˜åŒ–
- âœ… å‰ç«¯æä¾›"AIä¼˜åŒ–"æŒ‰é’®
- âœ… ä¼˜åŒ–åŽå¯ä»¥æ¢å¤åŽŸæ–‡

### 3.10 ç´§æ€¥æŽ’åºè§„åˆ™ âœ…

- âœ… å¯é…ç½®çš„ç´§æ€¥æŽ’åºè§„åˆ™ï¼ˆUrgencyRuleï¼‰
- âœ… æ”¯æŒå¤šæ¡ä»¶åŒ¹é…ï¼ˆå…³é”®è¯ã€æ„å›¾ã€èº«ä»½çŠ¶æ€ã€æ¸¸æˆã€ä¼˜å…ˆçº§ï¼‰
- âœ… è§„åˆ™å¯ç”¨/ç¦ç”¨æŽ§åˆ¶
- âœ… è½¬äººå·¥æ—¶è‡ªåŠ¨åº”ç”¨è§„åˆ™è®¡ç®—ä¼˜å…ˆçº§åˆ†æ•°

---

## å››ã€æ•°æ®åº“æ ¸å¿ƒæ¨¡åž‹

### 4.1 å·¥å•æ¨¡åž‹ï¼ˆTicketï¼‰

```prisma
model Ticket {
  id              String         @id @default(uuid())
  ticketNo        String         @unique
  gameId          String
  serverId        String?
  serverName      String?
  playerIdOrName  String
  description     String         @db.Text
  status          TicketStatus   @default(IN_PROGRESS)  // IN_PROGRESS | WAITING | RESOLVED
  priority        Priority       @default(NORMAL)        // LOW | NORMAL | HIGH | URGENT
  priorityScore   Int            @default(50)            // ä¼˜å…ˆçº§åˆ†æ•°ï¼ˆç”¨äºŽæŽ’åºï¼‰
  token           String         @unique                  // ç”¨äºŽçŽ©å®¶æŸ¥è¯¢å·¥å•
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  closedAt        DateTime?
  
  // å…³ç³»
  game            Game              @relation(...)
  server          Server?          @relation(...)
  sessions        Session[]
  messages        TicketMessage[]
  attachments     TicketAttachment[]
}
```

### 4.2 ä¼šè¯æ¨¡åž‹ï¼ˆSessionï¼‰

```prisma
model Session {
  id            String        @id @default(uuid())
  ticketId      String
  agentId       String?       // åˆ†é…çš„å®¢æœID
  status        SessionStatus @default(PENDING)  // PENDING | QUEUED | IN_PROGRESS | CLOSED
  detectedIntent String?      // AI æ£€æµ‹çš„æ„å›¾
  aiUrgency     Urgency?      // AI åˆ¤æ–­çš„ç´§æ€¥ç¨‹åº¦
  playerUrgency Urgency?      // çŽ©å®¶é€‰æ‹©çš„ç´§æ€¥ç¨‹åº¦
  priorityScore Int           @default(0)        // ä¼˜å…ˆçº§åˆ†æ•°
  queuePosition Int?          // æŽ’é˜Ÿä½ç½®
  queuedAt      DateTime?     // æŽ’é˜Ÿæ—¶é—´
  transferAt    DateTime?     // è½¬äººå·¥æ—¶é—´
  startedAt     DateTime?     // å®¢æœæŽ¥å…¥æ—¶é—´
  closedAt      DateTime?     // å…³é—­æ—¶é—´
  difyConversationId String?  // Dify ä¼šè¯IDï¼ˆç”¨äºŽå¯¹è¯æŒä¹…åŒ–ï¼‰
  
  // å…³ç³»
  ticket        Ticket        @relation(...)
  agent         User?         @relation(...)
  messages      Message[]
}
```

### 4.3 æ¶ˆæ¯æ¨¡åž‹ï¼ˆMessageï¼‰

```prisma
model Message {
  id          String      @id @default(uuid())
  sessionId   String
  senderType  SenderType  // PLAYER | AI | AGENT | SYSTEM
  senderId    String?     // Agent ID (å½“senderTypeä¸ºAGENTæ—¶)
  content     String      @db.Text
  messageType MessageType @default(TEXT)
  metadata    Json?       // å­˜å‚¨å»ºè®®é€‰é¡¹ã€AIçŠ¶æ€ç­‰
  createdAt   DateTime    @default(now())
  
  // å…³ç³»
  session     Session     @relation(...)
  agent       User?       @relation(...)
}
```

---

## äº”ã€å…³é”®æŠ€æœ¯å®žçŽ°

### 5.1 Dify AI é›†æˆ

**å®žçŽ°ä½ç½®**: `backend/src/dify/dify.service.ts`

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… æ”¯æŒå·¥ä½œæµ API å’Œå¯¹è¯ APIï¼ˆè‡ªåŠ¨é™çº§ï¼‰
- âœ… ä¼šè¯æŒä¹…åŒ–ï¼ˆconversationIdï¼‰
- âœ… é”™è¯¯å¤„ç†å’Œé™çº§ç­–ç•¥ï¼ˆAPIå¤±è´¥æ—¶è¿”å›žé»˜è®¤å›žå¤ï¼‰

**å…³é”®æ–¹æ³•**:
- `triage()`: åˆå§‹åˆ†æµï¼Œåˆ†æžé—®é¢˜æ„å›¾å’Œç´§æ€¥ç¨‹åº¦ï¼ˆä¼˜å…ˆä½¿ç”¨å·¥ä½œæµAPIï¼Œå¤±è´¥æ—¶é™çº§åˆ°å¯¹è¯APIï¼‰
- `sendChatMessage()`: å‘é€å¯¹è¯æ¶ˆæ¯ï¼Œæ”¯æŒä¼šè¯ä¸Šä¸‹æ–‡ï¼ˆconversationIdï¼‰
- `optimizeReply()`: AI ä¼˜åŒ–å®¢æœå›žå¤å†…å®¹ï¼ˆå‰ç«¯è°ƒç”¨ï¼ŒåŽç«¯æä¾›APIï¼‰

### 5.2 WebSocket å®žæ—¶æŽ¨é€

**å®žçŽ°ä½ç½®**: `backend/src/websocket/websocket.gateway.ts`

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… æ¶ˆæ¯å®žæ—¶æŽ¨é€ï¼ˆçŽ©å®¶å’Œå®¢æœæ¶ˆæ¯ï¼‰
- âœ… ä¼šè¯çŠ¶æ€æ›´æ–°æŽ¨é€ï¼ˆæŽ¥å…¥ã€å…³é—­ç­‰ï¼‰
- âœ… æŽ’é˜Ÿä½ç½®æ›´æ–°æŽ¨é€ï¼ˆä½ç½®å’Œé¢„è®¡ç­‰å¾…æ—¶é—´ï¼‰
- âœ… å·¥å•çŠ¶æ€æ›´æ–°æŽ¨é€
- âœ… å®¢æœåœ¨çº¿çŠ¶æ€æŽ¨é€

**å…³é”®äº‹ä»¶**:
- `notifyMessage()`: æ–°æ¶ˆæ¯æŽ¨é€åˆ°ä¼šè¯æˆ¿é—´
- `notifySessionUpdate()`: ä¼šè¯çŠ¶æ€æ›´æ–°æŽ¨é€åˆ°ä¼šè¯æˆ¿é—´
- `notifyQueueUpdate()`: æŽ’é˜Ÿä½ç½®æ›´æ–°æŽ¨é€åˆ°ä¼šè¯æˆ¿é—´
- `notifyTicketUpdate()`: å·¥å•çŠ¶æ€æ›´æ–°æŽ¨é€åˆ°å·¥å•æˆ¿é—´

### 5.3 è´Ÿè½½å‡è¡¡åˆ†é…

**å®žçŽ°ä½ç½®**: `backend/src/session/session.service.ts` - `autoAssignAgentOnly()`

**åˆ†é…ç­–ç•¥**:
1. ä¼˜å…ˆåˆ†é…ç»™è´Ÿè½½æœ€å°‘çš„å®¢æœï¼ˆå½“å‰æŽ¥å¾…ä¼šè¯æ•°æœ€å°‘ï¼‰
2. è´Ÿè½½ç›¸åŒæ—¶ï¼Œä¼˜å…ˆåˆ†é…ç»™æœ€æ—©ç™»å½•çš„å®¢æœ
3. åªä»Žåœ¨çº¿å®¢æœä¸­é€‰æ‹©ï¼ˆ`isOnline: true`ï¼‰
4. å¦‚æžœæ²¡æœ‰åœ¨çº¿å®¢æœï¼Œæ£€æŸ¥åœ¨çº¿ç®¡ç†å‘˜ä½œä¸ºå¤‡é€‰

### 5.4 ä¼˜å…ˆçº§è®¡ç®—

ç³»ç»Ÿä¸­æœ‰ä¸¤ç§ä¼˜å…ˆçº§è®¡ç®—æ–¹å¼ï¼Œç”¨äºŽä¸åŒåœºæ™¯ï¼š

#### 5.4.1 å·¥å•åˆ›å»ºæ—¶çš„ä¼˜å…ˆçº§è®¡ç®—

**å®žçŽ°ä½ç½®**: `backend/src/ticket/ticket-priority.service.ts` - `calculatePriority()`

**è®¡ç®—æ–¹å¼**:
- åŸºäºŽé—®é¢˜ç±»åž‹æƒé‡è®¡ç®—
- å…¬å¼ï¼š`priorityScore = maxWeight + (sumOfOtherWeights * 0.3)`
- æ˜ å°„åˆ°ä¼˜å…ˆçº§æžšä¸¾ï¼š>=150(URGENT), >=100(HIGH), >=60(NORMAL), <60(LOW)

**ä½¿ç”¨åœºæ™¯**: å·¥å•åˆ›å»ºæ—¶ï¼ŒåŸºäºŽé€‰æ‹©çš„é—®é¢˜ç±»åž‹è®¡ç®—åˆå§‹ä¼˜å…ˆçº§

#### 5.4.2 è½¬äººå·¥æ—¶çš„ä¼˜å…ˆçº§åˆ†æ•°è®¡ç®—

**å®žçŽ°ä½ç½®**: `backend/src/session/session.service.ts` - `calculatePriorityScore()`

**è®¡ç®—æ–¹å¼**:
- åŸºäºŽç´§æ€¥æŽ’åºè§„åˆ™ï¼ˆUrgencyRuleï¼‰åŠ¨æ€è®¡ç®—
- éåŽ†æ‰€æœ‰å¯ç”¨çš„è§„åˆ™ï¼ŒåŒ¹é…æ¡ä»¶åŽç´¯åŠ æƒé‡åˆ†æ•°ï¼ˆ`priorityWeight`ï¼‰

**è§„åˆ™åŒ¹é…æ¡ä»¶**ï¼ˆ`UrgencyRule.conditions`ï¼‰:
- å…³é”®è¯åŒ¹é…ï¼ˆå·¥å•æè¿°ä¸­åŒ…å«å…³é”®è¯ï¼‰
- æ„å›¾åŒ¹é…ï¼ˆAIæ£€æµ‹çš„æ„å›¾ `detectedIntent`ï¼‰
- èº«ä»½çŠ¶æ€åŒ¹é…ï¼ˆæ˜¯å¦å·²éªŒè¯æ”¯ä»˜ `identityStatus`ï¼‰
- æ¸¸æˆåŒ¹é…ï¼ˆç‰¹å®šæ¸¸æˆ `gameId`ï¼‰
- ä¼˜å…ˆçº§åŒ¹é…ï¼ˆå·¥å•ä¼˜å…ˆçº§ `priority`ï¼‰

**ä½¿ç”¨åœºæ™¯**: çŽ©å®¶è½¬äººå·¥æ—¶ï¼Œé‡æ–°è®¡ç®—ä¼šè¯çš„ä¼˜å…ˆçº§åˆ†æ•°ï¼Œç”¨äºŽæŽ’é˜ŸæŽ’åº

---

## å…­ã€ç³»ç»Ÿç‰¹ç‚¹æ€»ç»“

### 6.1 æ ¸å¿ƒä¼˜åŠ¿

1. **å‰ç½®åˆ†æµ**: å…ˆæ”¶é›†ä¿¡æ¯ï¼Œå†å’¨è¯¢ï¼Œç¡®ä¿å®¢æœèŽ·å¾—å®Œæ•´ä¿¡æ¯
2. **æ™ºèƒ½è·¯ç”±**: AI è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦äººå·¥ï¼Œå‡å°‘æ— æ•ˆæŽ’é˜Ÿ
3. **å¤šæ¸¸æˆæ”¯æŒ**: æ¯ä¸ªæ¸¸æˆç‹¬ç«‹é…ç½® Dify APIï¼Œæ”¯æŒä¸åŒä¸šåŠ¡åœºæ™¯
4. **å®žæ—¶é€šä¿¡**: WebSocket å®žæ—¶æŽ¨é€ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
5. **æ™ºèƒ½æŽ’é˜Ÿ**: è‡ªåŠ¨åˆ†é…å®¢æœï¼Œæ˜¾ç¤ºç­‰å¾…æ—¶é—´ï¼Œé€æ˜ŽåŒ–å¤„ç†æµç¨‹
6. **æ— éœ€ç™»å½•**: é€šè¿‡æ¸¸æˆä¿¡æ¯éªŒè¯èº«ä»½ï¼Œé™ä½Žä½¿ç”¨é—¨æ§›

### 6.2 ä¸šåŠ¡æµç¨‹æ€»ç»“

```
çŽ©å®¶åˆ›å»ºå·¥å•
    â†“
åˆ¤æ–­æ˜¯å¦éœ€è¦ç›´æŽ¥è½¬äººå·¥
    â”œâ”€ æ˜¯ â†’ æ£€æŸ¥åœ¨çº¿å®¢æœ â†’ æœ‰ â†’ åˆ›å»ºä¼šè¯å¹¶åˆ†é…
    â”‚                      â””â”€ æ—  â†’ è½¬ä¸ºåŠ æ€¥å·¥å•
    â”‚
    â””â”€ å¦ â†’ åˆ›å»ºä¼šè¯ â†’ AI åˆå§‹åˆ†æž â†’ çŽ©å®¶å¯¹è¯
                                    â†“
                              çŽ©å®¶é€‰æ‹©è½¬äººå·¥
                                    â†“
                        æ£€æŸ¥åœ¨çº¿å®¢æœ â†’ æœ‰ â†’ è¿›å…¥æŽ’é˜Ÿ â†’ è‡ªåŠ¨åˆ†é… â†’ å®¢æœæŽ¥å…¥
                                    â””â”€ æ—  â†’ è½¬ä¸ºåŠ æ€¥å·¥å•
```

### 6.3 çŠ¶æ€æµè½¬å›¾

**å·¥å•çŠ¶æ€**:
```
IN_PROGRESS (AIå¤„ç†ä¸­)
    â†“
WAITING (ç­‰å¾…äººå·¥å¤„ç†)
    â†“
RESOLVED (å·²è§£å†³)
```

**ä¼šè¯çŠ¶æ€**:
```
PENDING (AIå¼•å¯¼ä¸­)
    â†“
QUEUED (æŽ’é˜Ÿä¸­)
    â†“
IN_PROGRESS (å®¢æœå¤„ç†ä¸­)
    â†“
CLOSED (å·²å…³é—­)
```

---

## ä¸ƒã€åŽç»­ä¼˜åŒ–æ–¹å‘

### 7.1 å¾…å®žçŽ°åŠŸèƒ½

- [ ] æ™ºèƒ½å®¢æœè‡ªåŠ¨è§£å†³åŽï¼ŒçŽ©å®¶å…³é—­ç•Œé¢æ—¶è‡ªåŠ¨æ ‡è®°å·¥å•ä¸ºå·²è§£å†³ï¼ˆå·²è®¨è®ºæ–¹æ¡ˆï¼Œå¾…å®žçŽ°ï¼‰
- [ ] çŽ©å®¶åŽ†å²å·¥å•æŸ¥è¯¢åŠŸèƒ½ï¼ˆé€šè¿‡æ¸¸æˆä¿¡æ¯æŸ¥è¯¢ï¼Œå·²è®¨è®ºæ–¹æ¡ˆï¼Œå¾…å®žçŽ°ï¼‰
- [ ] åé¦ˆæ”¶é›†åŠŸèƒ½ï¼ˆåŠŸèƒ½å»ºè®®ã€BugæŠ¥å‘Šç­‰ï¼Œå·²è®¨è®ºæ–¹æ¡ˆï¼Œå¾…å®žçŽ°ï¼‰
- [ ] æ€§èƒ½ç›‘æŽ§ï¼ˆPrometheus + Grafanaï¼Œå·²è®¨è®ºæ–¹æ¡ˆï¼Œå¾…å®žçŽ°ï¼‰

### 7.2 ä¼˜åŒ–å»ºè®®

1. **æ€§èƒ½ä¼˜åŒ–**: æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–ï¼Œæ·»åŠ å¿…è¦çš„ç´¢å¼•
2. **å®‰å…¨ä¼˜åŒ–**: ç§»é™¤ç¡¬ç¼–ç å¯†ç éªŒè¯ï¼ŒåŠ å¼ºèº«ä»½éªŒè¯
3. **ç›‘æŽ§ä¼˜åŒ–**: æ·»åŠ æ€§èƒ½ç›‘æŽ§å’Œé”™è¯¯è¿½è¸ª
4. **å­˜å‚¨ä¼˜åŒ–**: è€ƒè™‘ä½¿ç”¨å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼ˆOSSï¼‰æ›¿ä»£æœ¬åœ°æ–‡ä»¶å­˜å‚¨ï¼Œæå‡æ–‡ä»¶è®¿é—®æ€§èƒ½å’Œå¯é æ€§

---

## å…«ã€ç›¸å…³æ–‡æ¡£

- [äº§å“éœ€æ±‚æ–‡æ¡£](./AI%20å®¢æœç³»ç»Ÿ%20-%20äº§å“éœ€æ±‚æ–‡æ¡£.md)
- [äº§å“ä½¿ç”¨æ–‡æ¡£](./äº§å“ä½¿ç”¨æ–‡æ¡£.md)
- [README](../README.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.1  
**æœ€åŽæ›´æ–°**: 2025-12-02  
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ

---

## ä¹ã€é‡è¦è¯´æ˜Ž

### 9.1 ä¼˜å…ˆçº§è®¡ç®—çš„ä¸¤ç§æ–¹å¼

ç³»ç»Ÿä¸­æœ‰ä¸¤ç§ä¸åŒçš„ä¼˜å…ˆçº§è®¡ç®—æœºåˆ¶ï¼Œç”¨äºŽä¸åŒåœºæ™¯ï¼š

1. **å·¥å•åˆ›å»ºæ—¶**: ä½¿ç”¨ `TicketPriorityService.calculatePriority()`ï¼ŒåŸºäºŽé—®é¢˜ç±»åž‹æƒé‡è®¡ç®—
2. **è½¬äººå·¥æ—¶**: ä½¿ç”¨ `SessionService.calculatePriorityScore()`ï¼ŒåŸºäºŽ UrgencyRule è§„åˆ™åŠ¨æ€è®¡ç®—

è¿™ä¸¤ç§æ–¹å¼ç›¸äº’ç‹¬ç«‹ï¼Œç¡®ä¿åœ¨ä¸åŒé˜¶æ®µéƒ½èƒ½æ­£ç¡®è®¡ç®—ä¼˜å…ˆçº§ã€‚

### 9.2 åŠŸèƒ½å®žçŽ°çŠ¶æ€

æœ¬æ–‡æ¡£ä¸­çš„æ‰€æœ‰åŠŸèƒ½å‡ä¸º**å·²å®žçŽ°å¹¶æµ‹è¯•**çš„åŠŸèƒ½ã€‚æœªå®žçŽ°çš„åŠŸèƒ½å·²æ˜Žç¡®æ ‡æ³¨åœ¨"åŽç»­ä¼˜åŒ–æ–¹å‘"ç« èŠ‚ä¸­ã€‚

### 9.3 ä»£ç ä½ç½®è¯´æ˜Ž

æ–‡æ¡£ä¸­æ‰€æœ‰ä»£ç ç¤ºä¾‹å‡æ ‡æ³¨äº†å®žé™…æ–‡ä»¶ä½ç½®ï¼Œå¯ç›´æŽ¥åœ¨ä»£ç åº“ä¸­æ‰¾åˆ°å¯¹åº”å®žçŽ°ã€‚

