# 玩家下线处理方案讨论

## 📋 问题背景

当玩家在排队等待客服接入时（会话状态为 `QUEUED`），如果玩家下线（关闭浏览器、网络断开等），管理端应该如何显示和处理这些会话？

---

## 🎯 方案对比

### 方案1：保持排队状态，标记玩家离线状态 ⭐ **推荐**

**核心思路**：
- 会话保持 `QUEUED` 状态，继续在排队队列中显示
- 添加 `playerOnline` 字段标记玩家是否在线
- 管理端区分显示"玩家在线排队"和"玩家离线排队"
- 客服可以选择接入，但知道玩家可能不在线

**优点**：
- ✅ 玩家重新上线后可以继续排队，无需重新提交
- ✅ 客服可以看到所有待处理的反馈，包括玩家已下线的
- ✅ 不会丢失玩家的反馈信息
- ✅ 玩家离线时，客服可以先查看问题，准备回复

**缺点**：
- ⚠️ 需要检测玩家在线状态（通过 WebSocket 连接状态）
- ⚠️ 管理端需要区分显示在线/离线状态

**实现要点**：
1. 在 `Session` 模型中添加 `playerOnline: Boolean` 字段（或通过 WebSocket 连接状态判断）
2. WebSocket 断开时，更新相关会话的玩家在线状态
3. 管理端排队列表显示时，区分在线/离线状态（如：标签、图标）
4. 玩家重新连接时，恢复在线状态

**适用场景**：
- 玩家可能临时离开，稍后回来
- 客服可以先查看问题，准备回复
- 希望保留所有反馈，不丢失信息

---

### 方案2：玩家下线后自动转为工单

**核心思路**：
- 检测到玩家下线（WebSocket断开）且会话状态为 `QUEUED` 时
- 自动将会话状态改为 `CLOSED`
- 工单状态改为 `WAITING`（待人工）
- 管理端在工单列表中显示，而不是在排队队列中

**优点**：
- ✅ 排队队列只显示玩家在线的会话，更清晰
- ✅ 玩家下线的反馈自动转为工单，符合异步处理流程
- ✅ 实现相对简单

**缺点**：
- ❌ 玩家重新上线后，无法继续排队，需要重新提交
- ❌ 可能丢失玩家的实时反馈意愿
- ❌ 如果玩家只是短暂断开（如网络波动），会被误转为工单

**实现要点**：
1. WebSocket 断开时，检查会话状态
2. 如果状态为 `QUEUED`，自动关闭会话并更新工单状态
3. 管理端工单列表显示这些工单

**适用场景**：
- 玩家下线后，主要通过工单异步处理
- 希望排队队列只显示玩家在线的会话

---

### 方案3：玩家下线后保持排队，但降低优先级

**核心思路**：
- 会话保持 `QUEUED` 状态
- 玩家下线时，降低优先级分数（如：-10分）
- 管理端显示时，标记为"玩家离线"
- 客服可以选择接入，但优先处理玩家在线的会话

**优点**：
- ✅ 保留所有反馈，不丢失信息
- ✅ 优先处理玩家在线的会话，提升响应速度
- ✅ 玩家重新上线后可以继续排队

**缺点**：
- ⚠️ 需要动态调整优先级，逻辑较复杂
- ⚠️ 玩家重新上线时需要恢复优先级

**实现要点**：
1. 玩家下线时，降低优先级分数
2. 玩家重新上线时，恢复优先级分数
3. 管理端显示时，区分在线/离线状态

**适用场景**：
- 希望优先处理玩家在线的会话
- 但不想丢失玩家离线的反馈

---

## 💡 推荐方案：方案1（保持排队状态，标记玩家离线）

### 理由

1. **用户体验更好**：玩家重新上线后可以继续排队，无需重新提交
2. **信息不丢失**：所有反馈都保留在排队队列中，客服可以看到
3. **灵活性高**：客服可以先查看问题，准备回复，等玩家上线后再接入
4. **实现相对简单**：只需要标记在线状态，不需要复杂的状态转换

### 实现细节

#### 1. 数据模型
- 方案A：在 `Session` 模型中添加 `playerOnline: Boolean` 字段
- 方案B：通过 WebSocket 连接状态实时判断（推荐，无需修改数据库）

#### 2. WebSocket 断开处理
```typescript
// 当玩家断开连接时
async handleDisconnect(client: Socket) {
  // 查找该连接关联的会话
  const sessions = await this.findSessionsBySocketId(client.id);
  
  // 更新会话的玩家在线状态
  for (const session of sessions) {
    if (session.status === 'QUEUED') {
      // 标记玩家离线（或通过实时查询判断）
      await this.updatePlayerOnlineStatus(session.id, false);
    }
  }
}
```

#### 3. 管理端显示
- 排队列表中，区分显示：
  - 🟢 "玩家在线" - 正常排队
  - 🔴 "玩家离线" - 玩家已下线，但反馈已记录
- 客服可以选择：
  - 优先接入玩家在线的会话
  - 查看玩家离线的会话，准备回复

#### 4. 玩家重新上线
- 玩家重新连接时，恢复在线状态
- 如果会话仍在排队中，继续排队
- 如果会话已被客服接入，直接进入聊天

---

## 🔄 状态流转图

```
玩家转人工
  ↓
QUEUED (排队中) + playerOnline: true
  ↓
[玩家下线] → playerOnline: false (会话仍为 QUEUED)
  ↓
[玩家重新上线] → playerOnline: true (继续排队)
  ↓
[客服接入] → IN_PROGRESS
```

---

## 📝 管理端显示建议

### 排队列表显示
```
┌─────────────────────────────────────┐
│ 排队中 (3)                          │
├─────────────────────────────────────┤
│ 🟢 工单 #T-20251125-001             │
│    玩家在线 · 等待时间: 2分钟        │
│    [接入会话]                       │
├─────────────────────────────────────┤
│ 🔴 工单 #T-20251125-002             │
│    玩家离线 · 等待时间: 5分钟        │
│    [查看详情] [接入会话]            │
└─────────────────────────────────────┘
```

### 优先级排序
1. 玩家在线 + 高优先级分数
2. 玩家在线 + 低优先级分数
3. 玩家离线 + 高优先级分数
4. 玩家离线 + 低优先级分数

---

## ⚠️ 边界情况处理

1. **网络波动**：短暂断开后立即重连，不应影响排队状态
   - 解决方案：设置离线超时时间（如：30秒），超过时间才标记为离线

2. **玩家主动离开**：玩家点击"退出会话"
   - 解决方案：直接关闭会话，转为工单（使用 `closeByPlayer` 方法）

3. **长时间离线**：玩家离线超过一定时间（如：1小时）
   - 解决方案：可以考虑自动转为工单，或保持排队但降低优先级

---

## 🎯 最终建议

**采用方案1**，但结合以下优化：

1. **实时判断在线状态**：通过 WebSocket 连接状态判断，不存储 `playerOnline` 字段
2. **离线超时机制**：玩家断开连接后，等待30秒再标记为离线（避免网络波动误判）
3. **管理端区分显示**：清晰标识玩家在线/离线状态
4. **长时间离线处理**：玩家离线超过1小时，自动转为工单（可选）

这样既保证了用户体验，又不会丢失反馈信息，同时管理端可以灵活处理。

