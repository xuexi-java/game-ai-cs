# 无在线客服业务逻辑修复说明

**修复日期**: 2024年  
**问题**: 即使没有客服在线，系统也显示"等待接入"  
**修复状态**: ✅ 已完成

---

## 🐛 问题描述

**现象**:
- 玩家转人工时，即使没有在线客服，系统仍然显示"已为您排队，当前位于第X位，预计等待约X分钟"
- 玩家看到排队信息，但实际上没有客服在线，无法接入

**根本原因**:
1. 后端`transferToAgent`方法中，即使没有在线客服，仍然将会话状态设置为`QUEUED`（排队）
2. 前端没有检查是否有在线客服，直接显示排队信息
3. 缺少"无在线客服时转为加急工单"的业务逻辑

---

## ✅ 修复方案

### 1. 后端修复 (`backend/src/session/session.service.ts`)

#### 修复前
```typescript
// 问题：即使没有在线客服，也设置为QUEUED状态
const session = await this.prisma.session.update({
  where: { id: sessionId },
  data: {
    status: 'QUEUED', // ❌ 没有在线客服时不应该排队
    // ...
  },
});

if (noAgentsOnline) {
  // 只是发送系统消息，但状态仍然是QUEUED
  await this.messageService.createSystemMessage(...);
}
```

#### 修复后
```typescript
if (noAgentsOnline) {
  // 没有在线客服：关闭会话，转为加急工单
  // 1. 更新工单为加急状态
  await this.ticketService.updateStatus(session.ticketId, 'WAITING');
  await this.prisma.ticket.update({
    where: { id: session.ticketId },
    data: {
      priority: 'URGENT',
      priorityScore: Math.max(priorityScore, 80), // 至少80分
    },
  });

  // 2. 关闭会话（不进入排队）
  await this.prisma.session.update({
    where: { id: sessionId },
    data: {
      status: 'CLOSED', // ✅ 关闭会话
      closedAt: new Date(),
      // ...
    },
  });

  // 3. 创建系统消息告知玩家
  await this.messageService.createSystemMessage(
    sessionId,
    `当前暂无客服在线，您的问题已转为【加急工单】(${ticket.ticketNo})，我们将优先处理。`,
  );

  return {
    queued: false,
    convertedToTicket: true, // ✅ 标记已转为工单
    ticketNo: ticket.ticketNo,
    message: '当前暂无客服在线，您的问题已转为【加急工单】，我们将优先处理。',
  };
}
```

**关键改动**:
- ✅ 无在线客服时，会话状态设置为`CLOSED`，不进入排队
- ✅ 工单优先级提升为`URGENT`，优先级分数至少80
- ✅ 返回`convertedToTicket: true`标记，告知前端已转为工单

---

### 2. 前端修复 - Chat页面 (`player-app/src/pages/Chat/index.tsx`)

#### 修复1: 处理转为工单的情况
```typescript
// 处理没有在线客服的情况：转为加急工单
if (result.convertedToTicket) {
  Modal.info({
    title: '当前无客服在线',
    content: (
      <div>
        <p>{result.message}</p>
        {result.ticketNo && (
          <p style={{ marginTop: 8, fontWeight: 'bold' }}>
            工单号：{result.ticketNo}
          </p>
        )}
        <p style={{ marginTop: 8, color: '#666' }}>
          您可以通过工单号查看处理进度，客服上线后会优先处理。
        </p>
      </div>
    ),
    okText: result.ticketNo ? '查看工单' : '知道了',
    onOk: () => {
      if (result.ticketNo && ticketToken) {
        navigate(`/ticket/${ticketToken}`);
      }
    },
  });
  
  // 更新会话状态为已关闭
  updateSession({ 
    status: 'CLOSED',
    queuePosition: null,
    estimatedWaitTime: null,
  });
  return;
}
```

#### 修复2: 优化排队信息显示判断
```typescript
// 修复前
const isQueued = session?.status === 'QUEUED';

// 修复后：只有在有排队位置的情况下才显示排队信息
const isQueued = session?.status === 'QUEUED' && 
  (session?.queuePosition !== null && session?.queuePosition !== undefined);
```

**关键改动**:
- ✅ 检查`convertedToTicket`标记，显示工单提示
- ✅ 只有真正在排队（有queuePosition）时才显示排队信息
- ✅ 会话关闭后，不显示排队信息

---

### 3. 前端修复 - Queue页面 (`player-app/src/pages/Queue/index.tsx`)

#### 修复: 检查会话状态，显示相应提示
```typescript
// 如果会话已关闭（转为工单），显示工单提示
if (session.status === 'CLOSED') {
  return (
    <div className="page-container">
      <Card className="page-card fade-in-up" style={{ textAlign: 'center' }}>
        <Alert
          message="当前无客服在线"
          description={
            <div>
              <p>您的问题已转为【加急工单】，我们将优先处理。</p>
              {ticketNo && (
                <p style={{ marginTop: 8, fontWeight: 'bold' }}>
                  工单号：{ticketNo}
                </p>
              )}
              <p style={{ marginTop: 8, color: '#666' }}>
                客服上线后会第一时间处理，您可以通过工单号查看处理进度。
              </p>
            </div>
          }
          type="info"
          showIcon
        />
        {ticketToken && (
          <Button
            type="primary"
            onClick={() => navigate(`/ticket/${ticketToken}`)}
          >
            查看工单详情
          </Button>
        )}
      </Card>
    </div>
  );
}

// 正常排队状态：显示排队位置
return (
  <Card>
    <Title level={3}>正在为您转接人工客服</Title>
    {session.queuePosition && session.queuePosition > 0 && (
      <Paragraph>
        当前排队位置: <strong>第 {session.queuePosition} 位</strong>
      </Paragraph>
    )}
  </Card>
);
```

**关键改动**:
- ✅ 检查会话状态，如果已关闭则显示工单提示
- ✅ 只有有排队位置时才显示排队信息
- ✅ 提供跳转到工单页面的按钮

---

### 4. 类型定义更新 (`player-app/src/services/session.service.ts`)

```typescript
export interface TransferResult {
  queued: boolean;
  queuePosition?: number | null;
  estimatedWaitTime?: number | null;
  message?: string;
  ticketNo?: string;
  convertedToTicket?: boolean; // ✅ 新增：是否已转为工单
  onlineAgents?: number; // ✅ 新增：在线客服数量
}
```

---

## 🔄 业务流程对比

### 修复前（错误流程）
```
玩家转人工
  ↓
检查在线客服（无）
  ↓
会话状态：QUEUED ❌
  ↓
显示排队信息："第1位，预计等待5分钟" ❌
  ↓
玩家等待，但无客服接入 ❌
```

### 修复后（正确流程）
```
玩家转人工
  ↓
检查在线客服（无）
  ↓
会话状态：CLOSED ✅
工单优先级：URGENT ✅
  ↓
显示提示："已转为加急工单，工单号：T-xxx" ✅
  ↓
玩家可通过工单号查看进度 ✅
```

---

## ✅ 修复验证

### 测试场景1: 无在线客服时转人工
1. 确保无在线客服（所有客服下线）
2. 玩家在聊天页面点击"转人工"
3. **预期结果**:
   - ✅ 显示弹窗："当前无客服在线，您的问题已转为【加急工单】"
   - ✅ 显示工单号
   - ✅ 会话状态为CLOSED
   - ✅ 不显示排队信息
   - ✅ 可以跳转到工单页面

### 测试场景2: 有在线客服时转人工
1. 确保有在线客服
2. 玩家在聊天页面点击"转人工"
3. **预期结果**:
   - ✅ 显示排队信息："已为您排队，当前位于第X位"
   - ✅ 会话状态为QUEUED
   - ✅ 显示排队位置和预计等待时间

### 测试场景3: 排队页面显示
1. 无在线客服时，玩家进入排队页面
2. **预期结果**:
   - ✅ 显示"当前无客服在线"提示
   - ✅ 显示工单号
   - ✅ 提供"查看工单详情"按钮
   - ✅ 不显示排队位置

---

## 📝 相关文件

### 后端
- `backend/src/session/session.service.ts` - 转人工逻辑修复
- `backend/src/ticket/ticket.service.ts` - 工单状态更新

### 前端
- `player-app/src/pages/Chat/index.tsx` - 聊天页面逻辑修复
- `player-app/src/pages/Queue/index.tsx` - 排队页面逻辑修复
- `player-app/src/services/session.service.ts` - 类型定义更新

---

## 🎯 业务逻辑总结

### 核心原则
1. **有在线客服** → 进入排队 → 显示排队位置 → 等待客服接入
2. **无在线客服** → 转为加急工单 → 关闭会话 → 显示工单提示

### 状态流转
```
PENDING (AI交互中)
  ↓ [转人工]
  ├─ 有在线客服 → QUEUED (排队中) → IN_PROGRESS (客服接入)
  └─ 无在线客服 → CLOSED (已关闭，转为工单)
```

---

## ⚠️ 注意事项

1. **工单优先级**: 无在线客服时，工单优先级自动提升为URGENT，优先级分数至少80
2. **会话状态**: 无在线客服时，会话状态为CLOSED，不再进入排队
3. **前端显示**: 只有`status === 'QUEUED'`且`queuePosition !== null`时才显示排队信息
4. **用户体验**: 明确告知玩家当前状态，提供工单号便于查询

---

**修复完成**

*修复后，系统将正确区分"有在线客服"和"无在线客服"两种情况，提供准确的用户提示。*

