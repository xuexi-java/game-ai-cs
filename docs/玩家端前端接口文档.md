# 玩家端前端接口文档

## 基础信息

- **API Base URL**: `http://localhost:3000/api/v1`
- **WebSocket URL**: `ws://localhost:3000`
- **认证方式**: 玩家端接口无需认证（使用 `@Public()` 装饰器）

## 目录

1. [游戏相关接口](#游戏相关接口)
2. [工单相关接口](#工单相关接口)
3. [会话相关接口](#会话相关接口)
4. [消息相关接口](#消息相关接口)
5. [满意度评价接口](#满意度评价接口)
6. [文件上传接口](#文件上传接口)
7. [WebSocket 接口](#websocket-接口)

---

## 游戏相关接口

### 获取已启用的游戏列表

**接口地址**: `GET /games/enabled`

**请求参数**: 无

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": "game-1",
      "name": "弹弹堂",
      "icon": "https://example.com/icon.png",
      "enabled": true
    },
    {
      "id": "game-2", 
      "name": "神曲",
      "icon": "https://example.com/icon2.png",
      "enabled": true
    }
  ]
}
```

---

## 工单相关接口

### 检查未关闭工单

**接口地址**: `POST /tickets/check-open`

**请求参数**:
```json
{
  "gameId": "game-1",
  "serverId": "server-1", // 可选
  "playerIdOrName": "玩家123"
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "hasOpenTicket": true,
    "ticket": {
      "id": "ticket-123",
      "ticketNo": "T202411150001",
      "token": "abc123def456",
      "status": "OPEN"
    }
  }
}
```

### 创建工单

**接口地址**: `POST /tickets`

**请求参数**:
```json
{
  "gameId": "game-1",
  "serverId": "server-1", // 可选
  "serverName": "一区", // 可选
  "playerIdOrName": "玩家123",
  "description": "游戏中遇到的问题描述",
  "occurredAt": "2024-11-15T10:30:00Z", // 可选，问题发生时间
  "paymentOrderNo": "PAY123456789" // 可选，充值订单号
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "ticket-123",
    "ticketNo": "T202411150001",
    "token": "abc123def456",
    "status": "OPEN",
    "createdAt": "2024-11-15T10:30:00Z"
  }
}
```

### 根据Token获取工单

**接口地址**: `GET /tickets/by-token/:token`

**路径参数**:
- `token`: 工单访问令牌

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "ticket-123",
    "ticketNo": "T202411150001",
    "status": "OPEN",
    "description": "问题描述",
    "game": {
      "id": "game-1",
      "name": "弹弹堂"
    },
    "server": {
      "id": "server-1",
      "name": "一区"
    },
    "playerIdOrName": "玩家123",
    "createdAt": "2024-11-15T10:30:00Z"
  }
}
```

---

## 会话相关接口

### 创建会话

**接口地址**: `POST /sessions`

**请求参数**:
```json
{
  "ticketId": "ticket-123"
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "session-123",
    "ticketId": "ticket-123",
    "status": "PENDING",
    "detectedIntent": "技术问题",
    "aiUrgency": "NON_URGENT",
    "priorityScore": 50.5,
    "createdAt": "2024-11-15T10:30:00Z",
    "ticket": {
      "id": "ticket-123",
      "ticketNo": "T202411150001",
      "game": {
        "id": "game-1",
        "name": "弹弹堂"
      },
      "server": {
        "id": "server-1", 
        "name": "一区"
      },
      "playerIdOrName": "玩家123",
      "description": "问题描述"
    }
  }
}
```

### 获取会话详情

**接口地址**: `GET /sessions/:id`

**路径参数**:
- `id`: 会话ID

**响应示例**:
```json
{
  "code": 200,
  "message": "success", 
  "data": {
    "id": "session-123",
    "ticketId": "ticket-123",
    "status": "IN_PROGRESS",
    "agentId": "agent-456",
    "messages": [
      {
        "id": "msg-1",
        "sessionId": "session-123",
        "senderType": "PLAYER",
        "messageType": "TEXT",
        "content": "你好，我遇到了问题",
        "createdAt": "2024-11-15T10:31:00Z"
      }
    ]
  }
}
```

### 转人工客服

**接口地址**: `POST /sessions/:id/transfer-to-agent`

**路径参数**:
- `id`: 会话ID

**请求参数**:
```json
{
  "urgency": "URGENT" // 或 "NON_URGENT"
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "session-123",
    "status": "QUEUED",
    "queuedAt": "2024-11-15T10:35:00Z",
    "priorityScore": 75.0
  }
}
```

---

## 消息相关接口

### 发送玩家消息

**接口地址**: `POST /messages`

**请求参数**:
```json
{
  "sessionId": "session-123",
  "content": "我的问题是...",
  "messageType": "TEXT" // 可选，默认为 TEXT
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "msg-123",
    "sessionId": "session-123",
    "senderType": "PLAYER",
    "messageType": "TEXT",
    "content": "我的问题是...",
    "createdAt": "2024-11-15T10:32:00Z"
  }
}
```

### 获取会话消息列表

**接口地址**: `GET /messages/session/:sessionId`

**路径参数**:
- `sessionId`: 会话ID

**查询参数**:
- `limit`: 消息数量限制（可选）

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": "msg-1",
      "sessionId": "session-123",
      "senderType": "PLAYER",
      "messageType": "TEXT",
      "content": "你好",
      "createdAt": "2024-11-15T10:31:00Z"
    },
    {
      "id": "msg-2",
      "sessionId": "session-123", 
      "senderType": "AI",
      "messageType": "TEXT",
      "content": "您好！我是AI助手，请问有什么可以帮助您的？",
      "metadata": {
        "suggestedOptions": [
          "账号问题",
          "充值问题", 
          "游戏bug",
          "其他问题"
        ]
      },
      "createdAt": "2024-11-15T10:31:05Z"
    }
  ]
}
```

---

## 满意度评价接口

### 提交满意度评价

**接口地址**: `POST /satisfaction`

**请求参数**:
```json
{
  "sessionId": "session-123",
  "rating": 5, // 1-5分
  "comment": "服务很好，问题解决了" // 可选
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "rating-123",
    "sessionId": "session-123",
    "rating": 5,
    "comment": "服务很好，问题解决了",
    "createdAt": "2024-11-15T11:00:00Z"
  }
}
```

### 获取会话评价

**接口地址**: `GET /satisfaction/session/:sessionId`

**路径参数**:
- `sessionId`: 会话ID

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "rating-123",
    "sessionId": "session-123",
    "rating": 5,
    "comment": "服务很好，问题解决了",
    "createdAt": "2024-11-15T11:00:00Z"
  }
}
```

---

## 文件上传接口

### 上传工单附件

**接口地址**: `POST /upload/ticket-attachment`

**请求方式**: `multipart/form-data`

**请求参数**:
- `file`: 文件对象
- `ticketId`: 工单ID
- `sortOrder`: 排序顺序（可选）

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "attachment-123",
    "ticketId": "ticket-123",
    "fileUrl": "https://oss.example.com/attachments/file.jpg",
    "fileName": "screenshot.jpg",
    "fileType": "image/jpeg",
    "fileSize": 1024000,
    "sortOrder": 0,
    "createdAt": "2024-11-15T10:33:00Z"
  }
}
```

---

## WebSocket 接口

### 连接信息

**连接地址**: `ws://localhost:3000`

**连接方式**: 玩家端无需认证，直接连接

### 事件列表

#### 1. 加入会话房间

**发送事件**: `join-session`

**数据格式**:
```json
{
  "sessionId": "session-123"
}
```

**响应**:
```json
{
  "success": true
}
```

#### 2. 离开会话房间

**发送事件**: `leave-session`

**数据格式**:
```json
{
  "sessionId": "session-123"
}
```

#### 3. 发送消息

**发送事件**: `send-message`

**数据格式**:
```json
{
  "sessionId": "session-123",
  "content": "消息内容"
}
```

**响应**:
```json
{
  "success": true,
  "messageId": "msg-123"
}
```

#### 4. 接收消息

**监听事件**: `session:${sessionId}:message`

**数据格式**:
```json
{
  "id": "msg-123",
  "sessionId": "session-123",
  "senderType": "AI", // PLAYER, AI, AGENT, SYSTEM
  "messageType": "TEXT",
  "content": "AI回复的消息",
  "metadata": {
    "suggestedOptions": ["选项1", "选项2"]
  },
  "createdAt": "2024-11-15T10:32:00Z"
}
```

#### 5. 会话状态更新

**监听事件**: `session-update`

**数据格式**:
```json
{
  "sessionId": "session-123",
  "status": "IN_PROGRESS",
  "agentId": "agent-456",
  "updatedAt": "2024-11-15T10:35:00Z"
}
```

#### 6. 队列状态更新

**监听事件**: `queue-update`

**数据格式**:
```json
{
  "position": 3, // 队列位置
  "waitTime": 180 // 预计等待时间（秒）
}
```

---

## 错误码说明

| 错误码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

## 数据类型说明

### 会话状态 (SessionStatus)
- `PENDING`: 等待中（AI处理阶段）
- `QUEUED`: 排队中（等待人工客服）
- `IN_PROGRESS`: 进行中（人工客服已接入）
- `CLOSED`: 已关闭

### 消息发送者类型 (SenderType)
- `PLAYER`: 玩家
- `AI`: AI助手
- `AGENT`: 人工客服
- `SYSTEM`: 系统通知

### 消息类型 (MessageType)
- `TEXT`: 文本消息
- `IMAGE`: 图片消息
- `SYSTEM_NOTICE`: 系统通知
- `QUICK_OPTION`: 快捷选项

### 紧急程度 (Urgency)
- `URGENT`: 紧急
- `NON_URGENT`: 非紧急

---

## 使用示例

### 完整的客服流程示例

```javascript
// 1. 获取游戏列表
const games = await fetch('/api/v1/games/enabled').then(r => r.json());

// 2. 检查未关闭工单
const checkResult = await fetch('/api/v1/tickets/check-open', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    gameId: 'game-1',
    playerIdOrName: '玩家123'
  })
}).then(r => r.json());

// 3. 创建新工单（如果没有未关闭的）
const ticket = await fetch('/api/v1/tickets', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    gameId: 'game-1',
    playerIdOrName: '玩家123',
    description: '遇到的问题描述'
  })
}).then(r => r.json());

// 4. 创建会话
const session = await fetch('/api/v1/sessions', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    ticketId: ticket.data.id
  })
}).then(r => r.json());

// 5. 连接WebSocket
const socket = io('ws://localhost:3000');

// 6. 加入会话房间
socket.emit('join-session', { sessionId: session.data.id });

// 7. 监听消息
socket.on(`session:${session.data.id}:message`, (message) => {
  console.log('收到消息:', message);
});

// 8. 发送消息
socket.emit('send-message', {
  sessionId: session.data.id,
  content: '你好，我需要帮助'
});

// 9. 转人工客服（如需要）
await fetch(`/api/v1/sessions/${session.data.id}/transfer-to-agent`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    urgency: 'NON_URGENT'
  })
});
```

---

## 注意事项

1. **无需认证**: 玩家端所有接口都无需认证
2. **CORS配置**: 后端已配置允许 `localhost:5173` 和 `localhost:5174` 访问
3. **WebSocket连接**: 玩家端连接WebSocket无需token
4. **文件上传**: 支持图片格式，最大10MB
5. **消息实时性**: 使用WebSocket确保消息实时推送
6. **错误处理**: 所有接口都有统一的错误响应格式
