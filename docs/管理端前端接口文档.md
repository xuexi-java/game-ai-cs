# 管理端前端接口文档

## 基础信息

- **API Base URL**: `http://localhost:3000/api/v1`
- **WebSocket URL**: `ws://localhost:3000`
- **认证方式**: JWT Token（Bearer Token）
- **权限要求**: 需要 `ADMIN` 或 `AGENT` 角色

## 目录

1. [认证相关接口](#认证相关接口)
2. [仪表盘接口](#仪表盘接口)
3. [游戏管理接口](#游戏管理接口)
4. [工单管理接口](#工单管理接口)
5. [会话管理接口](#会话管理接口)
6. [消息管理接口](#消息管理接口)
7. [满意度统计接口](#满意度统计接口)
8. [紧急规则管理接口](#紧急规则管理接口)
9. [WebSocket 接口](#websocket-接口)

---

## 认证相关接口

### 管理员登录

**接口地址**: `POST /auth/login`

**请求参数**:
```json
{
  "username": "admin",
  "password": "password123"
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": "user-123",
      "username": "admin",
      "role": "ADMIN",
      "isOnline": true
    }
  }
}
```

**请求头设置**:
```javascript
// 登录成功后，所有后续请求需要携带token
headers: {
  'Authorization': `Bearer ${accessToken}`,
  'Content-Type': 'application/json'
}
```

---

## 仪表盘接口

### 获取仪表盘指标

**接口地址**: `GET /dashboard/metrics`

**权限要求**: `ADMIN`

**查询参数**:
- `gameId`: 游戏ID（可选）
- `startDate`: 开始日期（可选）
- `endDate`: 结束日期（可选）

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "totalTickets": 1250,
    "openTickets": 45,
    "closedTickets": 1205,
    "averageResponseTime": 120, // 秒
    "averageResolutionTime": 1800, // 秒
    "satisfactionRating": 4.2,
    "agentStats": [
      {
        "agentId": "agent-1",
        "agentName": "张三",
        "handledTickets": 50,
        "averageRating": 4.5,
        "isOnline": true
      }
    ],
    "dailyStats": [
      {
        "date": "2024-11-15",
        "tickets": 25,
        "resolved": 23,
        "avgSatisfaction": 4.3
      }
    ]
  }
}
```

---

## 游戏管理接口

### 获取所有游戏

**接口地址**: `GET /games`

**权限要求**: `ADMIN`

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": "game-1",
      "name": "弹弹堂",
      "icon": "https://example.com/icon.png",
      "enabled": true,
      "difyApiKey": "dify-key-123",
      "difyBaseUrl": "https://api.dify.ai",
      "createdAt": "2024-11-15T10:00:00Z"
    }
  ]
}
```

### 创建游戏

**接口地址**: `POST /games`

**权限要求**: `ADMIN`

**请求参数**:
```json
{
  "name": "新游戏",
  "icon": "https://example.com/icon.png",
  "enabled": true,
  "difyApiKey": "dify-key-456",
  "difyBaseUrl": "https://api.dify.ai"
}
```

### 更新游戏

**接口地址**: `PATCH /games/:id`

**权限要求**: `ADMIN`

**请求参数**:
```json
{
  "name": "更新后的游戏名",
  "enabled": false
}
```

### 删除游戏

**接口地址**: `DELETE /games/:id`

**权限要求**: `ADMIN`

### 获取游戏的服务器列表

**接口地址**: `GET /games/:gameId/servers`

**权限要求**: `ADMIN`

### 创建服务器

**接口地址**: `POST /games/:gameId/servers`

**权限要求**: `ADMIN`

**请求参数**:
```json
{
  "name": "一区",
  "description": "服务器描述",
  "enabled": true
}
```

---

## 工单管理接口

### 获取工单列表

**接口地址**: `GET /tickets`

**权限要求**: `ADMIN` 或 `AGENT`

**查询参数**:
- `status`: 工单状态（可选）
- `priority`: 优先级（可选）
- `gameId`: 游戏ID（可选）
- `page`: 页码（默认1）
- `pageSize`: 每页数量（默认10）
- `sortBy`: 排序字段（默认createdAt）
- `sortOrder`: 排序方向（默认desc）

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [
      {
        "id": "ticket-123",
        "ticketNo": "T202411150001",
        "status": "OPEN",
        "priority": "HIGH",
        "game": {
          "id": "game-1",
          "name": "弹弹堂"
        },
        "server": {
          "id": "server-1",
          "name": "一区"
        },
        "playerIdOrName": "玩家123",
        "description": "问题描述",
        "createdAt": "2024-11-15T10:30:00Z",
        "updatedAt": "2024-11-15T10:35:00Z"
      }
    ],
    "total": 100,
    "page": 1,
    "pageSize": 10,
    "totalPages": 10
  }
}
```

### 获取工单详情

**接口地址**: `GET /tickets/:id`

**权限要求**: `ADMIN` 或 `AGENT`

### 更新工单状态

**接口地址**: `PATCH /tickets/:id/status`

**权限要求**: `ADMIN` 或 `AGENT`

**请求参数**:
```json
{
  "status": "CLOSED"
}
```

### 更新工单优先级

**接口地址**: `PATCH /tickets/:id/priority`

**权限要求**: `ADMIN` 或 `AGENT`

**请求参数**:
```json
{
  "priority": "HIGH"
}
```

---

## 会话管理接口

### 获取待接入会话列表

**接口地址**: `GET /sessions/workbench/queued`

**权限要求**: `ADMIN` 或 `AGENT`

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": "session-123",
      "ticketId": "ticket-123",
      "status": "QUEUED",
      "priorityScore": 75.5,
      "queuedAt": "2024-11-15T10:35:00Z",
      "waitTime": 180,
      "ticket": {
        "ticketNo": "T202411150001",
        "game": {
          "name": "弹弹堂"
        },
        "playerIdOrName": "玩家123",
        "description": "问题描述"
      }
    }
  ]
}
```

### 客服接入会话

**接口地址**: `POST /sessions/:id/join`

**权限要求**: `ADMIN` 或 `AGENT`

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "session-123",
    "status": "IN_PROGRESS",
    "agentId": "agent-456",
    "joinedAt": "2024-11-15T10:40:00Z"
  }
}
```

### 结束会话

**接口地址**: `PATCH /sessions/:id/close`

**权限要求**: `ADMIN` 或 `AGENT`

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "session-123",
    "status": "CLOSED",
    "closedAt": "2024-11-15T11:00:00Z"
  }
}
```

---

## 消息管理接口

### 客服发送消息

**接口地址**: `POST /messages/agent`

**权限要求**: `ADMIN` 或 `AGENT`

**请求参数**:
```json
{
  "sessionId": "session-123",
  "content": "客服回复的消息",
  "messageType": "TEXT"
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "msg-456",
    "sessionId": "session-123",
    "senderType": "AGENT",
    "messageType": "TEXT",
    "content": "客服回复的消息",
    "agentId": "agent-456",
    "createdAt": "2024-11-15T10:45:00Z"
  }
}
```

---

## 满意度统计接口

### 获取客服评价统计

**接口地址**: `GET /satisfaction/agent/:agentId/stats`

**权限要求**: `ADMIN` 或 `AGENT`

**查询参数**:
- `startDate`: 开始日期（可选）
- `endDate`: 结束日期（可选）

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "agentId": "agent-456",
    "totalRatings": 50,
    "averageRating": 4.2,
    "ratingDistribution": {
      "1": 2,
      "2": 3,
      "3": 8,
      "4": 15,
      "5": 22
    },
    "recentRatings": [
      {
        "id": "rating-123",
        "sessionId": "session-123",
        "rating": 5,
        "comment": "服务很好",
        "createdAt": "2024-11-15T11:00:00Z"
      }
    ]
  }
}
```

---

## 紧急规则管理接口

### 获取所有紧急规则

**接口地址**: `GET /urgency-rules`

**权限要求**: `ADMIN`

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": "rule-1",
      "name": "充值问题高优先级",
      "enabled": true,
      "priority": 1,
      "conditions": {
        "keywords": ["充值", "付费", "扣款"],
        "gameIds": ["game-1"],
        "priority": "HIGH"
      },
      "actions": {
        "urgencyLevel": "URGENT",
        "priorityBoost": 50,
        "autoAssignAgent": true
      },
      "createdAt": "2024-11-15T09:00:00Z"
    }
  ]
}
```

### 创建紧急规则

**接口地址**: `POST /urgency-rules`

**权限要求**: `ADMIN`

**请求参数**:
```json
{
  "name": "新规则",
  "enabled": true,
  "priority": 2,
  "conditions": {
    "keywords": ["bug", "卡死"],
    "gameIds": ["game-1", "game-2"]
  },
  "actions": {
    "urgencyLevel": "URGENT",
    "priorityBoost": 30
  }
}
```

### 更新紧急规则

**接口地址**: `PATCH /urgency-rules/:id`

**权限要求**: `ADMIN`

### 删除紧急规则

**接口地址**: `DELETE /urgency-rules/:id`

**权限要求**: `ADMIN`

### 重新计算队列

**接口地址**: `POST /urgency-rules/recalculate-queue`

**权限要求**: `ADMIN`

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "affectedSessions": 15,
    "recalculatedAt": "2024-11-15T11:30:00Z"
  }
}
```

---

## WebSocket 接口

### 连接信息

**连接地址**: `ws://localhost:3000`

**认证方式**: 在连接时传递JWT token

```javascript
const socket = io('ws://localhost:3000', {
  auth: {
    token: 'your-jwt-token'
  }
});
```

### 事件列表

#### 1. 客服发送消息

**发送事件**: `agent:send-message`

**数据格式**:
```json
{
  "sessionId": "session-123",
  "content": "客服回复内容"
}
```

**响应**:
```json
{
  "success": true,
  "messageId": "msg-456"
}
```

#### 2. 接收新消息

**监听事件**: `session:${sessionId}:message`

**数据格式**:
```json
{
  "id": "msg-123",
  "sessionId": "session-123",
  "senderType": "PLAYER",
  "messageType": "TEXT",
  "content": "玩家发送的消息",
  "createdAt": "2024-11-15T10:32:00Z"
}
```

#### 3. 新会话通知

**监听事件**: `new-session`

**数据格式**:
```json
{
  "id": "session-456",
  "ticketId": "ticket-456",
  "status": "QUEUED",
  "priorityScore": 60.0,
  "ticket": {
    "ticketNo": "T202411150002",
    "game": {
      "name": "神曲"
    },
    "playerIdOrName": "玩家456",
    "description": "新的问题"
  }
}
```

#### 4. 会话状态更新

**监听事件**: `session-update`

**数据格式**:
```json
{
  "sessionId": "session-123",
  "status": "IN_PROGRESS",
  "agentId": "agent-456",
  "updatedAt": "2024-11-15T10:40:00Z"
}
```

---

## 权限说明

### 角色权限

| 接口分类 | ADMIN | AGENT |
|----------|-------|-------|
| 认证接口 | ✅ | ✅ |
| 仪表盘 | ✅ | ❌ |
| 游戏管理 | ✅ | ❌ |
| 工单管理 | ✅ | ✅ |
| 会话管理 | ✅ | ✅ |
| 消息管理 | ✅ | ✅ |
| 满意度统计 | ✅ | ✅（仅自己的） |
| 紧急规则 | ✅ | ❌ |

---

## 错误码说明

| 错误码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未认证 |
| 403 | 权限不足 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

---

## 使用示例

### 管理端完整工作流程

```javascript
// 1. 登录获取token
const loginResponse = await fetch('/api/v1/auth/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    username: 'admin',
    password: 'password123'
  })
});
const { data: { accessToken } } = await loginResponse.json();

// 2. 设置请求头
const headers = {
  'Authorization': `Bearer ${accessToken}`,
  'Content-Type': 'application/json'
};

// 3. 获取仪表盘数据
const dashboard = await fetch('/api/v1/dashboard/metrics', { headers })
  .then(r => r.json());

// 4. 获取待接入会话列表
const queuedSessions = await fetch('/api/v1/sessions/workbench/queued', { headers })
  .then(r => r.json());

// 5. 连接WebSocket
const socket = io('ws://localhost:3000', {
  auth: { token: accessToken }
});

// 6. 监听新会话
socket.on('new-session', (session) => {
  console.log('新会话:', session);
  // 更新UI显示新会话
});

// 7. 客服接入会话
const sessionId = 'session-123';
await fetch(`/api/v1/sessions/${sessionId}/join`, {
  method: 'POST',
  headers
});

// 8. 监听该会话的消息
socket.on(`session:${sessionId}:message`, (message) => {
  console.log('收到消息:', message);
});

// 9. 客服发送回复
socket.emit('agent:send-message', {
  sessionId: sessionId,
  content: '您好，我是客服，请问有什么可以帮助您的？'
});

// 10. 结束会话
await fetch(`/api/v1/sessions/${sessionId}/close`, {
  method: 'PATCH',
  headers
});
```

### 工单管理示例

```javascript
// 获取工单列表（带筛选和分页）
const tickets = await fetch('/api/v1/tickets?' + new URLSearchParams({
  status: 'OPEN',
  gameId: 'game-1',
  page: '1',
  pageSize: '20',
  sortBy: 'createdAt',
  sortOrder: 'desc'
}), { headers }).then(r => r.json());

// 更新工单状态
await fetch(`/api/v1/tickets/${ticketId}/status`, {
  method: 'PATCH',
  headers,
  body: JSON.stringify({ status: 'CLOSED' })
});

// 更新工单优先级
await fetch(`/api/v1/tickets/${ticketId}/priority`, {
  method: 'PATCH',
  headers,
  body: JSON.stringify({ priority: 'HIGH' })
});
```

---

## 注意事项

1. **认证要求**: 所有管理端接口都需要JWT认证
2. **权限控制**: 不同角色有不同的接口访问权限
3. **WebSocket认证**: WebSocket连接也需要传递token
4. **在线状态**: 客服连接WebSocket时会自动更新在线状态
5. **实时通知**: 使用WebSocket接收新会话和消息通知
6. **分页查询**: 列表接口支持分页、排序和筛选
7. **错误处理**: 需要处理401（未认证）和403（权限不足）错误
