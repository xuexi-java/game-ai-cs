# 客服系统远程模式测试用例

> 本文档定义客服系统远程模式改造后的测试用例，确保各平台接入功能正常。

---

## 一、测试环境

### 1.1 测试平台

| 平台 | 测试设备 | 系统版本 |
|-----|---------|---------|
| Android | 真机 + 模拟器 | Android 8.0+ |
| iOS | 真机 + 模拟器 | iOS 12.0+ |
| 微信小程序 | 开发者工具 + 真机 | 基础库 2.0+ |
| Flash/网页 | Chrome/Firefox/Safari | 最新稳定版 |

### 1.2 测试账号

| 类型 | 账号 | 说明 |
|-----|------|------|
| 普通玩家 | uid=player_001, level=10 | 测试 AI 机器人流程 |
| 中级玩家 | uid=player_002, level=30 | 测试转人工入口 |
| VIP 玩家 | uid=player_003, level=60 | 测试直接人工流程 |
| 管理员 | admin / admin123 | 后台管理 |
| 客服 | agent1 / agent123 | 人工客服 |

### 1.3 测试游戏配置

```
gameid: com.test.cswebview
nonce: test_nonce_123
secret: test_secret_key_456
csApiUrl: https://cs-test.example.com
```

---

## 二、环境检测测试

### TC-ENV-001: Android Bridge 环境检测

**前置条件**: Android WebView 中打开 H5

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | H5 页面加载 | 页面正常显示 |
| 2 | 检测 `window.AndroidBridge` | 返回对象，非 undefined |
| 3 | H5 识别环境类型 | 环境类型为 `android` |

---

### TC-ENV-002: iOS Bridge 环境检测

**前置条件**: iOS WKWebView 中打开 H5

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | H5 页面加载 | 页面正常显示 |
| 2 | 检测 `window.webkit?.messageHandlers?.iosBridge` | 返回对象，非 undefined |
| 3 | H5 识别环境类型 | 环境类型为 `ios` |

---

### TC-ENV-003: URL 参数模式检测

**前置条件**: 浏览器中通过 URL 参数打开 H5

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 访问带参数的 URL | `?gameid=xxx&uid=xxx&...` |
| 2 | 检测 URL 是否包含 gameid | 返回 true |
| 3 | H5 识别环境类型 | 环境类型为 `url` |

---

### TC-ENV-004: Mock 模式检测

**前置条件**: 开发环境，无 Bridge 无 URL 参数

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 本地开发服务器打开 H5 | 无 URL 参数 |
| 2 | 检测 Bridge 和 URL 参数 | 均不存在 |
| 3 | H5 识别环境类型 | 环境类型为 `mock` |
| 4 | 使用 Mock 数据 | 显示测试玩家信息 |

---

## 三、Bridge 接口测试（Android）

### TC-BRIDGE-AND-001: getPlayerInfo 获取玩家信息

**前置条件**: Android WebView 已注入 AndroidBridge

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 调用 `window.AndroidBridge.getPlayerInfo()` | 返回 JSON 字符串 |
| 2 | 解析返回值 | 包含 gameid, uid, areaid, nonce, sign |
| 3 | 验证字段完整性 | 所有必填字段非空 |

**返回值示例**:
```json
{
  "gameid": "com.test.cswebview",
  "uid": "player_001",
  "areaid": "1",
  "playerName": "测试玩家",
  "nonce": "test_nonce_123",
  "sign": "a1b2c3d4e5f6..."
}
```

---

### TC-BRIDGE-AND-002: close 关闭 WebView

**前置条件**: Android WebView 正常显示 H5

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | H5 显示关闭按钮 | 按钮可见 |
| 2 | 点击关闭按钮 | 调用 `window.AndroidBridge.close()` |
| 3 | WebView 关闭 | 返回游戏主界面 |

---

### TC-BRIDGE-AND-003: getPlayerInfo 返回空值处理

**前置条件**: Bridge 未正确实现或游戏服务器异常

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 调用 `getPlayerInfo()` | 返回空或 null |
| 2 | H5 错误处理 | 显示「获取玩家信息失败」提示 |
| 3 | 提供重试选项 | 显示重试按钮 |

---

## 四、Bridge 接口测试（iOS）

### TC-BRIDGE-IOS-001: getPlayerInfo 异步获取玩家信息

**前置条件**: iOS WKWebView 已注册 iosBridge Handler

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 调用 postMessage | `{ action: 'getPlayerInfo', callbackId: 'cb_001' }` |
| 2 | iOS 回调 | 调用 `window.__iosCallback('cb_001', jsonStr)` |
| 3 | H5 接收数据 | 正确解析玩家信息 |

---

### TC-BRIDGE-IOS-002: close 关闭 WKWebView

**前置条件**: iOS WKWebView 正常显示 H5

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 点击关闭按钮 | postMessage `{ action: 'close' }` |
| 2 | WKWebView 关闭 | 返回游戏主界面 |

---

### TC-BRIDGE-IOS-003: iOS 回调超时处理

**前置条件**: iOS 未响应回调

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 调用 getPlayerInfo | 等待 iOS 回调 |
| 2 | 5 秒无响应 | 触发超时 |
| 3 | H5 错误处理 | 显示「获取信息超时」提示 |

---

## 五、URL 参数模式测试

### TC-URL-001: 完整参数解析

**测试 URL**:
```
https://cs.example.com/webview?gameid=com.test.cswebview&uid=player_001&areaid=1&playerName=%E6%B5%8B%E8%AF%95&nonce=test_nonce_123&sign=a1b2c3d4&platform=wxapp
```

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 访问带完整参数的 URL | 页面正常加载 |
| 2 | 解析各参数 | gameid, uid, areaid, nonce, sign 正确 |
| 3 | 解码 playerName | 正确显示「测试」（URL 解码） |
| 4 | 识别 platform | platform = wxapp |

---

### TC-URL-002: 缺少必填参数

**测试 URL**（缺少 sign）:
```
https://cs.example.com/webview?gameid=com.test.cswebview&uid=player_001&areaid=1&nonce=test_nonce_123
```

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 访问缺少 sign 的 URL | 页面加载 |
| 2 | 参数校验 | 检测到缺少 sign |
| 3 | 错误提示 | 显示「参数不完整」提示 |

---

### TC-URL-003: 微信小程序关闭行为

**前置条件**: platform=wxapp

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | URL 包含 `platform=wxapp` | 识别为小程序环境 |
| 2 | 点击关闭按钮 | 调用 `wx.miniProgram.navigateBack()` |
| 3 | 返回小程序页面 | web-view 关闭 |

---

### TC-URL-004: iframe 关闭行为

**前置条件**: platform=iframe

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | URL 包含 `platform=iframe` | 识别为 iframe 环境 |
| 2 | 点击关闭按钮 | 调用 `parent.postMessage({ type: 'cs-close' }, '*')` |
| 3 | 父页面接收消息 | 父页面移除/隐藏 iframe |

---

### TC-URL-005: 网页弹窗关闭行为

**前置条件**: platform=web 或未指定

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | URL 包含 `platform=web` | 识别为网页弹窗 |
| 2 | 点击关闭按钮 | 调用 `window.close()` |
| 3 | 弹窗关闭 | 窗口关闭 |

---

## 六、签名验证测试

### TC-SIGN-001: 正确签名验证通过

**前置条件**: 使用正确的 secret 计算签名

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 游戏服务器计算签名 | `md5(gameid\|uid\|areaid\|nonce\|secret)` |
| 2 | H5 发送 /api/v1/player/connect | 携带 sign 参数 |
| 3 | 后端验证签名 | 验证通过 |
| 4 | 返回正常响应 | 返回 wsToken, questList 等 |

**签名计算示例**:
```
gameid  = "com.test.cswebview"
uid     = "player_001"
areaid  = "1"
nonce   = "test_nonce_123"
secret  = "test_secret_key_456"

拼接串 = "com.test.cswebview|player_001|1|test_nonce_123|test_secret_key_456"
sign   = md5(拼接串).toLowerCase()
```

---

### TC-SIGN-002: 错误签名拒绝

**前置条件**: 使用错误的 secret 或篡改参数

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 使用错误 sign 调用 API | sign 值不匹配 |
| 2 | 后端验证签名 | 验证失败 |
| 3 | 返回错误响应 | 状态码 401，错误信息「签名验证失败」 |
| 4 | H5 错误处理 | 显示认证失败提示 |

---

### TC-SIGN-003: 签名参数顺序验证

**前置条件**: 验证签名算法中参数顺序的重要性

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 使用正确顺序计算 | `gameid\|uid\|areaid\|nonce\|secret` |
| 2 | 验证通过 | 正常 |
| 3 | 使用错误顺序计算 | `uid\|gameid\|areaid\|nonce\|secret` |
| 4 | 验证失败 | 签名不匹配 |

---

## 七、Bootstrap 接口测试

### TC-BOOT-001: connect 接口正常响应

**接口**: POST /api/v1/player/connect

**请求体**:
```json
{
  "gameid": "com.test.cswebview",
  "uid": "player_001",
  "areaid": "1",
  "playerName": "测试玩家",
  "nonce": "test_nonce_123",
  "sign": "a1b2c3d4..."
}
```

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 发送 POST 请求 | 状态码 200 |
| 2 | 检查 wsToken | 非空字符串 |
| 3 | 检查 uploadToken | 非空字符串 |
| 4 | 检查 questList | 数组，包含问题分类 |
| 5 | 检查 activeTicket | null 或工单对象 |

**响应示例**:
```json
{
  "wsToken": "eyJhbGciOiJIUzI1NiIs...",
  "uploadToken": "upload_token_xxx",
  "questList": [
    { "id": "1", "name": "充值问题", "children": [...] }
  ],
  "activeTicket": null
}
```

---

### TC-BOOT-002: connect 接口 - 存在未关闭工单

**前置条件**: 玩家有未关闭的工单

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 发送 connect 请求 | 状态码 200 |
| 2 | 检查 activeTicket | 返回工单对象 |
| 3 | 工单包含历史消息 | messages 数组非空 |
| 4 | H5 自动恢复会话 | 显示历史聊天记录 |

---

### TC-BOOT-003: connect 接口 - gameid 未配置

**前置条件**: 使用未在后台配置的 gameid

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 使用未知 gameid 请求 | gameid=unknown.game |
| 2 | 后端校验 | 游戏不存在 |
| 3 | 返回错误 | 状态码 404，「游戏未配置」|

---

## 八、WebSocket 连接测试

### TC-WS-001: 正常建立连接

**前置条件**: 已获取有效 wsToken

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 使用 wsToken 连接 | `auth: { token: wsToken }` |
| 2 | 连接成功 | 收到 connect 事件 |
| 3 | 连接状态 | connected = true |

---

### TC-WS-002: 无效 Token 拒绝连接

**前置条件**: 使用过期或无效的 wsToken

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 使用无效 token 连接 | token = invalid_xxx |
| 2 | 服务器拒绝 | 连接失败 |
| 3 | 错误处理 | 提示重新获取 token |

---

### TC-WS-003: 单连接约束（踢旧连接）

**前置条件**: 同一玩家已有 WebSocket 连接

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 设备 A 已连接 | 连接正常 |
| 2 | 设备 B 使用同一 token 连接 | 新连接建立 |
| 3 | 设备 A 连接状态 | 收到断开事件 |
| 4 | 设备 A 提示 | 「您已在其他设备登录」|

---

### TC-WS-004: 断线重连

**前置条件**: 网络中断后恢复

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 正常连接中 | 连接状态正常 |
| 2 | 模拟网络断开 | 连接中断 |
| 3 | 网络恢复 | 自动尝试重连 |
| 4 | 重连成功 | 恢复会话状态 |

---

## 九、消息收发测试

### TC-MSG-001: 发送文本消息

**前置条件**: WebSocket 已连接，工单已创建

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 输入文本内容 | 「你好」|
| 2 | 点击发送 | emit `message:send` |
| 3 | 携带 clientMsgId | 唯一标识 |
| 4 | 收到 message:ack | 消息发送成功 |
| 5 | 消息显示 | 消息显示在聊天列表 |

**发送事件**:
```json
{
  "ticketId": "ticket_001",
  "content": "你好",
  "type": "text",
  "clientMsgId": "client_msg_uuid"
}
```

---

### TC-MSG-002: 消息幂等性验证

**前置条件**: 网络不稳定导致重发

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 发送消息 | clientMsgId = msg_001 |
| 2 | 未收到 ack，重发 | 相同 clientMsgId |
| 3 | 服务器处理 | 识别为重复消息 |
| 4 | 返回相同 ack | 不重复存储 |
| 5 | 聊天列表 | 只显示一条消息 |

---

### TC-MSG-003: 接收消息

**前置条件**: 客服或 AI 发送消息

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 服务器推送消息 | emit `message:receive` |
| 2 | H5 接收 | 解析消息内容 |
| 3 | 消息显示 | 显示在聊天列表左侧 |
| 4 | 消息类型 | 正确显示文本/图片/卡片 |

---

### TC-MSG-004: 发送图片消息

**前置条件**: WebSocket 已连接，有 uploadToken

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 选择图片 | 打开图片选择器 |
| 2 | 图片压缩 | maxWidth=1920, quality=0.8 |
| 3 | 上传图片 | POST /api/v1/player/upload |
| 4 | 携带 X-Upload-Token | Header 验证 |
| 5 | 返回图片 URL | 上传成功 |
| 6 | 发送图片消息 | 包含图片 URL |

---

## 十、工单流程测试

### TC-TICKET-001: 创建工单（AI 机器人）

**前置条件**: conversationIntent = BOT_SUPPORT

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 进入客服页面 | 显示问题分类列表 |
| 2 | 选择问题分类 | 如「充值问题」|
| 3 | 创建工单 | emit `ticket:create` |
| 4 | 收到 ticket:created | 工单创建成功 |
| 5 | AI 自动回复 | 显示 AI 引导消息 |

---

### TC-TICKET-002: 创建工单（直接人工）

**前置条件**: conversationIntent = HUMAN_SUPPORT

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 进入客服页面 | 跳过问题分类 |
| 2 | 直接创建人工工单 | type = human |
| 3 | 进入排队 | 显示排队提示 |
| 4 | 客服接入 | 收到 agent:assigned |
| 5 | 显示欢迎语 | welcomeMessage 内容 |

---

### TC-TICKET-003: 恢复未关闭工单

**前置条件**: 玩家有未关闭的工单

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | connect 返回 activeTicket | 工单信息 |
| 2 | 自动恢复 | emit `ticket:resume` |
| 3 | 加载历史消息 | 显示之前的聊天记录 |
| 4 | 继续会话 | 可正常发送消息 |

---

### TC-TICKET-004: 转人工客服

**前置条件**: 当前在 AI 机器人会话中

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 点击「转人工」按钮 | 按钮可见（alwaysShowHumanSupportButtonInBotPage=true）|
| 2 | 发起转人工请求 | emit `transfer:request` |
| 3 | 进入排队 | 显示排队位置 |
| 4 | 客服接入 | 收到 agent:assigned |
| 5 | 会话切换 | 切换到人工客服模式 |

---

## 十一、图片上传测试

### TC-UPLOAD-001: 正常上传图片

**前置条件**: 有效的 uploadToken

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 选择图片文件 | jpg/png/gif |
| 2 | 前端压缩 | 大于 1MB 时压缩 |
| 3 | 发起上传请求 | POST /api/v1/player/upload |
| 4 | Header 携带 token | X-Upload-Token: xxx |
| 5 | 上传成功 | 返回图片 URL |

---

### TC-UPLOAD-002: uploadToken 过期

**前置条件**: uploadToken 已过期（10分钟）

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 使用过期 token 上传 | X-Upload-Token 过期 |
| 2 | 返回 401 | token 无效 |
| 3 | 自动刷新 token | 重新获取 uploadToken |
| 4 | 重试上传 | 上传成功 |

---

### TC-UPLOAD-003: Android 图片选择

**前置条件**: Android WebView

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 点击添加图片 | 触发 `<input type="file">` |
| 2 | WebView 响应 | 打开系统图片选择器 |
| 3 | 选择图片 | 返回图片数据 |
| 4 | H5 接收 | 正确获取图片文件 |

---

### TC-UPLOAD-004: iOS 图片选择

**前置条件**: iOS WKWebView，已声明相册权限

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 点击添加图片 | 触发文件选择 |
| 2 | 权限请求 | 若未授权则请求 |
| 3 | 选择图片 | 返回图片数据 |
| 4 | HEIC 格式 | 自动转换为 JPEG |

---

## 十二、配置功能测试

### TC-CONFIG-001: 按用户等级分流 - 普通用户

**前置条件**: 用户等级 < 20

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 配置 conversationIntent=BOT_SUPPORT | AI 机器人模式 |
| 2 | 配置 storyNode=「新手引导」| 指定问题分类 |
| 3 | 打开客服 | 进入 AI 机器人页面 |
| 4 | 显示问题分类 | 定位到「新手引导」|
| 5 | 无转人工按钮 | alwaysShowHumanSupportButtonInBotPage=false |

---

### TC-CONFIG-002: 按用户等级分流 - 中级用户

**前置条件**: 20 ≤ 用户等级 < 50

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 配置 conversationIntent=BOT_SUPPORT | AI 机器人模式 |
| 2 | 配置 alwaysShowHumanSupportButtonInBotPage=true | 显示转人工 |
| 3 | 打开客服 | 进入 AI 机器人页面 |
| 4 | 转人工按钮可见 | 可随时转人工 |

---

### TC-CONFIG-003: 按用户等级分流 - VIP 用户

**前置条件**: 用户等级 ≥ 50

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 配置 conversationIntent=HUMAN_SUPPORT | 直接人工 |
| 2 | 配置 welcomeMessage | VIP 专属欢迎语 |
| 3 | 打开客服 | 跳过机器人 |
| 4 | 直接进入人工排队 | 显示排队提示 |
| 5 | 客服接入后 | 显示 welcomeMessage |

---

### TC-CONFIG-004: storyNode 指定问题分类

**前置条件**: 从充值页面进入客服

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 配置 storyNode=「充值问题」| 指定入口 |
| 2 | 打开客服 | 加载问题分类 |
| 3 | 自动定位 | 直接进入「充值问题」分类 |
| 4 | 显示子分类 | 充值相关的子问题 |

---

### TC-CONFIG-005: storyNode 不存在时的处理

**前置条件**: storyNode 值与后台配置不匹配

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 配置 storyNode=「不存在的分类」| 无效值 |
| 2 | 打开客服 | 正常加载 |
| 3 | 降级处理 | 显示默认问题分类列表 |

---

## 十三、跨平台兼容性测试

### TC-COMPAT-001: Android 不同版本兼容

| 系统版本 | 测试项 | 预期结果 |
|---------|-------|---------|
| Android 8.0 | 页面加载、Bridge 调用 | 正常 |
| Android 10 | 页面加载、Bridge 调用 | 正常 |
| Android 12 | 页面加载、Bridge 调用 | 正常 |
| Android 14 | 页面加载、Bridge 调用 | 正常 |

---

### TC-COMPAT-002: iOS 不同版本兼容

| 系统版本 | 测试项 | 预期结果 |
|---------|-------|---------|
| iOS 12 | 页面加载、Bridge 调用 | 正常 |
| iOS 14 | 页面加载、Bridge 调用 | 正常 |
| iOS 16 | 页面加载、Bridge 调用 | 正常 |
| iOS 17 | 页面加载、Bridge 调用 | 正常 |

---

### TC-COMPAT-003: 微信小程序 web-view 兼容

| 测试项 | 预期结果 |
|-------|---------|
| HTTPS 加载 | 正常加载（需域名白名单） |
| URL 参数传递 | 参数正确解析 |
| navigateBack 关闭 | 正常返回小程序 |
| 图片选择 | 可能受限，需实测 |

---

### TC-COMPAT-004: 浏览器兼容性

| 浏览器 | 版本 | 测试项 | 预期结果 |
|-------|-----|-------|---------|
| Chrome | 最新 | 全功能 | 正常 |
| Firefox | 最新 | 全功能 | 正常 |
| Safari | 最新 | 全功能 | 正常 |
| Edge | 最新 | 全功能 | 正常 |

---

## 十四、异常场景测试

### TC-ERR-001: 网络请求超时

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 模拟网络慢 | 请求超过 10 秒 |
| 2 | 超时处理 | 显示加载超时提示 |
| 3 | 提供重试 | 显示重试按钮 |

---

### TC-ERR-002: 服务器返回 500 错误

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 服务器异常 | 返回 500 |
| 2 | 错误处理 | 显示「服务暂时不可用」|
| 3 | 不暴露细节 | 不显示技术错误信息 |

---

### TC-ERR-003: WebSocket 连接失败

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | WS 服务不可用 | 连接失败 |
| 2 | 重试机制 | 自动重试 3 次 |
| 3 | 最终失败 | 显示连接失败提示 |
| 4 | 手动重连 | 提供重连按钮 |

---

### TC-ERR-004: Token 过期处理

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | wsToken 过期 | 1 小时后 |
| 2 | 操作被拒绝 | 收到 401 响应 |
| 3 | 自动刷新 | 重新调用 connect 获取新 token |
| 4 | 继续操作 | 无感知恢复 |

---

## 十五、性能测试

### TC-PERF-001: 页面首屏加载时间

| 网络环境 | 目标时间 | 测量方式 |
|---------|---------|---------|
| 4G | < 3 秒 | 从 WebView 打开到内容可见 |
| WiFi | < 2 秒 | 从 WebView 打开到内容可见 |
| 弱网 (2G) | < 8 秒 | 从 WebView 打开到内容可见 |

---

### TC-PERF-002: 消息发送响应时间

| 测试项 | 目标时间 |
|-------|---------|
| 发送到 ack | < 500ms |
| 发送到 AI 回复 | < 3s |
| 发送到客服显示 | < 1s |

---

### TC-PERF-003: 图片上传性能

| 图片大小 | 压缩后 | 上传时间（4G） |
|---------|-------|--------------|
| 2MB | ~500KB | < 5s |
| 5MB | ~800KB | < 8s |
| 10MB | ~1MB | < 10s |

---

## 十六、安全测试

### TC-SEC-001: 签名防篡改

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 正常签名 | 请求成功 |
| 2 | 修改 uid 但不改 sign | 签名验证失败 |
| 3 | 修改 areaid 但不改 sign | 签名验证失败 |
| 4 | 伪造 sign | 签名验证失败 |

---

### TC-SEC-002: Token 不可伪造

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 正常 wsToken | 连接成功 |
| 2 | 伪造 wsToken | 连接拒绝 |
| 3 | 修改 Token 内容 | 验证失败 |

---

### TC-SEC-003: XSS 防护

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 发送包含 `<script>` 的消息 | 正常发送 |
| 2 | 消息显示 | 转义显示，不执行脚本 |
| 3 | playerName 包含特殊字符 | 转义显示 |

---

## 十七、测试检查清单

### 17.1 冒烟测试（每次部署）

- [ ] Android Bridge 获取玩家信息
- [ ] Android Bridge 关闭 WebView
- [ ] iOS Bridge 获取玩家信息
- [ ] iOS Bridge 关闭 WebView
- [ ] URL 参数模式解析
- [ ] 签名验证通过
- [ ] WebSocket 连接建立
- [ ] 发送/接收消息
- [ ] 图片上传

### 17.2 回归测试（每次发版）

- [ ] 所有环境检测用例
- [ ] 所有 Bridge 接口用例
- [ ] 所有 URL 参数用例
- [ ] 所有签名验证用例
- [ ] 所有工单流程用例
- [ ] 所有配置功能用例
- [ ] 跨平台兼容性

### 17.3 全量测试（重大改动）

- [ ] 全部测试用例
- [ ] 性能测试
- [ ] 安全测试
- [ ] 压力测试

---

## 附录 A：测试数据准备

### A.1 签名计算工具

```javascript
const crypto = require('crypto')

function calculateSign(gameid, uid, areaid, nonce, secret) {
  const str = `${gameid}|${uid}|${areaid}|${nonce}|${secret}`
  return crypto.createHash('md5').update(str).digest('hex').toLowerCase()
}

// 测试数据
const sign = calculateSign(
  'com.test.cswebview',
  'player_001',
  '1',
  'test_nonce_123',
  'test_secret_key_456'
)
console.log('sign:', sign)
```

### A.2 测试 URL 生成

```javascript
function generateTestUrl(params) {
  const base = 'https://cs-test.example.com/webview'
  const query = new URLSearchParams({
    gameid: params.gameid,
    uid: params.uid,
    areaid: params.areaid,
    playerName: params.playerName || '',
    nonce: params.nonce,
    sign: params.sign,
    platform: params.platform || 'web'
  })
  return `${base}?${query}`
}
```

---

## 附录 B：问题记录模板

| 字段 | 内容 |
|-----|------|
| 用例编号 | TC-XXX-XXX |
| 测试环境 | Android 12 / Chrome 120 |
| 测试时间 | 2024-01-13 |
| 测试人员 | xxx |
| 问题描述 | |
| 复现步骤 | |
| 期望结果 | |
| 实际结果 | |
| 优先级 | P0/P1/P2/P3 |
| 截图/日志 | |

---

## 版本记录

| 版本 | 日期 | 说明 |
|-----|------|------|
| 1.0 | 2024-01-13 | 初稿，覆盖远程模式改造测试用例 |
