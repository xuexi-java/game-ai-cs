# 游戏方客服系统接入指南

> 本文档面向游戏客户端开发团队，指导如何接入客服系统。

---

## 一、接入概述

### 1.1 支持平台

| 平台 | 接入方式 |
|-----|---------|
| Android (Cocos/Unity) | WebView + JS Bridge |
| iOS (Cocos/Unity) | WKWebView + JS Bridge |
| 微信小程序 | web-view 组件 + URL 参数 |
| H5/Flash 网页 | iframe 或弹窗 + URL 参数 |

### 1.2 接入流程

```
1. 获取配置
   从客服系统管理员获取 gameid、secret、nonce、客服地址

2. 服务器端开发
   实现签名接口，返回认证参数

3. 客户端开发
   集成 WebView，实现 JS Bridge 或 URL 参数传递

4. 联调测试
   验证完整流程
```

---

## 二、配置信息

接入前，请从客服系统管理员获取以下配置：

| 配置项 | 示例 | 说明 |
|-------|------|------|
| gameid | com.company.sword | 游戏标识（建议使用包名） |
| secret | a1b2c3d4e5f6g7h8 | 签名密钥（仅服务器端使用） |
| nonce | fixed_nonce_123 | 固定随机串 |
| 客服地址 | https://cs.example.com/webview | H5 页面地址 |

> **安全警告**：secret 只能存储在游戏服务器端，绝对不能下发到客户端！

---

## 三、签名算法

### 3.1 签名公式

```
sign = MD5(gameid + "|" + uid + "|" + areaid + "|" + nonce + "|" + secret).toLowerCase()
```

### 3.2 参数说明

| 参数 | 说明 |
|-----|------|
| gameid | 游戏标识 |
| uid | 玩家唯一标识 |
| areaid | 区服标识 |
| nonce | 固定随机串（从配置获取） |
| secret | 签名密钥（从配置获取） |

### 3.3 签名示例

```
输入：
  gameid = "com.company.sword"
  uid    = "player_10001"
  areaid = "1"
  nonce  = "fixed_nonce_123"
  secret = "your_secret_key"

拼接串：
  "com.company.sword|player_10001|1|fixed_nonce_123|your_secret_key"

签名结果：
  sign = "e8b7c9d2a1f4e6b8c3d9a0f1e2b3c4d5"
```

---

## 四、服务器端接口

游戏服务器需要实现一个接口，供客户端获取认证参数。

### 4.1 接口定义

```
POST /api/get-cs-auth

请求参数：
{
    "uid": "player_10001",
    "areaid": "1"
}

响应参数：
{
    "success": true,
    "data": {
        "gameid": "com.company.sword",
        "uid": "player_10001",
        "areaid": "1",
        "playerName": "张三",
        "nonce": "fixed_nonce_123",
        "sign": "e8b7c9d2a1f4e6b8c3d9a0f1e2b3c4d5",
        "csUrl": "https://cs.example.com/webview"
    }
}
```

### 4.2 Java 服务器端实现示例

```java
import java.security.MessageDigest;

public class CustomerServiceAuthController {

    // 配置信息（从配置文件或数据库读取）
    private static final String GAME_ID = "com.company.sword";
    private static final String SECRET = "your_secret_key";
    private static final String NONCE = "fixed_nonce_123";
    private static final String CS_URL = "https://cs.example.com/webview";

    /**
     * 获取客服认证参数
     */
    @PostMapping("/api/get-cs-auth")
    public Response getCSAuth(@RequestBody AuthRequest request) {
        String uid = request.getUid();
        String areaid = request.getAreaid();

        // 查询玩家昵称
        String playerName = playerService.getPlayerName(uid);

        // 计算签名
        String sign = generateSign(GAME_ID, uid, areaid, NONCE, SECRET);

        // 构建响应
        AuthResponse data = new AuthResponse();
        data.setGameid(GAME_ID);
        data.setUid(uid);
        data.setAreaid(areaid);
        data.setPlayerName(playerName);
        data.setNonce(NONCE);
        data.setSign(sign);
        data.setCsUrl(CS_URL);

        return Response.success(data);
    }

    /**
     * 生成签名
     * 签名公式: sign = md5(gameid|uid|areaid|nonce|secret).toLowerCase()
     */
    private String generateSign(String gameid, String uid, String areaid,
                                String nonce, String secret) {
        String signStr = gameid + "|" + uid + "|" + areaid + "|" + nonce + "|" + secret;
        return md5(signStr).toLowerCase();
    }

    private String md5(String input) {
        try {
            MessageDigest md = MessageDigest.getInstance("MD5");
            byte[] digest = md.digest(input.getBytes("UTF-8"));
            StringBuilder sb = new StringBuilder();
            for (byte b : digest) {
                sb.append(String.format("%02x", b));
            }
            return sb.toString();
        } catch (Exception e) {
            throw new RuntimeException("MD5 计算失败", e);
        }
    }
}
```

---

## 五、Android 客户端接入

### 5.1 接入流程

```
1. 玩家点击「客服」按钮
        ↓
2. 调用游戏服务器获取认证参数
        ↓
3. 创建 WebView，注入 JS Bridge
        ↓
4. 加载客服 H5 页面
```

### 5.2 完整实现示例

#### 5.2.1 认证参数数据类

```java
/**
 * 客服认证参数
 */
public class CSAuthParams {
    private String gameid;
    private String uid;
    private String areaid;
    private String playerName;
    private String nonce;
    private String sign;
    private String csUrl;

    // Getters and Setters
    public String getGameid() { return gameid; }
    public void setGameid(String gameid) { this.gameid = gameid; }

    public String getUid() { return uid; }
    public void setUid(String uid) { this.uid = uid; }

    public String getAreaid() { return areaid; }
    public void setAreaid(String areaid) { this.areaid = areaid; }

    public String getPlayerName() { return playerName; }
    public void setPlayerName(String playerName) { this.playerName = playerName; }

    public String getNonce() { return nonce; }
    public void setNonce(String nonce) { this.nonce = nonce; }

    public String getSign() { return sign; }
    public void setSign(String sign) { this.sign = sign; }

    public String getCsUrl() { return csUrl; }
    public void setCsUrl(String csUrl) { this.csUrl = csUrl; }
}
```

#### 5.2.2 JS Bridge 实现

```java
import android.os.Handler;
import android.os.Looper;
import android.webkit.JavascriptInterface;

import com.google.gson.Gson;

import java.util.HashMap;
import java.util.Map;

/**
 * 客服系统 JS Bridge
 * 提供给 H5 调用的接口
 */
public class CustomerServiceBridge {

    private static final String TAG = "CSBridge";

    private final CSAuthParams authParams;
    private final Runnable onClose;
    private final Handler mainHandler;
    private final Gson gson;

    public CustomerServiceBridge(CSAuthParams authParams, Runnable onClose) {
        this.authParams = authParams;
        this.onClose = onClose;
        this.mainHandler = new Handler(Looper.getMainLooper());
        this.gson = new Gson();
    }

    /**
     * 获取玩家信息
     * H5 调用: window.AndroidBridge.getPlayerInfo()
     * 返回: JSON 字符串
     */
    @JavascriptInterface
    public String getPlayerInfo() {
        Map<String, String> playerInfo = new HashMap<>();
        playerInfo.put("gameid", authParams.getGameid());
        playerInfo.put("uid", authParams.getUid());
        playerInfo.put("areaid", authParams.getAreaid());
        playerInfo.put("playerName", authParams.getPlayerName());
        playerInfo.put("nonce", authParams.getNonce());
        playerInfo.put("sign", authParams.getSign());

        return gson.toJson(playerInfo);
    }

    /**
     * 关闭客服界面
     * H5 调用: window.AndroidBridge.close()
     */
    @JavascriptInterface
    public void close() {
        mainHandler.post(onClose);
    }
}
```

#### 5.2.3 客服管理类

```java
import android.app.Activity;
import android.content.Intent;
import android.util.Log;

import com.google.gson.Gson;

import java.io.IOException;

import okhttp3.Call;
import okhttp3.Callback;
import okhttp3.MediaType;
import okhttp3.OkHttpClient;
import okhttp3.Request;
import okhttp3.RequestBody;
import okhttp3.Response;

/**
 * 客服系统管理类
 */
public class CustomerServiceManager {

    private static final String TAG = "CSManager";
    private static final MediaType JSON = MediaType.parse("application/json; charset=utf-8");

    // 游戏服务器地址（根据实际情况配置）
    private static final String GAME_SERVER_URL = "https://game-server.example.com";

    private static CustomerServiceManager instance;
    private final OkHttpClient httpClient;
    private final Gson gson;

    private CustomerServiceManager() {
        this.httpClient = new OkHttpClient();
        this.gson = new Gson();
    }

    public static CustomerServiceManager getInstance() {
        if (instance == null) {
            synchronized (CustomerServiceManager.class) {
                if (instance == null) {
                    instance = new CustomerServiceManager();
                }
            }
        }
        return instance;
    }

    /**
     * 打开客服界面
     *
     * @param activity 当前 Activity
     * @param uid 玩家 UID
     * @param areaid 区服 ID
     */
    public void openCustomerService(Activity activity, String uid, String areaid) {
        // 1. 从游戏服务器获取认证参数
        fetchAuthParams(uid, areaid, new AuthCallback() {
            @Override
            public void onSuccess(CSAuthParams params) {
                // 2. 打开客服界面
                activity.runOnUiThread(() -> {
                    Intent intent = new Intent(activity, CustomerServiceActivity.class);
                    intent.putExtra("gameid", params.getGameid());
                    intent.putExtra("uid", params.getUid());
                    intent.putExtra("areaid", params.getAreaid());
                    intent.putExtra("playerName", params.getPlayerName());
                    intent.putExtra("nonce", params.getNonce());
                    intent.putExtra("sign", params.getSign());
                    intent.putExtra("csUrl", params.getCsUrl());
                    activity.startActivity(intent);
                });
            }

            @Override
            public void onError(String error) {
                Log.e(TAG, "获取认证参数失败: " + error);
                activity.runOnUiThread(() -> {
                    // 显示错误提示
                    Toast.makeText(activity, "打开客服失败，请稍后重试", Toast.LENGTH_SHORT).show();
                });
            }
        });
    }

    /**
     * 从游戏服务器获取认证参数
     */
    private void fetchAuthParams(String uid, String areaid, AuthCallback callback) {
        String url = GAME_SERVER_URL + "/api/get-cs-auth";
        String json = gson.toJson(new AuthRequest(uid, areaid));

        Request request = new Request.Builder()
                .url(url)
                .post(RequestBody.create(json, JSON))
                .build();

        httpClient.newCall(request).enqueue(new Callback() {
            @Override
            public void onFailure(Call call, IOException e) {
                callback.onError(e.getMessage());
            }

            @Override
            public void onResponse(Call call, Response response) throws IOException {
                if (response.isSuccessful() && response.body() != null) {
                    String body = response.body().string();
                    AuthResponse resp = gson.fromJson(body, AuthResponse.class);
                    if (resp.isSuccess() && resp.getData() != null) {
                        callback.onSuccess(resp.getData());
                    } else {
                        callback.onError("服务器返回错误");
                    }
                } else {
                    callback.onError("请求失败: " + response.code());
                }
            }
        });
    }

    // 请求/响应类
    private static class AuthRequest {
        String uid;
        String areaid;

        AuthRequest(String uid, String areaid) {
            this.uid = uid;
            this.areaid = areaid;
        }
    }

    private static class AuthResponse {
        boolean success;
        CSAuthParams data;

        boolean isSuccess() { return success; }
        CSAuthParams getData() { return data; }
    }

    interface AuthCallback {
        void onSuccess(CSAuthParams params);
        void onError(String error);
    }
}
```

#### 5.2.4 客服 Activity

```java
import android.annotation.SuppressLint;
import android.app.Activity;
import android.content.Intent;
import android.net.Uri;
import android.os.Bundle;
import android.webkit.ValueCallback;
import android.webkit.WebChromeClient;
import android.webkit.WebSettings;
import android.webkit.WebView;
import android.webkit.WebViewClient;

import androidx.activity.result.ActivityResultLauncher;
import androidx.activity.result.contract.ActivityResultContracts;
import androidx.appcompat.app.AppCompatActivity;

/**
 * 客服界面 Activity
 */
public class CustomerServiceActivity extends AppCompatActivity {

    private WebView webView;
    private ValueCallback<Uri[]> fileUploadCallback;
    private ActivityResultLauncher<Intent> fileChooserLauncher;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        // 注册文件选择器
        fileChooserLauncher = registerForActivityResult(
            new ActivityResultContracts.StartActivityForResult(),
            result -> {
                if (fileUploadCallback != null) {
                    Uri[] uris = null;
                    if (result.getResultCode() == Activity.RESULT_OK && result.getData() != null) {
                        Uri uri = result.getData().getData();
                        if (uri != null) {
                            uris = new Uri[]{uri};
                        }
                    }
                    fileUploadCallback.onReceiveValue(uris);
                    fileUploadCallback = null;
                }
            }
        );

        // 创建 WebView
        webView = new WebView(this);
        setContentView(webView);

        // 配置 WebView
        setupWebView();

        // 获取认证参数
        CSAuthParams params = getAuthParamsFromIntent();

        // 注入 JS Bridge
        webView.addJavascriptInterface(
            new CustomerServiceBridge(params, this::finish),
            "AndroidBridge"
        );

        // 加载客服页面
        webView.loadUrl(params.getCsUrl());
    }

    @SuppressLint("SetJavaScriptEnabled")
    private void setupWebView() {
        WebSettings settings = webView.getSettings();

        // 启用 JavaScript
        settings.setJavaScriptEnabled(true);

        // 启用 DOM Storage
        settings.setDomStorageEnabled(true);

        // 允许混合内容
        settings.setMixedContentMode(WebSettings.MIXED_CONTENT_ALWAYS_ALLOW);

        // WebViewClient
        webView.setWebViewClient(new WebViewClient());

        // WebChromeClient（处理文件选择）
        webView.setWebChromeClient(new WebChromeClient() {
            @Override
            public boolean onShowFileChooser(WebView webView,
                                             ValueCallback<Uri[]> filePathCallback,
                                             FileChooserParams fileChooserParams) {
                fileUploadCallback = filePathCallback;

                Intent intent = new Intent(Intent.ACTION_GET_CONTENT);
                intent.addCategory(Intent.CATEGORY_OPENABLE);
                intent.setType("image/*");

                fileChooserLauncher.launch(Intent.createChooser(intent, "选择图片"));
                return true;
            }
        });
    }

    private CSAuthParams getAuthParamsFromIntent() {
        Intent intent = getIntent();
        CSAuthParams params = new CSAuthParams();
        params.setGameid(intent.getStringExtra("gameid"));
        params.setUid(intent.getStringExtra("uid"));
        params.setAreaid(intent.getStringExtra("areaid"));
        params.setPlayerName(intent.getStringExtra("playerName"));
        params.setNonce(intent.getStringExtra("nonce"));
        params.setSign(intent.getStringExtra("sign"));
        params.setCsUrl(intent.getStringExtra("csUrl"));
        return params;
    }

    @Override
    public void onBackPressed() {
        if (webView.canGoBack()) {
            webView.goBack();
        } else {
            super.onBackPressed();
        }
    }

    @Override
    protected void onDestroy() {
        if (webView != null) {
            webView.destroy();
        }
        super.onDestroy();
    }
}
```

#### 5.2.5 调用示例

```java
// 在游戏中调用
public class GameActivity extends Activity {

    // 玩家点击客服按钮
    public void onCustomerServiceClick() {
        String uid = GameData.getCurrentUid();      // 当前玩家 UID
        String areaid = GameData.getCurrentAreaId(); // 当前区服 ID

        CustomerServiceManager.getInstance().openCustomerService(this, uid, areaid);
    }
}
```

### 5.3 AndroidManifest 配置

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android">

    <!-- 网络权限 -->
    <uses-permission android:name="android.permission.INTERNET" />

    <!-- 存储权限（图片选择） -->
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"
        android:maxSdkVersion="32" />
    <uses-permission android:name="android.permission.READ_MEDIA_IMAGES" />

    <application>
        <!-- 客服 Activity -->
        <activity
            android:name=".CustomerServiceActivity"
            android:screenOrientation="portrait"
            android:theme="@style/Theme.AppCompat.Light.NoActionBar" />
    </application>

</manifest>
```

### 5.4 依赖配置 (build.gradle)

```groovy
dependencies {
    // OkHttp（网络请求）
    implementation 'com.squareup.okhttp3:okhttp:4.12.0'

    // Gson（JSON 解析）
    implementation 'com.google.code.gson:gson:2.10.1'
}
```

---

## 六、iOS 客户端接入

### 6.1 接入流程

与 Android 相同：
1. 调用游戏服务器获取认证参数
2. 创建 WKWebView，注入 JS Bridge
3. 加载客服 H5 页面

### 6.2 Swift 实现示例

```swift
import UIKit
import WebKit

class CustomerServiceViewController: UIViewController, WKScriptMessageHandler {

    private var webView: WKWebView!
    private var authParams: CSAuthParams!

    init(authParams: CSAuthParams) {
        self.authParams = authParams
        super.init(nibName: nil, bundle: nil)
    }

    required init?(coder: NSCoder) {
        fatalError("init(coder:) has not been implemented")
    }

    override func viewDidLoad() {
        super.viewDidLoad()
        setupWebView()
        webView.load(URLRequest(url: URL(string: authParams.csUrl)!))
    }

    private func setupWebView() {
        let config = WKWebViewConfiguration()
        config.userContentController.add(self, name: "iosBridge")

        webView = WKWebView(frame: view.bounds, configuration: config)
        webView.autoresizingMask = [.flexibleWidth, .flexibleHeight]
        view.addSubview(webView)
    }

    // JS Bridge 回调
    func userContentController(_ controller: WKUserContentController,
                               didReceive message: WKScriptMessage) {
        guard let body = message.body as? [String: Any],
              let action = body["action"] as? String else { return }

        switch action {
        case "getPlayerInfo":
            let callbackId = body["callbackId"] as? String ?? ""
            let playerInfo: [String: String] = [
                "gameid": authParams.gameid,
                "uid": authParams.uid,
                "areaid": authParams.areaid,
                "playerName": authParams.playerName,
                "nonce": authParams.nonce,
                "sign": authParams.sign
            ]
            let json = try! JSONSerialization.data(withJSONObject: playerInfo)
            let jsonStr = String(data: json, encoding: .utf8)!
            webView.evaluateJavaScript("window.__iosCallback('\(callbackId)', '\(jsonStr)')")

        case "close":
            dismiss(animated: true)

        default:
            break
        }
    }
}
```

---

## 七、微信小程序接入

### 7.1 接入流程

```
1. 调用游戏服务器获取认证参数
2. 拼接 URL 参数
3. 使用 web-view 组件加载
```

### 7.2 实现示例

#### 7.2.1 页面文件

**customer-service/index.wxml**
```xml
<web-view wx:if="{{url}}" src="{{url}}" bindmessage="onMessage"></web-view>
<view wx:else class="loading">
    <text>正在加载客服...</text>
</view>
```

**customer-service/index.js**
```javascript
Page({
    data: {
        url: ''
    },

    onLoad() {
        const app = getApp();
        const uid = app.globalData.uid;
        const areaid = app.globalData.areaid;

        // 调用游戏服务器获取认证参数
        wx.request({
            url: 'https://game-server.example.com/api/get-cs-auth',
            method: 'POST',
            data: { uid, areaid },
            success: (res) => {
                if (res.data.success) {
                    const params = res.data.data;

                    // 拼接 URL 参数
                    const query = [
                        `gameid=${encodeURIComponent(params.gameid)}`,
                        `uid=${encodeURIComponent(params.uid)}`,
                        `areaid=${encodeURIComponent(params.areaid)}`,
                        `playerName=${encodeURIComponent(params.playerName)}`,
                        `nonce=${encodeURIComponent(params.nonce)}`,
                        `sign=${encodeURIComponent(params.sign)}`,
                        `platform=wxapp`
                    ].join('&');

                    this.setData({
                        url: `${params.csUrl}?${query}`
                    });
                }
            },
            fail: () => {
                wx.showToast({ title: '加载失败', icon: 'none' });
                wx.navigateBack();
            }
        });
    },

    onMessage(e) {
        const data = e.detail.data;
        if (data && data[0] && data[0].type === 'cs-close') {
            wx.navigateBack();
        }
    }
});
```

### 7.3 业务域名配置

```
1. 登录微信公众平台
2. 进入「开发管理」→「开发设置」→「业务域名」
3. 添加客服域名（如 cs.example.com）
4. 下载校验文件，上传到服务器根目录
5. 保存
```

---

## 八、H5/Flash 网页接入

### 8.1 弹窗方式

```javascript
// 调用游戏服务器获取认证参数
async function openCustomerService(uid, areaid) {
    const response = await fetch('https://game-server.example.com/api/get-cs-auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ uid, areaid })
    });

    const result = await response.json();
    if (result.success) {
        const params = result.data;
        const query = new URLSearchParams({
            gameid: params.gameid,
            uid: params.uid,
            areaid: params.areaid,
            playerName: params.playerName,
            nonce: params.nonce,
            sign: params.sign,
            platform: 'web'
        });

        // 打开弹窗
        window.open(`${params.csUrl}?${query}`, 'customer_service', 'width=400,height=700');
    }
}
```

### 8.2 iframe 方式

```javascript
function openCustomerServiceIframe(uid, areaid) {
    // 获取认证参数后...
    const params = { /* ... */ };
    const query = new URLSearchParams({
        ...params,
        platform: 'iframe'
    });

    // 创建 iframe
    const iframe = document.createElement('iframe');
    iframe.src = `${params.csUrl}?${query}`;
    iframe.style.cssText = 'position:fixed;right:20px;bottom:20px;width:400px;height:600px;border:none;box-shadow:0 0 20px rgba(0,0,0,0.3);border-radius:12px;';

    document.body.appendChild(iframe);

    // 监听关闭消息
    window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'cs-close') {
            iframe.remove();
        }
    });
}
```

### 8.3 Flash ExternalInterface 调用

```actionscript
// ActionScript
import flash.external.ExternalInterface;

function openCustomerService():void {
    var uid:String = GameData.uid;
    var areaid:String = GameData.areaid;

    // 调用页面 JS 函数
    ExternalInterface.call("openCustomerService", uid, areaid);
}
```

---

## 九、常见问题

### 9.1 签名验证失败

**可能原因**：
- 签名参数顺序错误（必须是 gameid|uid|areaid|nonce|secret）
- secret 不正确
- 参数值有多余空格
- MD5 结果未转小写

**排查方法**：
```java
// 打印签名原串
String signStr = gameid + "|" + uid + "|" + areaid + "|" + nonce + "|" + secret;
Log.d("CS", "签名原串: " + signStr);
Log.d("CS", "签名结果: " + md5(signStr).toLowerCase());
```

### 9.2 WebView 白屏

**可能原因**：
- JS Bridge 未正确注入
- H5 地址错误
- 网络不通

**排查方法**：
```java
// 启用 WebView 调试
WebView.setWebContentsDebuggingEnabled(true);
// 然后用 Chrome DevTools 调试：chrome://inspect
```

### 9.3 图片选择无响应

**可能原因**：
- 未实现 `onShowFileChooser`
- 缺少存储权限

**解决方法**：
```java
// 确保实现了 WebChromeClient.onShowFileChooser()
// 确保 AndroidManifest.xml 声明了存储权限
```

### 9.4 关闭按钮无效

**可能原因**：
- JS Bridge 的 close() 方法未实现
- close() 方法未在主线程执行

**解决方法**：
```java
@JavascriptInterface
public void close() {
    // 必须在主线程执行 UI 操作
    mainHandler.post(() -> activity.finish());
}
```

---

## 十、联系方式

如有问题，请联系客服系统管理员：
- 技术支持邮箱：support@example.com
- 技术文档：https://docs.example.com/cs

---

## 附录：完整代码文件清单

| 文件 | 说明 |
|-----|------|
| CSAuthParams.java | 认证参数数据类 |
| CustomerServiceBridge.java | JS Bridge 实现 |
| CustomerServiceManager.java | 客服管理类 |
| CustomerServiceActivity.java | 客服界面 Activity |

---

## 版本记录

| 版本 | 日期 | 说明 |
|-----|------|------|
| 1.0 | 2024-01-13 | 初稿 |
