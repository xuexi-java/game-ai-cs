# 客服系统远程模式改造执行清单

> 本文档作为改造的执行指南，详细列出需要修改的文件和改动点。

---

## 一、改造概述

### 1.1 改造目标

```
改造前（本地模式）：
H5 打包在客户端 → Bridge 代理所有网络请求

改造后（远程模式）：
H5 部署在服务器 → H5 直接发起网络请求 → Bridge 只提供玩家信息
```

### 1.2 涉及项目

| 项目 | 路径 | 改动量 |
|-----|------|-------|
| webview-player (H5) | E:\AIWorkFlow\trunk\service\develop\game-ai\webview-player | 中 |
| 测试 APK 壳子 | D:\apk | 小 |
| 后端 | E:\AIWorkFlow\trunk\service\develop\game-ai\backend | 小 |

---

## 二、签名时效性方案

### 2.1 改造背景

当前签名机制存在安全隐患：
- 签名公式：`sign = md5(gameid|uid|areaid|nonce|secret)`
- nonce 为固定配置值，签名永不过期
- 一旦签名泄露，可被永久利用（重放攻击）

### 2.2 新签名方案

**新签名公式：**
```
sign = md5(gameid|uid|areaid|ts|nonce|secret).toLowerCase()
```

**参数说明：**

| 参数 | 说明 | 来源 |
|------|------|------|
| gameid | 游戏ID | 游戏服务器配置 |
| uid | 玩家UID | 游戏服务器 |
| areaid | 区服ID | 游戏服务器 |
| ts | 时间戳(毫秒) | **新增**，签名时的当前时间 |
| nonce | 固定随机串 | 使用后台配置的 playerApiNonce |
| secret | 签名密钥 | 游戏服务器配置（不传到前端） |

**时效性规则：**
- 签名有效期：**2小时**（7200000ms）
- 后端验证：`|服务器时间 - ts| <= 7200000`
- 超时错误码：`SIGN_EXPIRED`
- 超时错误消息：`签名已过期，请重新进入`

### 2.3 各端签名逻辑

**游戏服务器/APK 端（签名生成方）：**
```kotlin
val ts = System.currentTimeMillis()  // 新增：获取当前时间戳
val nonce = authParams.nonce         // 保持：使用固定配置值
val signStr = "$gameid|$uid|$areaid|$ts|$nonce|$secret"  // 新增 ts
val sign = md5(signStr).lowercase()
```

**H5 端（远程模式）：**
- 从 URL 参数或 Bridge 获取完整 PlayerInfo（含 ts）
- **不计算签名**，直接使用游戏服务器/APK 提供的值

**后端验证逻辑：**
```typescript
// 1. 检查时效性（新增）
const SIGN_EXPIRY_MS = 2 * 60 * 60 * 1000;  // 2小时
const now = Date.now();
if (Math.abs(now - ts) > SIGN_EXPIRY_MS) {
  throw UnauthorizedException({ errorCode: 'SIGN_EXPIRED' });
}

// 2. 验证 nonce（保持不变）
if (nonce !== game.playerApiNonce) {
  throw UnauthorizedException({ errorCode: 'INVALID_SIGN' });
}

// 3. 验证签名（公式新增 ts）
const expectedSign = md5(`${gameid}|${uid}|${areaid}|${ts}|${nonce}|${secret}`);
if (sign !== expectedSign) {
  throw UnauthorizedException({ errorCode: 'INVALID_SIGN' });
}
```

---

## 三、H5 端改造清单

### 3.1 文件清单

| 序号 | 文件 | 操作 | 说明 |
|-----|------|------|------|
| H1 | src/types/index.ts | 修改 | 简化接口，扩展 PlayerInfo（含 ts） |
| H2 | src/services/bridge.ts | 修改 | 简化导出，移除代理方法 |
| H3 | src/services/bridges/android.ts | 修改 | 只保留 2 个方法 |
| H4 | src/services/bridges/ios.ts | 修改 | 只保留 2 个方法 |
| H5 | src/services/bridges/web.ts | 重写 | 改为 URL 参数模式（含 ts） |
| H6 | src/services/api.ts | 新增 | 封装 HTTP 请求（含签名参数） |
| H7 | src/composables/useChat.ts | 修改 | 改用 api.ts |
| H8 | vite.config.ts | 修改 | base 路径配置（远程模式） |

---

### 3.2 详细改动说明

#### H1: src/types/index.ts

**改动点**：

1. 扩展 PlayerInfo，增加 ts、nonce、sign 字段
2. 简化 NativeBridge 接口，只保留 2 个方法
3. 移除 BridgeCallParams、ApiResponse 等代理相关类型（如果只在 bridge 中使用）

**改动前**：
```typescript
interface PlayerInfo {
  gameid: string
  uid: string
  areaid: string
  playerName: string
}

interface NativeBridge {
  getPlayerInfo(): Promise<PlayerInfo>
  getApiUrl(): string
  getSignedParams(endpoint: string, body: Record<string, unknown>): Promise<Record<string, unknown>>
  callPlayerApi<T>(params: BridgeCallParams): Promise<ApiResponse<T>>
  uploadFile(file: Blob, filename: string, uploadToken: string): Promise<{ url: string }>
  close(): void
}
```

**改动后**：
```typescript
interface PlayerInfo {
  gameid: string
  uid: string
  areaid: string
  playerName?: string
  ts: number         // 新增：时间戳(毫秒)，用于签名时效性验证
  nonce: string      // 固定配置值
  sign: string       // 新签名公式计算
}

interface NativeBridge {
  getPlayerInfo(): PlayerInfo | Promise<PlayerInfo>
  close(): void
}

// 环境类型
type BridgeEnv = 'android' | 'ios' | 'url' | 'mock'
```

**完成标准**：
- [ ] PlayerInfo 包含 ts、nonce、sign 字段
- [ ] NativeBridge 只有 getPlayerInfo、close 两个方法
- [ ] 类型定义无 TypeScript 错误

---

#### H2: src/services/bridge.ts

**改动点**：

1. 修改 detectEnv() 增加 URL 参数检测
2. 移除 callPlayerApi、uploadFile、getSignedParams、getApiUrl 导出
3. 只导出 getBridge、getPlayerInfo、closeBridge

**改动前**：
```typescript
export function detectEnv(): BridgeEnv {
  if (window.AndroidBridge) return 'android'
  if (window.webkit?.messageHandlers?.iosBridge) return 'ios'
  return 'web'
}

export async function callPlayerApi<T>(...) { ... }
export async function uploadFile(...) { ... }
export async function getSignedParams(...) { ... }
export function getApiUrl(): string { ... }
```

**改动后**：
```typescript
export function detectEnv(): BridgeEnv {
  if (window.AndroidBridge) return 'android'
  if (window.webkit?.messageHandlers?.iosBridge) return 'ios'
  if (new URLSearchParams(location.search).has('gameid')) return 'url'
  return 'mock'
}

// 只导出这三个
export function getBridge(): NativeBridge { ... }
export async function getPlayerInfo(): Promise<PlayerInfo> { ... }
export function closeBridge(): void { ... }
```

**完成标准**：
- [ ] detectEnv 支持 4 种环境
- [ ] 移除了 callPlayerApi、uploadFile 等导出
- [ ] 无 TypeScript 错误

---

#### H3: src/services/bridges/android.ts

**改动点**：

1. 删除 callPlayerApi 方法
2. 删除 getSignedParams 方法
3. 删除 uploadFile 方法
4. 删除 getApiUrl 方法
5. 修改 getPlayerInfo 返回值包含 ts、nonce、sign

**保留的方法**：
- getPlayerInfo() - 同步调用，返回含签名的 PlayerInfo（含 ts）
- close() - 关闭 WebView

**完成标准**：
- [ ] 只剩 2 个方法
- [ ] getPlayerInfo 返回值包含 ts、nonce、sign
- [ ] 回调管理代码可以简化或移除

---

#### H4: src/services/bridges/ios.ts

**改动点**：

1. 删除 callPlayerApi 方法
2. 删除 getSignedParams 方法
3. 删除 uploadFile 方法
4. 删除 getApiUrl 方法
5. 修改 getPlayerInfo 返回值包含 ts、nonce、sign

**保留的方法**：
- getPlayerInfo() - 异步调用，返回含签名的 PlayerInfo（含 ts）
- close() - 关闭 WebView

**完成标准**：
- [ ] 只剩 2 个方法
- [ ] getPlayerInfo 返回值包含 ts、nonce、sign
- [ ] 回调管理代码可以简化

---

#### H5: src/services/bridges/web.ts（重写）

**改动点**：

完全重写，改为 URL 参数模式

**新逻辑**：
1. 从 URL 参数解析 PlayerInfo（包含 ts、nonce、sign，不再自己计算）
2. close() 根据 platform 参数决定关闭方式
3. 移除 crypto-js 依赖（不再计算签名）

**改动后**：
```typescript
function getPlayerInfoFromUrl(): PlayerInfo {
  const params = new URLSearchParams(location.search)
  return {
    gameid: params.get('gameid') || '',
    uid: params.get('uid') || '',
    areaid: params.get('areaid') || '',
    playerName: params.get('playerName') || '',
    ts: parseInt(params.get('ts') || '0', 10),  // 新增：时间戳
    nonce: params.get('nonce') || '',
    sign: params.get('sign') || ''
  }
}

function close(): void {
  const platform = new URLSearchParams(location.search).get('platform')

  if (platform === 'wxapp' && window.wx?.miniProgram) {
    wx.miniProgram.navigateBack()
  } else if (platform === 'iframe') {
    parent.postMessage({ type: 'cs-close' }, '*')
  } else {
    window.close()
    // 如果关闭失败，显示提示
  }
}
```

**完成标准**：
- [ ] 从 URL 参数获取 PlayerInfo（含 ts）
- [ ] ts、sign 来自 URL 参数，不自己计算
- [ ] 移除 crypto-js 依赖
- [ ] close() 支持 wxapp、iframe、web 三种模式

---

#### H6: src/services/api.ts（新增）

**用途**：封装所有 HTTP 请求，H5 直接发起

**需要实现的方法**：

```typescript
// 存储玩家信息
let playerInfo: PlayerInfo | null = null
let apiBaseUrl: string = ''

// 初始化（从 Bridge 获取玩家信息）
async function init(): Promise<void> {
  playerInfo = await getPlayerInfo()  // 从 bridge.ts 获取
  apiBaseUrl = getApiBaseUrl()
}

// 获取 API 基础地址
function getApiBaseUrl(): string {
  // 优先级：URL 参数 > 环境变量 > 默认值
  const params = new URLSearchParams(location.search)
  return params.get('apiUrl') || import.meta.env.VITE_API_URL || ''
}

// 获取 WebSocket URL（从 bootstrap 响应获取）
function getWsUrl(wsUrl: string): string {
  // wsUrl 来自 /api/v1/player/connect 响应
  // 如果是相对路径，拼接 apiBaseUrl
  if (wsUrl.startsWith('/')) {
    return `${apiBaseUrl.replace(/^http/, 'ws')}${wsUrl}`
  }
  return wsUrl
}

// 调用玩家 API（附加签名参数）
async function callPlayerApi<T>(endpoint: string, body?: object): Promise<ApiResponse<T>>

// 上传文件
async function uploadFile(file: Blob, filename: string, uploadToken: string): Promise<{ url: string }>

// 获取玩家信息
function getPlayerInfo(): PlayerInfo | null
```

**核心逻辑**：
```typescript
async function callPlayerApi<T>(endpoint: string, body?: object): Promise<ApiResponse<T>> {
  const baseUrl = getApiBaseUrl()

  // 附加签名参数（含 ts）
  const requestBody = {
    gameid: playerInfo.gameid,
    uid: playerInfo.uid,
    areaid: playerInfo.areaid,
    playerName: playerInfo.playerName,
    ts: playerInfo.ts,         // 新增：时间戳
    nonce: playerInfo.nonce,
    sign: playerInfo.sign,
    ...body
  }

  const response = await fetch(`${baseUrl}${endpoint}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(requestBody)
  })

  const json = await response.json()

  // 处理 TransformInterceptor 包装的响应格式
  if ('success' in json && json.data && 'result' in json.data) {
    return json.data as ApiResponse<T>
  }
  return json as ApiResponse<T>
}
```

**上传文件实现**：
```typescript
async function uploadFile(
  file: Blob,
  filename: string,
  uploadToken: string
): Promise<{ url: string }> {
  const formData = new FormData()
  formData.append('file', file, filename)

  const response = await fetch(`${apiBaseUrl}/api/v1/player/upload`, {
    method: 'POST',
    headers: { 'X-Upload-Token': uploadToken },
    body: formData
  })

  const json = await response.json()
  // 处理响应格式...
  return { url: json.data?.url || '' }
}
```

**完成标准**：
- [ ] 实现 init、callPlayerApi、uploadFile、getApiBaseUrl、getWsUrl 方法
- [ ] 请求自动附加 ts、nonce、sign 等签名参数
- [ ] 正确处理 TransformInterceptor 响应格式
- [ ] 支持从 URL 参数获取 apiUrl

---

#### H7: src/composables/useChat.ts

**改动点**：

1. 导入改为使用 api.ts
2. 移除对 bridge 代理方法的调用
3. 改用 api.callPlayerApi、api.uploadFile

**改动示例**：
```typescript
// 改动前
import { callPlayerApi, uploadFile } from '@/services/bridge'

// 改动后
import { callPlayerApi, uploadFile } from '@/services/api'
```

**完成标准**：
- [ ] 不再导入 bridge 的代理方法
- [ ] 改用 api.ts 的方法
- [ ] 功能正常

---

#### H8: vite.config.ts

**改动点**：

1. base 路径配置调整（远程模式）
2. 添加环境变量支持

**改动前**：
```typescript
export default defineConfig({
  base: './',  // 本地模式用相对路径
  // ...
})
```

**改动后**：
```typescript
export default defineConfig({
  base: '/',  // 远程模式用绝对路径
  // ...
  define: {
    // 确保环境变量可用
  }
})
```

**说明**：
- 本地模式：`base: './'` 支持 `file://` 协议加载
- 远程模式：`base: '/'` 支持 HTTP 服务器部署
- 如需同时支持两种模式，可通过环境变量切换

**完成标准**：
- [ ] base 配置适合远程部署
- [ ] 构建产物路径正确

---

### 3.3 可删除的内容

| 内容 | 说明 |
|-----|------|
| crypto-js 依赖 | web.ts 不再计算签名 |
| BridgeCallParams 类型 | 如果只在 bridge 中使用 |
| 回调管理代码 | android.ts/ios.ts 中可简化 |

---

## 四、APK 壳子改造清单

### 4.1 文件清单

| 序号 | 文件 | 操作 | 说明 |
|-----|------|------|------|
| A1 | bridge/AndroidBridge.kt | 修改 | 删除 4 个方法 |
| A2 | data/AuthParams.kt | 保持 | 已包含 nonce、sign |
| A3 | ui/webview/WebViewFragment.kt | 修改 | 修改加载地址 |
| A4 | assets/web/ | 删除 | 不再需要本地 H5 |

---

### 4.2 详细改动说明

#### A1: bridge/AndroidBridge.kt

**删除的方法**：
- getApiUrl()
- getSignedParams()
- callPlayerApi()
- uploadFile()

**保留的方法**：
- getPlayerInfo() - 返回含 ts、nonce、sign 的 JSON
- close()

**改动后**：
```kotlin
class AndroidBridge(
    private val authParams: AuthParams,
    private val onClose: () -> Unit
) {
    @JavascriptInterface
    fun getPlayerInfo(): String {
        val playerInfo = mapOf(
            "gameid" to authParams.gameid,
            "uid" to authParams.uid,
            "areaid" to authParams.areaid,
            "playerName" to authParams.playerName,
            "ts" to authParams.ts,         // 新增：时间戳
            "nonce" to authParams.nonce,
            "sign" to authParams.sign
        )
        return Gson().toJson(playerInfo)
    }

    @JavascriptInterface
    fun close() {
        mainHandler.post { onClose() }
    }
}
```

**可删除的内容**：
- httpClient（OkHttp）
- 回调管理相关代码
- uploadFile 相关代码

**完成标准**：
- [ ] 只剩 2 个方法
- [ ] getPlayerInfo 返回值包含 ts、nonce、sign
- [ ] 移除 OkHttp 相关代码

---

#### A2: data/AuthParams.kt

**改动点**：

新增 ts 字段用于签名时效性验证

**改动后**：
```kotlin
data class AuthParams(
    val gameid: String,
    val uid: String,
    val areaid: String,
    val playerName: String,
    val ts: Long,           // 新增：时间戳(毫秒)
    val nonce: String,
    val sign: String,       // 签名公式需包含 ts
    val csApiUrl: String
)
```

**完成标准**：
- [ ] 包含 ts 字段
- [ ] 签名计算包含 ts

---

#### A3: ui/webview/WebViewFragment.kt

**改动点**：

1. 修改 H5 加载地址（从本地改为远程）
2. 保留图片选择处理（onShowFileChooser）
3. 保留权限请求逻辑

**改动前**：
```kotlin
private const val LOCAL_URL = "file:///android_asset/web/index.html"
```

**改动后**：
```kotlin
// 开发测试：使用内网 IP
private const val WEBVIEW_URL = "http://10.10.17.200:5173"

// 正式环境：使用部署地址
// private const val WEBVIEW_URL = "https://cs.example.com/webview"
```

**保留不变的部分**：
- WebView 配置（javaScriptEnabled 等）
- onShowFileChooser 实现（图片选择）
- 权限请求逻辑
- 返回键处理

**完成标准**：
- [ ] 加载地址改为远程 URL
- [ ] 图片选择功能正常
- [ ] 其他功能不受影响

---

#### A4: assets/web/ 目录

**操作**：删除整个目录

**说明**：远程模式下不再需要本地 H5 资源

**完成标准**：
- [ ] 删除 assets/web/ 目录
- [ ] APK 编译正常

---

## 五、后端改造清单

### 5.1 改造说明

后端需要添加签名时效性验证，改动量较小。

### 5.2 文件清单

| 序号 | 文件 | 操作 | 说明 |
|-----|------|------|------|
| B1 | src/player-api/guards/sign.guard.ts | 修改 | 添加 ts 时效性检查 |
| B2 | src/player-api/dto/sign.dto.ts | 修改 | ts 参数设为签名认证必填 |
| B3 | src/main.ts | 检查 | 确认 CORS 配置允许远程 H5 域名 |

### 5.3 详细改动说明

#### B1: sign.guard.ts

**改动点**：

1. 在 validateSign 方法中添加 ts 时效性检查
2. 修改签名公式，加入 ts 参数
3. 添加 SIGN_EXPIRED 错误码处理

**改动位置**：validateSign 方法开头

```typescript
// 在验证必填参数之后，验证 nonce 之前添加
private async validateSign(request: any, body: any): Promise<boolean> {
  // 1. 验证必填参数
  const { gameid, uid, areaid, nonce, sign, ts } = body;
  if (!gameid || !uid || !areaid || !nonce || !sign) {
    throw new BadRequestException({ errorCode: 'MISSING_PARAMS' });
  }

  // 2. 检查时效性（新增）
  const SIGN_EXPIRY_MS = 2 * 60 * 60 * 1000;  // 2小时
  const now = Date.now();
  if (!ts || Math.abs(now - ts) > SIGN_EXPIRY_MS) {
    this.logger.error(`签名已过期: ts=${ts}, now=${now}, diff=${Math.abs(now - ts)}`);
    throw new UnauthorizedException({
      result: false,
      error: '签名已过期，请重新进入',
      errorCode: 'SIGN_EXPIRED'
    });
  }

  // 3. 查询游戏配置...
  // 4. 验证 nonce...

  // 5. 验证签名（修改公式，加入 ts）
  const expectedSign = this.generateSign(gameid, uid, areaid, ts, nonce, secret);
  // ...
}

// 修改签名生成方法
private generateSign(
  gameid: string,
  uid: string,
  areaid: string,
  ts: number,      // 新增参数
  nonce: string,
  secret: string,
): string {
  const raw = `${gameid}|${uid}|${areaid}|${ts}|${nonce}|${secret}`;
  return crypto.createHash('md5').update(raw).digest('hex').toLowerCase();
}
```

**完成标准**：
- [ ] 添加 ts 时效性检查（2小时）
- [ ] 签名公式包含 ts 参数
- [ ] 超时返回 SIGN_EXPIRED 错误码

---

#### B2: sign.dto.ts

**改动点**：

ts 参数在签名认证时设为必填

**改动位置**：SignDto 类

```typescript
// 现有代码（ts 为可选）
@ApiPropertyOptional({ description: '时间戳(毫秒) (签名认证时必填)' })
@ValidateIf((o) => !o.sessionToken && !o.token)
@IsNumber()
ts?: number;

// 改为：添加 IsNotEmpty 验证
@ApiPropertyOptional({ description: '时间戳(毫秒) (签名认证时必填)' })
@ValidateIf((o) => !o.sessionToken && !o.token)
@IsNumber()
@IsNotEmpty({ message: '签名认证时 ts 为必填' })
ts?: number;
```

**完成标准**：
- [ ] ts 参数在签名认证时必填
- [ ] 缺少 ts 时返回明确错误信息

---

#### B3: main.ts (CORS 配置)

**检查点**：

确认 CORS 配置允许远程 H5 部署域名

**当前配置位置**：main.ts 第 53-83 行

```typescript
// 确保以下域名被允许（根据实际部署情况调整）
const allowedOrigins = [
  'http://localhost:5173',      // 本地开发
  'http://10.10.17.200:5173',   // 内网测试
  'https://cs.example.com',     // 生产环境（按需添加）
];
```

**完成标准**：
- [ ] CORS 允许远程 H5 域名
- [ ] WebSocket CORS 配置同步（websocket.gateway.ts）

---

### 5.4 错误码说明

| 错误码 | 说明 | HTTP 状态 |
|--------|------|-----------|
| SIGN_EXPIRED | 签名已过期（超过 2 小时） | 401 |
| INVALID_SIGN | 签名验证失败 | 401 |
| MISSING_PARAMS | 缺少必填参数 | 400 |

---

## 六、改造顺序

```
阶段一：H5 端改造（可独立进行）
│
├── 步骤 1: 修改 types/index.ts
│           扩展 PlayerInfo，简化 NativeBridge
│
├── 步骤 2: 新增 services/api.ts
│           封装 HTTP 请求逻辑
│
├── 步骤 3: 重写 bridges/web.ts
│           改为 URL 参数模式
│
├── 步骤 4: 简化 bridges/android.ts
│           删除 4 个代理方法
│
├── 步骤 5: 简化 bridges/ios.ts
│           删除 4 个代理方法
│
├── 步骤 6: 修改 bridge.ts
│           简化导出，修改环境检测
│
├── 步骤 7: 修改 useChat.ts
│           改用 api.ts
│
└── 步骤 8: 本地测试
            URL 参数模式测试

阶段二：APK 壳子改造
│
├── 步骤 9: 简化 AndroidBridge.kt
│           删除代理方法
│
├── 步骤 10: 修改 WebViewFragment.kt
│            修改加载地址
│
├── 步骤 11: 删除 assets/web/
│
└── 步骤 12: APK 测试
             完整功能测试

阶段三：集成测试
│
├── 步骤 13: 浏览器 URL 参数测试
│
├── 步骤 14: APK 远程加载测试
│
└── 步骤 15: 全功能验收
```

---

## 七、测试检查点

### 7.1 H5 单独测试（步骤 8）

| 测试项 | 测试方法 | 预期结果 |
|-------|---------|---------|
| URL 参数解析 | 浏览器访问带参数 URL | 控制台显示正确的 PlayerInfo（含 ts） |
| Bootstrap 接口 | 查看网络请求 | 请求包含 ts、nonce、sign，返回正常 |
| 签名时效性 | 使用过期 ts 测试 | 返回 SIGN_EXPIRED 错误 |
| 发送消息 | 输入文字发送 | 消息发送成功 |
| 图片上传 | 选择图片 | 图片上传成功显示 |
| 关闭 | 点击关闭按钮 | 执行对应关闭逻辑 |

**测试签名生成**：

使用 mock-game-server.js 或以下 Node.js 脚本生成测试签名：

```javascript
const crypto = require('crypto');

// 配置（与后台游戏配置一致）
const gameid = 'test_game';
const uid = 'player001';
const areaid = '1';
const playerName = '测试玩家';
const nonce = 'testnonce1234567';  // 后台配置的 playerApiNonce
const secret = 'test-secret-123';  // 后台配置的 playerApiSecret

// 生成签名（含时间戳）
const ts = Date.now();
const signStr = `${gameid}|${uid}|${areaid}|${ts}|${nonce}|${secret}`;
const sign = crypto.createHash('md5').update(signStr).digest('hex').toLowerCase();

// 输出测试 URL
console.log(`测试 URL（2小时内有效）：`);
console.log(`http://localhost:5173/?gameid=${gameid}&uid=${uid}&areaid=${areaid}&playerName=${encodeURIComponent(playerName)}&ts=${ts}&nonce=${nonce}&sign=${sign}&platform=web`);
```

**测试 URL 示例**：
```
http://localhost:5173/?gameid=test_game&uid=player001&areaid=1&playerName=测试&ts=1705123456789&nonce=testnonce1234567&sign=abc123...&platform=web
```

> **注意**：ts 为当前时间戳（毫秒），签名有效期 2 小时。过期后需重新生成。

### 7.2 APK 测试（步骤 12）

| 测试项 | 预期结果 |
|-------|---------|
| WebView 加载 | 能加载远程 H5 |
| getPlayerInfo | H5 能获取到玩家信息（含 ts） |
| 消息收发 | 正常 |
| 图片选择 | 弹出相册 |
| 图片上传 | 上传成功 |
| 关闭 | 返回游戏 |

### 7.3 签名时效性测试

| 测试项 | 测试方法 | 预期结果 |
|-------|---------|---------|
| 正常签名 | ts 为当前时间 | 请求成功 |
| 过期签名 | ts 为 3 小时前 | 返回 SIGN_EXPIRED |
| 缺少 ts | 不传 ts 参数 | 返回 MISSING_PARAMS |
| 错误签名 | 修改 sign 值 | 返回 INVALID_SIGN |

---

## 八、回滚方案

如果改造出现问题，可以回滚：

### 8.1 H5 回滚

```bash
git checkout -- webview-player/src/
```

### 8.2 APK 回滚

```bash
git checkout -- app/src/main/java/com/test/cswebview/bridge/
git checkout -- app/src/main/java/com/test/cswebview/ui/webview/
```

---

## 九、完成标准汇总

### 9.1 H5 端

- [ ] PlayerInfo 包含 ts、nonce、sign 字段
- [ ] NativeBridge 只有 2 个方法
- [ ] api.ts 实现完成（含签名参数附加）
- [ ] web.ts 改为 URL 参数模式（含 ts 解析）
- [ ] android.ts 只剩 2 个方法
- [ ] ios.ts 只剩 2 个方法
- [ ] useChat.ts 改用 api.ts
- [ ] vite.config.ts base 配置正确
- [ ] TypeScript 编译无错误
- [ ] URL 参数模式测试通过

### 9.2 APK 端

- [ ] AndroidBridge 只剩 2 个方法
- [ ] getPlayerInfo 返回值包含 ts
- [ ] 加载地址改为远程
- [ ] 删除 assets/web/
- [ ] APK 编译成功
- [ ] 完整功能测试通过

### 9.3 后端

- [ ] sign.guard.ts 添加 ts 时效性检查（2小时）
- [ ] 签名公式包含 ts 参数
- [ ] sign.dto.ts ts 参数设为签名认证必填
- [ ] SIGN_EXPIRED 错误码正确返回
- [ ] CORS 配置允许远程 H5 域名
- [ ] 签名时效性测试通过

---

## 十、预估工时

| 阶段 | 内容 | 预估时间 |
|-----|------|---------|
| 阶段一 | H5 端改造 | 3-4 小时 |
| 阶段二 | APK 壳子改造 | 1-2 小时 |
| 阶段三 | 集成测试 | 2-3 小时 |
| **总计** | | **6-9 小时** |

---

## 十一、版本记录

| 版本 | 日期 | 说明 |
|-----|------|------|
| 1.0 | 2024-01-13 | 初稿 |
| 1.1 | 2025-01-13 | 补充签名时效性方案（2小时过期）、后端改造清单、测试签名生成说明 |
