# WebView 远程模式测试指南

## 测试环境准备

### 1. 启动后端服务

```bash
cd backend
npm run dev
# 后端应运行在 http://localhost:21101
```

### 2. 启动前端（玩家端）

```bash
cd webview-player
npm run dev
# 玩家端应运行在 http://localhost:5173
```

### 3. 确保数据库和 Redis 运行

```bash
# 如果使用 Docker
npm run docker:up

# 验证数据库连接
npm run db:studio
```

---

## 测试场景 1: 浏览器远程模式测试

### 步骤 1: 生成测试 URL

```bash
node test-tools/generate-test-url.js
```

输出示例：
```
================================================================================
测试 URL 已生成（有效期 2 小时）
================================================================================

URL:
http://localhost:5173/?gameid=test_game&uid=player001&areaid=1&playerName=Test+Player&ts=1736899200000&nonce=testnonce1234567&sign=abc123def456...&apiUrl=http://localhost:21101&platform=web

详情:
  时间戳: 1736899200000 (2025-01-14T12:00:00.000Z)
  过期时间: 2025-01-14T14:00:00.000Z
  签名: abc123def456...

在浏览器中打开此 URL 测试远程模式
================================================================================
```

### 步骤 2: 浏览器打开测试 URL

1. 复制生成的 URL
2. 在浏览器中打开（Chrome/Edge/Firefox）
3. 打开浏览器控制台（F12）

### 步骤 3: 验证初始化

**控制台应显示**：
```
[Bridge] 检测到环境: url
[Web Bridge] URL 参数: { gameid: 'test_game', uid: 'player001', ts: 1736899200000, hasSign: true, 签名过期时间: '2025-01-14 22:00:00' }
[Chat] 玩家信息: { gameid: 'test_game', uid: 'player001', ... }
[API] 初始化完成: { gameid: 'test_game', uid: 'player001', ts: 1736899200000, apiBaseUrl: 'http://localhost:21101' }
[API] 请求: { endpoint: '/api/v1/player/connect', ts: 1736899200000 }
```

**验证点**：
- ✅ 环境检测为 `url`
- ✅ URL 参数正确解析
- ✅ API 初始化成功
- ✅ 请求包含 ts/nonce/sign 参数

### 步骤 4: 测试 Bootstrap 连接

**网络请求验证**（Network 标签）：
1. 找到 `POST /api/v1/player/connect` 请求
2. 查看请求体（Request Payload）：
   ```json
   {
     "gameid": "test_game",
     "uid": "player001",
     "areaid": "1",
     "playerName": "Test Player",
     "ts": 1736899200000,
     "nonce": "testnonce1234567",
     "sign": "abc123def456..."
   }
   ```
3. 查看响应（Response）：
   ```json
   {
     "success": true,
     "data": {
       "result": true,
       "wsUrl": "/socket.io",
       "wsToken": "xxx",
       "questList": [...],
       "activeTicket": null
     }
   }
   ```

**验证点**：
- ✅ 请求状态码 200
- ✅ 请求包含签名参数
- ✅ 响应返回 wsToken 和 questList
- ✅ 页面显示问题分类菜单

### 步骤 5: 测试 WebSocket 连接

**控制台应显示**：
```
[Socket] 开始连接: ws://localhost:21101/socket.io
[Chat] Socket 连接成功
[Chat] 收到 onConnectionReady: { tid: 'xxx' }
```

**验证点**：
- ✅ WebSocket 连接成功
- ✅ 收到 `onConnectionReady` 事件
- ✅ 输入框解锁（可以输入消息）

---

## 测试场景 2: 完整功能测试

### 2.1 创建新工单

1. 点击问题分类，例如"账号与充值问题"
2. 观察控制台和网络请求

**验证点**：
- ✅ 用户选择上屏显示
- ✅ 工单创建成功
- ✅ AI 自动回复欢迎消息

### 2.2 发送文字消息

1. 在输入框输入测试消息："你好，我的账号无法登录"
2. 点击发送

**验证点**：
- ✅ 消息立即显示在聊天界面
- ✅ 消息状态从 pending → delivered
- ✅ AI 自动回复（如果配置了 Dify）

### 2.3 上传图片

1. 点击图片上传按钮
2. 选择一张图片

**网络请求验证**：
```
POST /api/v1/player/upload
Headers: X-Upload-Token: xxx
Request: FormData { file: ... }
Response: { result: true, url: "/uploads/xxx.jpg" }
```

**验证点**：
- ✅ 图片上传成功
- ✅ 聊天界面显示图片缩略图
- ✅ 点击图片可预览

### 2.4 转人工测试

#### 场景 A: 无客服在线

1. 确保管理后台所有客服都已下线
2. 点击"转人工"按钮

**预期行为**（修复后）：
- ✅ **不显示** QueueBanner（排队横幅）
- ✅ **显示** AgentOfflineModal（客服离线弹窗）
- ✅ 系统消息："当前暂无客服在线，您的问题已转为【加急工单】，我们将优先处理。"
- ✅ 控制台日志：`[ChatStore] 设置排队位置: { position: 0, waitTime: null }`

#### 场景 B: 有客服在线

1. 在管理后台登录一个客服
2. 点击"转人工"按钮

**预期行为**：
- ✅ **显示** QueueBanner："排队中，前面还有 X 人"
- ✅ 客服接入后，显示客服名称
- ✅ 可以与客服正常聊天

### 2.5 关闭测试

1. 点击页面上的关闭按钮

**预期行为**（浏览器环境）：
- ✅ 尝试调用 `window.close()`
- ✅ 如果关闭失败，显示"会话已结束，请手动关闭此页面"

---

## 测试场景 3: 签名时效性测试

运行签名过期测试脚本：

```bash
node test-tools/test-signature-expiry.js
```

**预期输出**：
```
测试签名时效性...

[✓ 有效 - 当前时间] HTTP 200: {
  success: true,
  data: { result: true, wsUrl: '...', wsToken: '...' }
}

[✗ 过期 - 3小时前] HTTP 401: {
  success: false,
  message: '签名已过期，请重新进入',
  code: 'SIGN_EXPIRED'
}

[✗ 过期 - 3小时后] HTTP 401: {
  success: false,
  message: '签名已过期，请重新进入',
  code: 'SIGN_EXPIRED'
}
```

**验证点**：
- ✅ 当前时间戳签名通过验证
- ✅ 3 小时前的签名被拒绝
- ✅ 3 小时后的签名被拒绝（防止时间篡改）
- ✅ 错误提示友好

---

## 测试场景 4: 恢复旧工单

### 步骤：
1. 创建一个工单并发送几条消息
2. 点击关闭（不要真正关闭浏览器）
3. 重新生成 URL（`node test-tools/generate-test-url.js`）
4. 打开新 URL

**预期行为**：
- ✅ Bootstrap 返回 `activeTicket: { tid, status, createdAt }`
- ✅ 显示 TicketResumeModal："您有一个未关闭的咨询"
- ✅ 点击"继续咨询"，恢复聊天记录
- ✅ 历史消息正确显示（包括图片）

---

## 测试场景 5: 多平台关闭测试

### 5.1 Web 平台（默认）

URL: `?platform=web`

**行为**：调用 `window.close()`，失败则显示提示页面

### 5.2 iframe 嵌入

URL: `?platform=iframe`

**行为**：发送 `postMessage({ type: 'cs-close' }, '*')`

### 5.3 微信小程序

URL: `?platform=wxapp`

**行为**：调用 `wx.miniProgram.navigateBack()`

---

## 常见问题排查

### 问题 1: CORS 错误

**错误信息**：
```
Access to fetch at 'http://localhost:21101/api/v1/player/connect' from origin 'http://localhost:5173' has been blocked by CORS policy
```

**解决方案**：
检查 `backend/src/main.ts` 的 CORS 配置，确保包含 `http://localhost:5173`

### 问题 2: 签名验证失败

**错误信息**：
```
{ success: false, message: '签名验证失败', code: 'INVALID_SIGN' }
```

**排查步骤**：
1. 检查 `test-tools/generate-test-url.js` 中的 `secret` 是否与后台游戏配置一致
2. 检查签名公式是否正确：`md5(gameid|uid|areaid|ts|nonce|secret)`
3. 验证所有参数都已包含在 URL 中

### 问题 3: WebSocket 连接失败

**错误信息**：
```
WebSocket connection failed
```

**排查步骤**：
1. 检查后端是否正常运行
2. 检查 `api.getWsUrl()` 返回的 URL 是否正确
3. 验证 wsToken 是否有效（1小时过期）

### 问题 4: 图片上传失败

**错误信息**：
```
{ url: '' }
```

**排查步骤**：
1. 检查 uploadToken 是否有效（10分钟过期）
2. 验证后端上传目录权限
3. 检查文件大小是否超过限制

---

## 性能验证

### 网络请求优化

**优化点验证**：
- ✅ 图片懒加载生效
- ✅ 首次加载资源数 < 20 个
- ✅ 首屏时间 < 2 秒

### 内存占用

**Chrome DevTools Memory**：
- ✅ 长时间运行不泄漏（30分钟内存增长 < 20MB）
- ✅ 图片预览关闭后内存释放

---

## 测试检查清单

### 基础功能
- [ ] 生成测试 URL 成功
- [ ] 浏览器打开无报错
- [ ] URL 参数正确解析
- [ ] Bootstrap API 调用成功
- [ ] WebSocket 连接建立
- [ ] 输入框正常解锁

### 消息收发
- [ ] 发送文字消息成功
- [ ] 消息状态更新正常
- [ ] AI 自动回复正常
- [ ] 图片上传成功
- [ ] 图片显示正常
- [ ] 历史消息恢复正常

### 转人工流程
- [ ] 无客服在线 - 转加急工单（不显示排队）
- [ ] 有客服在线 - 正常排队
- [ ] 客服接入后正常聊天
- [ ] 客服离线弹窗正常显示

### 签名安全
- [ ] 当前时间签名通过
- [ ] 过期签名被拒绝
- [ ] 错误签名被拒绝
- [ ] 缺少参数被拒绝

### 工单管理
- [ ] 创建新工单成功
- [ ] 恢复旧工单成功
- [ ] 关闭工单成功
- [ ] 同一玩家只有一个活跃工单

### 边界测试
- [ ] 网络断开自动重连
- [ ] 签名即将过期仍可使用
- [ ] 长文本消息正常显示
- [ ] 大图片自动压缩上传
- [ ] 多次点击发送不重复

---

## 生产环境部署验证

### 1. 构建生产版本

```bash
cd webview-player
npm run build
```

**验证点**：
- ✅ 构建成功无报错
- ✅ dist 目录生成
- ✅ 资源路径使用绝对路径（base: '/'）

### 2. 部署到服务器

假设部署到 `https://cs.yourdomain.com`

**环境变量配置** (`.env.production`)：
```
VITE_API_URL=https://api.yourdomain.com
```

**后端 CORS 配置**：
```env
FRONTEND_URL=https://cs.yourdomain.com
```

### 3. 生成生产 URL

修改 `test-tools/generate-test-url.js`：
```javascript
const config = {
  // ...
  apiUrl: 'https://api.yourdomain.com',
  h5Url: 'https://cs.yourdomain.com'
};
```

### 4. 验证生产环境

- [ ] 生产 URL 可正常访问
- [ ] HTTPS 证书有效
- [ ] API 跨域请求成功
- [ ] WebSocket 连接成功（wss://）
- [ ] 所有功能正常

---

## 监控指标

### 日志关键字

**成功指标**：
```
[Bridge] 检测到环境: url
[API] 初始化完成
[Chat] Socket 连接成功
[Chat] 工单创建成功
```

**错误指标**：
```
SIGN_EXPIRED
INVALID_SIGN
CORS policy
WebSocket connection failed
```

### 后端监控

```bash
# 查看签名验证日志
grep "签名验证" backend/logs/*.log

# 统计签名过期错误
grep "SIGN_EXPIRED" backend/logs/*.log | wc -l

# 监控 WebSocket 连接
grep "WebSocket" backend/logs/*.log
```

---

## 总结

完成以上所有测试场景后，远程模式改造即验收通过。如有问题，参考"常见问题排查"章节进行定位。
