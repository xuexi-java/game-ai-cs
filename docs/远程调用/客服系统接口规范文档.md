# 客服系统接口规范文档

> 本文档定义客服 H5 与各平台客户端之间的接口约定，作为开发的契约依据。

---

## 一、概述

### 1.1 适用平台

| 平台 | 参数传递方式 | Bridge 要求 |
|-----|------------|------------|
| Android (Cocos APK) | JS Bridge | 需实现 |
| iOS (Cocos) | JS Bridge | 需实现 |
| 微信小程序 | URL 参数 | 不需要 |
| Flash/网页 | URL 参数 | 不需要 |

### 1.2 核心原则

```
1. 客户端只负责传递认证参数
2. H5 直接发起所有网络请求
3. 签名由游戏服务器计算，客户端只传递
4. H5 根据环境自动选择参数来源（Bridge 或 URL）
```

---

## 二、数据结构定义

### 2.1 PlayerInfo（玩家信息）

| 字段 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| gameid | string | 是 | 游戏标识（建议用包名） |
| uid | string | 是 | 玩家唯一标识 |
| areaid | string | 是 | 区服标识 |
| playerName | string | 否 | 玩家昵称 |
| nonce | string | 是 | 固定随机串（与后台配置一致） |
| sign | string | 是 | 签名（游戏服务器计算） |

**示例**：

```json
{
  "gameid": "com.company.sword",
  "uid": "player_10001",
  "areaid": "1",
  "playerName": "张三",
  "nonce": "fixed_nonce_abc123",
  "sign": "e8b7c9d2a1f4e6b8c3d9a0f1e2b3c4d5"
}
```

### 2.2 签名算法

```
签名公式：
sign = md5(gameid + "|" + uid + "|" + areaid + "|" + nonce + "|" + secret).toLowerCase()

示例：
gameid  = "com.company.sword"
uid     = "player_10001"
areaid  = "1"
nonce   = "fixed_nonce_abc123"
secret  = "your_secret_key_here"

拼接串 = "com.company.sword|player_10001|1|fixed_nonce_abc123|your_secret_key_here"
sign   = md5(拼接串).toLowerCase()
       = "e8b7c9d2a1f4e6b8c3d9a0f1e2b3c4d5"
```

**注意**：secret 只存在于游戏服务器和客服后台，客户端不能获取。

---

## 三、Bridge 接口规范（Android/iOS）

### 3.1 接口列表

| 方法 | 类型 | 说明 |
|-----|------|------|
| getPlayerInfo() | 同步/异步 | 获取玩家信息（含签名） |
| close() | 同步 | 关闭 WebView |

### 3.2 Android Bridge

**注入名称**：`AndroidBridge`

**getPlayerInfo()**

```
调用方式：同步
H5 调用：window.AndroidBridge.getPlayerInfo()
返回值：JSON 字符串
```

返回示例：
```json
{
  "gameid": "com.company.sword",
  "uid": "player_10001",
  "areaid": "1",
  "playerName": "张三",
  "nonce": "fixed_nonce_abc123",
  "sign": "e8b7c9d2a1f4e6b8c3d9a0f1e2b3c4d5"
}
```

**close()**

```
调用方式：同步
H5 调用：window.AndroidBridge.close()
返回值：无
行为：关闭 WebView，返回游戏
```

### 3.3 iOS Bridge

**注入名称**：`webkit.messageHandlers.iosBridge`

**getPlayerInfo()**

```
调用方式：异步（postMessage + 回调）
H5 调用：
  window.webkit.messageHandlers.iosBridge.postMessage({
    action: 'getPlayerInfo',
    callbackId: 'callback_001'
  })

iOS 回调：
  window.__iosCallback('callback_001', '{"gameid":"...","sign":"..."}')

返回值：JSON 字符串（通过回调）
```

**close()**

```
调用方式：同步
H5 调用：
  window.webkit.messageHandlers.iosBridge.postMessage({
    action: 'close'
  })

行为：关闭 WebView，返回游戏
```

---

## 四、URL 参数规范（小程序/Flash/网页）

### 4.1 参数列表

| 参数 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| gameid | string | 是 | 游戏标识 |
| uid | string | 是 | 玩家唯一标识 |
| areaid | string | 是 | 区服标识 |
| playerName | string | 否 | 玩家昵称（需 URL 编码） |
| nonce | string | 是 | 固定随机串 |
| sign | string | 是 | 签名 |
| platform | string | 否 | 平台标识，用于关闭行为 |

### 4.2 platform 取值

| 值 | 说明 | 关闭行为 |
|---|------|---------|
| wxapp | 微信小程序 | wx.miniProgram.navigateBack() |
| web | 网页弹窗 | window.close() |
| iframe | 网页 iframe | parent.postMessage({ type: 'cs-close' }) |
| 不传 | 默认 | window.close() |

### 4.3 URL 示例

**微信小程序**：
```
https://cs.example.com/webview?gameid=com.company.sword&uid=player_10001&areaid=1&playerName=%E5%BC%A0%E4%B8%89&nonce=fixed_nonce_abc123&sign=e8b7c9d2a1f4e6b8&platform=wxapp
```

**网页弹窗**：
```
https://cs.example.com/webview?gameid=com.company.sword&uid=player_10001&areaid=1&playerName=%E5%BC%A0%E4%B8%89&nonce=fixed_nonce_abc123&sign=e8b7c9d2a1f4e6b8&platform=web
```

**iframe 嵌入**：
```
https://cs.example.com/webview?gameid=com.company.sword&uid=player_10001&areaid=1&nonce=fixed_nonce_abc123&sign=e8b7c9d2a1f4e6b8&platform=iframe
```

---

## 五、H5 环境检测逻辑

### 5.1 检测顺序

```
1. 检查 window.AndroidBridge 是否存在
   → 存在：Android Bridge 模式

2. 检查 window.webkit?.messageHandlers?.iosBridge 是否存在
   → 存在：iOS Bridge 模式

3. 检查 URL 是否包含 gameid 参数
   → 包含：URL 参数模式

4. 以上都不满足
   → 开发测试模式（Mock）
```

### 5.2 伪代码

```javascript
function detectEnvironment() {
  if (window.AndroidBridge) {
    return 'android'
  }
  if (window.webkit?.messageHandlers?.iosBridge) {
    return 'ios'
  }
  if (new URLSearchParams(location.search).has('gameid')) {
    return 'url'
  }
  return 'mock'
}
```

---

## 六、关闭行为规范

### 6.1 各平台关闭方式

| 环境 | 关闭方式 | 说明 |
|-----|---------|------|
| Android | AndroidBridge.close() | 由 Native 处理 |
| iOS | postMessage({ action: 'close' }) | 由 Native 处理 |
| 小程序 | wx.miniProgram.navigateBack() | 返回小程序页面 |
| 网页弹窗 | window.close() | 关闭弹窗 |
| iframe | parent.postMessage({ type: 'cs-close' }) | 通知父页面 |

### 6.2 关闭消息格式（iframe 模式）

```javascript
// H5 发送
parent.postMessage({ type: 'cs-close' }, '*')

// 父页面监听
window.addEventListener('message', (event) => {
  if (event.data?.type === 'cs-close') {
    // 移除 iframe 或隐藏客服窗口
  }
})
```

---

## 七、WebView 配置要求

### 7.1 Android WebView

| 配置项 | 值 | 说明 |
|-------|---|------|
| javaScriptEnabled | true | 启用 JS |
| domStorageEnabled | true | 启用 DOM Storage |
| allowFileAccess | true | 允许文件访问 |
| mixedContentMode | MIXED_CONTENT_ALWAYS_ALLOW | 允许混合内容 |
| onShowFileChooser | 需实现 | 支持图片选择 |

### 7.2 iOS WKWebView

| 配置项 | 说明 |
|-------|------|
| javaScriptEnabled | 默认启用 |
| allowsInlineMediaPlayback | 建议启用 |
| 相册权限 | Info.plist 配置 NSPhotoLibraryUsageDescription |

### 7.3 图片选择支持

**Android**：需要实现 `WebChromeClient.onShowFileChooser()`

**iOS**：WKWebView 默认支持，需声明相册权限

**小程序**：web-view 内 `<input type="file">` 可能受限，需实测

---

## 八、错误码定义

### 8.1 H5 → 客户端错误

| 错误场景 | 处理方式 |
|---------|---------|
| Bridge 不存在 | 降级到 URL 参数模式或显示错误 |
| getPlayerInfo 返回空 | 显示「获取玩家信息失败」 |
| close 调用失败 | 显示「请手动关闭页面」 |

### 8.2 常见问题

| 问题 | 原因 | 解决 |
|-----|------|------|
| H5 白屏 | Bridge 未注入 | 检查 addJavascriptInterface |
| 签名验证失败 | sign 计算错误 | 检查签名算法和参数顺序 |
| 图片选择无响应 | 未实现 onShowFileChooser | 实现该方法 |
| 关闭无效 | close 方法未实现 | 检查 Bridge 实现 |

---

## 九、版本记录

| 版本 | 日期 | 说明 |
|-----|------|------|
| 1.0 | 2024-01-13 | 初稿，定义 Bridge 和 URL 参数规范 |

---

## 附录 A：TypeScript 类型定义

```typescript
// 玩家信息
interface PlayerInfo {
  gameid: string
  uid: string
  areaid: string
  playerName?: string
  nonce: string
  sign: string
}

// 简化后的 Bridge 接口
interface NativeBridge {
  // 获取玩家信息（含签名）
  getPlayerInfo(): PlayerInfo | Promise<PlayerInfo>

  // 关闭 WebView
  close(): void
}

// 环境类型
type BridgeEnv = 'android' | 'ios' | 'url' | 'mock'
```

---

## 附录 B：各平台快速参考

### Android 最小实现

```kotlin
class CSBridge(private val playerInfo: PlayerInfo) {

    @JavascriptInterface
    fun getPlayerInfo(): String {
        return Gson().toJson(playerInfo)
    }

    @JavascriptInterface
    fun close() {
        activity.finish()
    }
}

// 注入
webView.addJavascriptInterface(CSBridge(playerInfo), "AndroidBridge")
```

### iOS 最小实现

```swift
func userContentController(_ controller: WKUserContentController,
                           didReceive message: WKScriptMessage) {
    guard let body = message.body as? [String: Any],
          let action = body["action"] as? String else { return }

    switch action {
    case "getPlayerInfo":
        let callbackId = body["callbackId"] as? String ?? ""
        let json = // ... 构造 PlayerInfo JSON
        webView.evaluateJavaScript("window.__iosCallback('\(callbackId)', '\(json)')")

    case "close":
        dismiss(animated: true)
    }
}
```

### 小程序最小实现

```javascript
// 获取签名后拼接 URL
const query = `gameid=${p.gameid}&uid=${p.uid}&areaid=${p.areaid}&nonce=${p.nonce}&sign=${p.sign}&platform=wxapp`
const url = `https://cs.example.com/webview?${query}`

// 使用 web-view
<web-view src="{{url}}" />
```

### 网页弹窗最小实现

```javascript
function openCS(params) {
  const query = new URLSearchParams({ ...params, platform: 'web' })
  window.open(`https://cs.example.com/webview?${query}`, 'cs', 'width=400,height=700')
}
```
