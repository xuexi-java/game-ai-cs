# 端口规划总结

## 端口分配方案

系统采用分段式端口规划，便于管理和识别：

### 20xxx - 前端服务
| 端口 | 服务 | 说明 |
|------|------|------|
| 20101 | admin-portal | 管理端（客服工作台） |
| 20102 | player-app | 玩家端（提交工单） |

### 21xxx - 后端服务
| 端口 | 服务 | 说明 |
|------|------|------|
| 21101 | backend | NestJS 后端 API |

### 22xxx - 数据存储
| 端口 | 服务 | 说明 |
|------|------|------|
| 22101 | PostgreSQL | 主数据库 |
| 22102 | Redis | 缓存和消息队列 |

### 23xxx - 运维监控
| 端口 | 服务 | 说明 |
|------|------|------|
| 23101 | Prometheus | 指标收集 |
| 23102 | Loki | 日志聚合 |
| 23103 | Grafana | 可视化监控 |

## 访问地址

### 用户访问
- **管理端**: http://localhost:20101
  - 默认账号: admin / admin123
  - 功能: 客服工作台、工单管理、系统配置

- **玩家端**: http://localhost:20102
  - 无需登录
  - 功能: 提交工单、查看进度

### 开发访问
- **后端 API**: http://localhost:21101/api/v1
- **API 文档**: http://localhost:21101/api/v1/docs
- **Swagger UI**: http://localhost:21101/api/v1/docs

### 运维访问
- **Prometheus**: http://localhost:23101
  - 查看指标: http://localhost:23101/graph
  - 查看目标: http://localhost:23101/targets

- **Grafana**: http://localhost:23103
  - 默认账号: admin / admin
  - Dashboard: http://localhost:23103/dashboards

- **Loki**: http://localhost:23102
  - 日志查询 API

## Docker 端口映射

### docker-compose.yml
```yaml
services:
  admin-portal:
    ports:
      - "20101:20101"  # 管理端
  
  player-app:
    ports:
      - "20102:20102"  # 玩家端
  
  backend:
    ports:
      - "21101:21101"  # 后端 API
  
  postgres:
    ports:
      - "22101:5432"   # PostgreSQL
  
  redis:
    ports:
      - "22102:6379"   # Redis
```

### docker-compose.monitoring.yml
```yaml
services:
  prometheus:
    ports:
      - "23101:9090"   # Prometheus
  
  loki:
    ports:
      - "23102:3100"   # Loki
  
  grafana:
    ports:
      - "23103:3000"   # Grafana
```

## 端口检查命令

### Windows (PowerShell)
```powershell
# 检查所有服务端口
netstat -ano | findstr "20101 20102 21101 22101 22102 23101 23102 23103"

# 检查单个端口
netstat -ano | findstr "20101"
```

### Linux/Mac
```bash
# 检查所有服务端口
lsof -i :20101 -i :20102 -i :21101 -i :22101 -i :22102 -i :23101 -i :23102 -i :23103

# 检查单个端口
lsof -i :20101
```

## 防火墙配置

### 生产环境建议

**对外开放端口**（需要配置防火墙规则）：
- 20101 - 管理端（仅内网访问）
- 20102 - 玩家端（公网访问）
- 21101 - 后端 API（仅内网访问，通过 Nginx 反向代理）

**内部端口**（不对外开放）：
- 22101 - PostgreSQL（仅容器内部访问）
- 22102 - Redis（仅容器内部访问）
- 23101 - Prometheus（仅运维访问）
- 23102 - Loki（仅运维访问）
- 23103 - Grafana（仅运维访问）

### Ubuntu 防火墙配置示例
```bash
# 允许管理端（内网）
sudo ufw allow from 10.0.0.0/8 to any port 20101

# 允许玩家端（公网）
sudo ufw allow 20102

# 允许后端 API（内网）
sudo ufw allow from 10.0.0.0/8 to any port 21101

# 允许 Grafana（运维）
sudo ufw allow from 10.0.0.0/8 to any port 23103
```

## 端口冲突解决

### 检查端口占用
```bash
# Windows
netstat -ano | findstr "端口号"

# Linux/Mac
lsof -i :端口号
```

### 修改端口步骤

如果需要修改端口，请按以下步骤操作：

1. **修改 Docker Compose 配置**
   - `docker-compose.yml` - 修改 ports 映射
   - `docker-compose.monitoring.yml` - 修改 ports 映射

2. **修改前端配置**（如果修改前端端口）
   - `frontend/*/nginx.conf` - 修改 listen 端口
   - `frontend/*/Dockerfile` - 修改 EXPOSE 端口
   - `frontend/*/vite.config.ts` - 修改 server.port

3. **修改后端配置**（如果修改后端端口）
   - `docker-compose.yml` - 修改 PORT 环境变量
   - `backend/.env` - 修改 PORT 配置
   - `frontend/*/nginx.conf` - 修改 proxy_pass 地址

4. **重启服务**
   ```bash
   docker-compose down
   docker-compose up -d --build
   ```

## 常见问题

### Q: 为什么使用这种端口分配方案？
A: 
- 便于识别：通过端口号段快速识别服务类型
- 避免冲突：使用非标准端口避免与系统服务冲突
- 易于管理：相关服务端口连续，便于批量操作

### Q: 可以使用标准端口吗（如80、443）？
A: 
- 开发环境不建议，可能与其他服务冲突
- 生产环境建议使用 Nginx 反向代理，将标准端口映射到内部端口
- 例如：80 -> 20102（玩家端），443 -> 20102（HTTPS）

### Q: 端口被占用怎么办？
A:
1. 检查占用进程：`netstat -ano | findstr "端口号"`
2. 停止占用进程或修改配置使用其他端口
3. 如果是系统服务，建议修改本项目端口

## 相关文档

- [端口配置说明](./端口配置说明.md)
- [Docker部署问题修复说明](./Docker部署问题修复说明.md)
- [运维部署命令](./运维部署命令.md)
