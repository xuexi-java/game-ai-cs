# AI 客服系统 - 技术文档

## 文档信息

- **文档版本**: V1.0
- **项目代号**: game-ai-cs
- **最后更新**: 2024

## 1. 系统概述

### 1.1. 系统架构

本系统采用前后端分离的微服务架构，主要包含以下组件：

```
┌─────────────────┐
│   玩家端 (Web)   │  React + TypeScript
└────────┬────────┘
         │ HTTP/WebSocket
┌────────▼────────┐
│   API Gateway    │  Nest.js
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
┌───▼───┐ ┌──▼────┐
│ 业务服务 │ │ AI服务 │
│Nest.js │ │ Dify  │
└───┬───┘ └───────┘
    │
┌───▼────┐
│PostgreSQL│
│ 数据库   │
└─────────┘
```

### 1.2. 技术栈

#### 后端技术栈

- **框架**: Nest.js 10.x
- **语言**: TypeScript 5.x
- **数据库**: PostgreSQL 14+
- **ORM**: Prisma 5.x
- **认证**: JWT (jsonwebtoken)
- **加密**: bcrypt, crypto
- **WebSocket**: Socket.io
- **文件存储**: 本地存储 / OSS (可选)
- **任务队列**: Bull (Redis) - 用于异步任务
- **日志**: Winston
- **API文档**: Swagger/OpenAPI

#### 前端技术栈

**玩家端 (Player App)**:
- **框架**: React 18.x
- **语言**: TypeScript 5.x
- **状态管理**: Zustand / Redux Toolkit
- **UI组件库**: Ant Design / Material-UI
- **路由**: React Router 6.x
- **HTTP客户端**: Axios
- **WebSocket客户端**: Socket.io-client
- **文件上传**: react-dropzone
- **构建工具**: Vite

**管理端 (Admin Portal)**:
- **框架**: React 18.x
- **语言**: TypeScript 5.x
- **状态管理**: Zustand / Redux Toolkit
- **UI组件库**: Ant Design Pro
- **路由**: React Router 6.x
- **HTTP客户端**: Axios
- **权限控制**: React Router Guard
- **图表库**: ECharts / Recharts

#### 基础设施

- **容器化**: Docker + Docker Compose
- **反向代理**: Nginx
- **缓存**: Redis
- **消息队列**: Redis (Bull)
- **监控**: Prometheus + Grafana (可选)
- **日志收集**: ELK Stack (可选)

## 2. 系统架构设计

### 2.1. 分层架构

```
┌─────────────────────────────────────┐
│         Presentation Layer          │
│    (Controllers / API Routes)       │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│         Application Layer           │
│      (Services / Use Cases)          │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│          Domain Layer                │
│    (Entities / Business Logic)      │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│        Infrastructure Layer          │
│  (Database / External APIs / Cache)   │
└──────────────────────────────────────┘
```

### 2.2. 模块划分

#### 后端模块

```
src/
├── auth/              # 认证授权模块
│   ├── guards/       # 路由守卫
│   ├── decorators/   # 装饰器
│   └── strategies/    # JWT策略
├── game/              # 游戏管理模块
├── ticket/            # 工单模块
├── session/           # 会话模块
├── message/           # 消息模块
├── agent/             # 客服模块
├── urgency-rule/      # 紧急排序规则模块
├── satisfaction/      # 满意度评价模块
├── upload/            # 文件上传模块
├── dify/              # Dify AI集成模块
├── queue/             # 队列管理模块
├── common/            # 公共模块
│   ├── filters/      # 异常过滤器
│   ├── interceptors/ # 拦截器
│   ├── pipes/        # 管道
│   └── decorators/   # 装饰器
└── config/           # 配置模块
```

#### 前端模块

**玩家端**:
```
src/
├── pages/
│   ├── identity-check/    # 身份验证页面
│   ├── escape-hatch/      # 逃生舱页面
│   ├── intake-form/        # 前置分流表单
│   ├── chat/              # 聊天页面
│   └── queue/             # 排队页面
├── components/
│   ├── chat/              # 聊天组件
│   ├── form/              # 表单组件
│   └── common/            # 通用组件
├── stores/                # 状态管理
├── services/              # API服务
├── hooks/                 # 自定义Hooks
└── utils/                 # 工具函数
```

**管理端**:
```
src/
├── pages/
│   ├── login/             # 登录页
│   ├── workbench/         # 会话管理
│   ├── tickets/           # 工单管理
│   ├── dashboard/         # 数据分析
│   ├── settings/          # 系统设置
│   └── urgency-rules/     # 紧急排序规则
├── components/
│   ├── chat/              # 聊天组件
│   ├── ticket/           # 工单组件
│   └── common/            # 通用组件
├── stores/                # 状态管理
├── services/              # API服务
├── guards/                # 路由守卫
└── utils/                 # 工具函数
```

## 3. API 设计

### 3.1. API 规范

- **协议**: HTTP/HTTPS
- **数据格式**: JSON
- **认证方式**: JWT Bearer Token
- **版本控制**: URL路径版本控制 (`/api/v1/...`)
- **错误码**: 标准HTTP状态码 + 自定义业务错误码

### 3.2. 玩家端 API

#### 3.2.1. 身份验证

```typescript
// 检查玩家是否有未关闭工单
POST /api/v1/player/identity-check
Request Body:
{
  gameId: string;
  serverId?: string;
  serverName?: string;  // 玩家输入的区服
  playerIdOrName: string;
}

Response:
{
  hasOpenTicket: boolean;
  ticketNo?: string;
  ticketId?: string;
}
```

#### 3.2.2. 创建工单

```typescript
// 创建新工单
POST /api/v1/player/tickets
Request Body:
{
  gameId: string;
  serverId?: string;
  serverName?: string;
  playerIdOrName: string;
  description: string;
  occurredAt?: string;  // ISO 8601
  paymentOrderNo?: string;
  attachments?: File[];  // multipart/form-data
}

Response:
{
  ticketId: string;
  ticketNo: string;
  token: string;
}
```

#### 3.2.3. 会话管理

```typescript
// 创建会话
POST /api/v1/player/sessions
Headers: { Authorization: Bearer {token} }
Request Body:
{
  ticketId: string;
}

Response:
{
  sessionId: string;
  initialReply: string;
  suggestedOptions: string[];
}
```

#### 3.2.4. 消息发送

```typescript
// 发送消息
POST /api/v1/player/sessions/:sessionId/messages
Headers: { Authorization: Bearer {token} }
Request Body:
{
  content: string;
  messageType?: 'TEXT' | 'IMAGE';
}

Response:
{
  messageId: string;
  createdAt: string;
}
```

#### 3.2.5. 转人工

```typescript
// 请求转人工
POST /api/v1/player/sessions/:sessionId/transfer-to-agent
Headers: { Authorization: Bearer {token} }
Request Body:
{
  urgency: 'URGENT' | 'NON_URGENT';
}

Response:
{
  queued: boolean;
  queuePosition?: number;
  estimatedWaitTime?: number;
}
```

#### 3.2.6. 满意度评价

```typescript
// 提交满意度评价
POST /api/v1/player/sessions/:sessionId/rating
Headers: { Authorization: Bearer {token} }
Request Body:
{
  rating: number;  // 1-5
  tags: string[];
  comment?: string;
}

Response:
{
  success: boolean;
}
```

### 3.3. 管理端 API

#### 3.3.1. 认证

```typescript
// 登录
POST /api/v1/admin/auth/login
Request Body:
{
  username: string;
  password: string;
}

Response:
{
  accessToken: string;
  refreshToken?: string;
  user: {
    id: string;
    username: string;
    role: 'ADMIN' | 'AGENT';
  };
}
```

#### 3.3.2. 会话管理

```typescript
// 获取待接入会话列表
GET /api/v1/admin/workbench/sessions
Query: {
  status?: 'PENDING' | 'QUEUED';
  page?: number;
  pageSize?: number;
}

Response:
{
  items: Array<{
    sessionId: string;
    ticketNo: string;
    gameName: string;
    playerIdOrName: string;
    waitTime: number;  // 秒
    priorityScore: number;
  }>;
  total: number;
  page: number;
  pageSize: number;
}

// 接入会话
POST /api/v1/admin/workbench/sessions/:sessionId/join
Response:
{
  sessionId: string;
  ticket: Ticket;
  messages: Message[];
}

// 结束会话
POST /api/v1/admin/workbench/sessions/:sessionId/close
```

#### 3.3.3. 消息管理

```typescript
// 发送消息
POST /api/v1/admin/workbench/sessions/:sessionId/messages
Request Body:
{
  content: string;
  messageType?: 'TEXT' | 'IMAGE';
}

// AI优化消息
POST /api/v1/admin/workbench/messages/optimize
Request Body:
{
  content: string;
  context?: string;  // 上下文信息
}

Response:
{
  optimizedContent: string;
}
```

#### 3.3.4. 工单管理

```typescript
// 获取工单列表
GET /api/v1/admin/tickets
Query: {
  status?: TicketStatus;
  priority?: Priority;
  gameId?: string;
  page?: number;
  pageSize?: number;
  sortBy?: 'priority' | 'createdAt';
  sortOrder?: 'asc' | 'desc';
}

// 回复工单
POST /api/v1/admin/tickets/:ticketId/reply
Request Body:
{
  content: string;
}

Response:
{
  messageId: string;
  // 自动触发游戏内邮件通知
}
```

#### 3.3.5. 游戏管理

```typescript
// 获取游戏列表
GET /api/v1/admin/games

// 创建游戏
POST /api/v1/admin/games
Request Body:
{
  name: string;
  icon?: string;
  difyApiKey: string;
  difyBaseUrl: string;
  enabled: boolean;
}

// 更新游戏
PUT /api/v1/admin/games/:gameId

// 删除游戏
DELETE /api/v1/admin/games/:gameId

// 管理区服
POST /api/v1/admin/games/:gameId/servers
PUT /api/v1/admin/games/:gameId/servers/:serverId
DELETE /api/v1/admin/games/:gameId/servers/:serverId
```

#### 3.3.6. 紧急排序规则

```typescript
// 获取规则列表
GET /api/v1/admin/urgency-rules

// 创建规则
POST /api/v1/admin/urgency-rules
Request Body:
{
  name: string;
  enabled: boolean;
  priorityWeight: number;  // 1-100
  description?: string;
  conditions: {
    keywords?: string[];
    intent?: string;
    identityStatus?: IdentityStatus;
    gameId?: string;
    serverId?: string;
    priority?: Priority;
  };
}

// 更新规则
PUT /api/v1/admin/urgency-rules/:ruleId

// 删除规则
DELETE /api/v1/admin/urgency-rules/:ruleId

// 重新计算队列排序
POST /api/v1/admin/urgency-rules/recalculate-queue
```

#### 3.3.7. 数据分析

```typescript
// 获取核心指标
GET /api/v1/admin/dashboard/metrics
Query: {
  startDate?: string;
  endDate?: string;
  gameId?: string;
}

Response:
{
  aiInterceptRate: number;      // AI拦截率
  transferToAgentRate: number;  // 转人工率
  avgTicketResolutionTime: number;  // 平均工单解决时长（小时）
  totalSessions: number;
  totalTickets: number;
  avgSatisfactionRating: number;
}
```

### 3.4. WebSocket API

#### 3.4.1. 玩家端事件

```typescript
// 连接
socket.connect({ token: string });

// 事件
socket.on('message', (message: Message) => {});
socket.on('agent-joined', () => {});
socket.on('queue-update', (data: { position: number; waitTime: number }) => {});
socket.on('session-closed', () => {});

// 发送消息
socket.emit('send-message', { content: string });
```

#### 3.4.2. 管理端事件

```typescript
// 连接
socket.connect({ token: string });

// 事件
socket.on('new-session', (session: Session) => {});
socket.on('message', (message: Message) => {});
socket.on('session-updated', (session: Session) => {});

// 发送消息
socket.emit('send-message', { sessionId: string; content: string });
```

## 4. 核心业务逻辑

### 4.1. 身份验证流程

```typescript
// 伪代码
async function checkPlayerIdentity(gameId, serverId, playerIdOrName) {
  // 1. 查询是否有未关闭工单
  const openTicket = await ticketRepository.findOpenTicket({
    gameId,
    serverId,
    playerIdOrName
  });
  
  if (openTicket) {
    return { hasOpenTicket: true, ticketNo: openTicket.ticketNo };
  }
  
  return { hasOpenTicket: false };
}
```

### 4.2. 工单创建流程

```typescript
async function createTicket(data) {
  // 1. 创建工单
  const ticket = await ticketRepository.create({
    ...data,
    status: 'NEW',
    identityStatus: 'NOT_VERIFIED',
    ticketNo: generateTicketNo(),
    token: generateToken()
  });
  
  // 2. 上传附件
  if (data.attachments) {
    await uploadAttachments(ticket.id, data.attachments);
  }
  
  // 3. 异步验证身份（如果有订单号）
  if (data.paymentOrderNo) {
    verifyPaymentIdentity(ticket.id, data.playerIdOrName, data.paymentOrderNo);
  }
  
  return ticket;
}
```

### 4.3. AI引导流程

```typescript
async function startAISession(ticketId) {
  const ticket = await ticketRepository.findById(ticketId);
  const game = await gameRepository.findById(ticket.gameId);
  
  // 1. 调用Dify API
  const difyResponse = await difyService.triage({
    apiKey: game.difyApiKey,
    baseUrl: game.difyBaseUrl,
    description: ticket.description
  });
  
  // 2. 创建会话
  const session = await sessionRepository.create({
    ticketId,
    status: 'PENDING',
    detectedIntent: difyResponse.detected_intent,
    aiUrgency: difyResponse.urgency
  });
  
  // 3. 保存AI初始回复
  await messageRepository.create({
    sessionId: session.id,
    senderType: 'AI',
    content: difyResponse.initial_reply,
    messageType: 'TEXT',
    metadata: { suggestedOptions: difyResponse.suggested_options }
  });
  
  return session;
}
```

### 4.4. 紧急排序算法

```typescript
async function calculatePriorityScore(sessionId) {
  const session = await sessionRepository.findById(sessionId);
  const ticket = await ticketRepository.findById(session.ticketId);
  const rules = await urgencyRuleRepository.findEnabled();
  
  let totalScore = 0;
  
  for (const rule of rules) {
    if (matchRule(rule.conditions, ticket, session)) {
      totalScore += rule.priorityWeight;
    }
  }
  
  await sessionRepository.update(sessionId, {
    priorityScore: totalScore
  });
  
  return totalScore;
}

function matchRule(conditions, ticket, session) {
  // 关键词匹配
  if (conditions.keywords) {
    const matches = conditions.keywords.some(keyword =>
      ticket.description.includes(keyword)
    );
    if (!matches) return false;
  }
  
  // 意图匹配
  if (conditions.intent && session.detectedIntent !== conditions.intent) {
    return false;
  }
  
  // 身份状态匹配
  if (conditions.identityStatus && ticket.identityStatus !== conditions.identityStatus) {
    return false;
  }
  
  // 游戏匹配
  if (conditions.gameId && ticket.gameId !== conditions.gameId) {
    return false;
  }
  
  // 优先级匹配
  if (conditions.priority && ticket.priority !== conditions.priority) {
    return false;
  }
  
  return true;
}
```

### 4.5. 排队队列管理

```typescript
async function addToQueue(sessionId) {
  // 1. 计算优先级分数
  await calculatePriorityScore(sessionId);
  
  // 2. 更新会话状态
  await sessionRepository.update(sessionId, {
    status: 'QUEUED',
    queuedAt: new Date()
  });
  
  // 3. 重新排序队列
  await reorderQueue();
  
  // 4. 通知玩家排队位置
  notifyPlayerQueuePosition(sessionId);
}

async function reorderQueue() {
  const queuedSessions = await sessionRepository.findQueued();
  
  // 按优先级分数降序，相同分数按时间升序
  queuedSessions.sort((a, b) => {
    if (a.priorityScore !== b.priorityScore) {
      return b.priorityScore - a.priorityScore;
    }
    return a.queuedAt.getTime() - b.queuedAt.getTime();
  });
  
  // 更新排队位置（可选，用于显示）
  for (let i = 0; i < queuedSessions.length; i++) {
    await sessionRepository.update(queuedSessions[i].id, {
      queuePosition: i + 1
    });
  }
}
```

## 5. 安全设计

### 5.1. 认证授权

- **JWT Token**: 使用JWT进行无状态认证
- **Token过期**: Token有效期8小时，支持刷新机制
- **密码加密**: 使用BCrypt加密，salt rounds = 10
- **API Key加密**: Dify API Key使用AES-256加密存储

### 5.2. 数据安全

- **输入验证**: 所有用户输入进行验证和清理
- **SQL注入防护**: 使用Prisma ORM参数化查询
- **XSS防护**: 前端输出转义
- **CSRF防护**: 使用CSRF Token
- **文件上传**: 限制文件类型和大小，病毒扫描

### 5.3. 接口安全

- **Rate Limiting**: API限流，防止暴力攻击
- **CORS配置**: 严格配置跨域策略
- **HTTPS**: 生产环境强制使用HTTPS
- **敏感信息**: 不在日志中记录敏感信息

## 6. 性能优化

### 6.1. 数据库优化

- **索引优化**: 为常用查询字段建立索引
- **查询优化**: 使用JOIN替代N+1查询
- **连接池**: 配置数据库连接池
- **读写分离**: 考虑读写分离（可选）

### 6.2. 缓存策略

- **Redis缓存**: 
  - 游戏配置信息（TTL: 1小时）
  - 在线客服列表（TTL: 5分钟）
  - 紧急排序规则（TTL: 10分钟）
  - 会话状态（TTL: 实时）

### 6.3. 异步处理

- **任务队列**: 使用Bull处理异步任务
  - 身份验证（支付网关API调用）
  - 游戏内邮件通知
  - 数据分析计算

## 7. 部署方案

### 7.1. 开发环境

```yaml
# docker-compose.dev.yml
version: '3.8'
services:
  postgres:
    image: postgres:14
    environment:
      POSTGRES_DB: game_ai_cs
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
  
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
  
  backend:
    build: ./backend
    ports:
      - "3000:3000"
    environment:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/game_ai_cs
      REDIS_URL: redis://redis:6379
    depends_on:
      - postgres
      - redis
```

### 7.2. 生产环境

- **容器化部署**: Docker + Kubernetes
- **负载均衡**: Nginx / AWS ALB
- **数据库**: PostgreSQL RDS（主从复制）
- **缓存**: Redis Cluster
- **CDN**: 静态资源和图片使用CDN
- **监控**: Prometheus + Grafana
- **日志**: ELK Stack

## 8. 开发规范

### 8.1. 代码规范

- **TypeScript**: 严格模式，启用所有严格检查
- **ESLint**: 使用Airbnb配置
- **Prettier**: 代码格式化
- **Git Commit**: 遵循Conventional Commits规范

### 8.2. 测试规范

- **单元测试**: Jest，覆盖率 > 80%
- **集成测试**: 关键业务流程
- **E2E测试**: Playwright / Cypress

### 8.3. 文档规范

- **API文档**: Swagger自动生成
- **代码注释**: JSDoc格式
- **README**: 项目说明和快速开始

## 9. 附录

### 9.1. 环境变量配置

```env
# 数据库
DATABASE_URL=postgresql://user:password@localhost:5432/game_ai_cs

# Redis
REDIS_URL=redis://localhost:6379

# JWT
JWT_SECRET=your-secret-key
JWT_EXPIRES_IN=8h

# 文件上传
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=10485760  # 10MB

# Dify (默认配置，实际使用游戏配置)
DIFY_API_KEY=default-api-key
DIFY_BASE_URL=https://api.dify.ai/v1

# 支付网关
PAYMENT_GATEWAY_URL=https://payment.example.com/api
PAYMENT_GATEWAY_KEY=your-key
```

### 9.2. 依赖版本

```json
{
  "dependencies": {
    "@nestjs/common": "^10.0.0",
    "@nestjs/core": "^10.0.0",
    "@prisma/client": "^5.0.0",
    "jsonwebtoken": "^9.0.0",
    "bcrypt": "^5.1.0",
    "socket.io": "^4.5.0"
  }
}
```

### 9.3. 参考文档

- [Nest.js官方文档](https://docs.nestjs.com/)
- [Prisma文档](https://www.prisma.io/docs)
- [Dify API文档](https://docs.dify.ai/)
- [PostgreSQL文档](https://www.postgresql.org/docs/)

