# 游戏 AI 客服系统 - 生产环境部署指南

## 📋 目录

- [系统架构](#系统架构)
- [服务器要求](#服务器要求)
- [部署前准备](#部署前准备)
- [配置修改清单](#配置修改清单)
- [部署方式](#部署方式)
- [Nginx 配置](#nginx-配置)
- [SSL 证书配置](#ssl-证书配置)
- [数据库初始化](#数据库初始化)
- [启动服务](#启动服务)
- [验证部署](#验证部署)
- [监控和维护](#监控和维护)
- [常见问题](#常见问题)

---

## 系统架构

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   管理后台       │     │   玩家端页面     │     │   游戏服务器     │
│  (Admin Portal) │     │ (WebView Player)│     │  (Game Server)  │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │
         │ HTTPS                 │ HTTPS                 │ HTTPS
         │                       │                       │
         └───────────────────────┴───────────────────────┘
                                 │
                          ┌──────▼──────┐
                          │    Nginx    │
                          │ (反向代理)   │
                          └──────┬──────┘
                                 │
                    ┌────────────┴────────────┐
                    │                         │
             ┌──────▼──────┐          ┌──────▼──────┐
             │   后端 API   │          │  WebSocket  │
             │  (NestJS)   │          │  (Socket.IO)│
             └──────┬──────┘          └──────┬──────┘
                    │                         │
         ┌──────────┴──────────┬──────────────┘
         │                     │
    ┌────▼────┐          ┌────▼────┐
    │PostgreSQL│          │  Redis  │
    └─────────┘          └─────────┘
```

---

## 服务器要求

### 最低配置
- **CPU**: 2 核
- **内存**: 4GB
- **硬盘**: 50GB SSD
- **操作系统**: Ubuntu 20.04+ / CentOS 7+ / Windows Server 2019+

### 推荐配置
- **CPU**: 4 核
- **内存**: 8GB
- **硬盘**: 100GB SSD
- **操作系统**: Ubuntu 22.04 LTS

### 软件依赖
- **Node.js**: 20.x（项目要求 20.19.5+）
- **PostgreSQL**: 14.x 或更高（项目使用 postgres:14-alpine）
- **Redis**: 7.x（项目使用 redis:7-alpine）
- **Nginx**: 1.18 或更高
- **PM2**: 5.x（如果使用 PM2 部署）
- **Docker**: 20.x+（如果使用 Docker 部署，推荐）

---

## 部署前准备

### 1. 域名准备

准备以下域名（示例）：
- **管理后台**: `https://cs-admin.yourdomain.com`
- **后端 API**: `https://cs-api.yourdomain.com`
- **玩家端页面**: `https://cs-player.yourdomain.com`

### 2. SSL 证书

获取 SSL 证书（推荐方式）：

**方式 A: Let's Encrypt（免费）**
```bash
# 安装 certbot
sudo apt install certbot python3-certbot-nginx

# 为域名申请证书
sudo certbot --nginx -d cs-admin.yourdomain.com
sudo certbot --nginx -d cs-api.yourdomain.com
sudo certbot --nginx -d cs-player.yourdomain.com
```

**方式 B: 云服务商证书**
- 阿里云、腾讯云等提供免费 SSL 证书
- 下载证书文件（.crt 和 .key）

### 3. 生成安全密钥

在服务器上执行以下命令生成密钥：

```bash
# JWT 密钥
openssl rand -base64 32

# 加密密钥
openssl rand -hex 32

# 其他密钥（重复执行多次）
openssl rand -base64 32
```

记录生成的密钥，后续配置时使用。

### 4. 数据库准备

**创建生产数据库：**
```sql
-- 连接到 PostgreSQL
psql -U postgres

-- 创建数据库用户
CREATE USER cs_app WITH PASSWORD 'your-strong-password';

-- 创建数据库
CREATE DATABASE cs_prod_db OWNER cs_app;

-- 授权
GRANT ALL PRIVILEGES ON DATABASE cs_prod_db TO cs_app;
```

### 5. Redis 准备

**安装 Redis：**
```bash
# Ubuntu
sudo apt install redis-server

# 启动 Redis
sudo systemctl start redis
sudo systemctl enable redis

# 验证
redis-cli ping
# 应该返回 PONG
```

---

## 配置修改清单

### 1. 后端配置（backend/.env）

复制示例文件并修改：
```bash
cd backend
cp .env.example .env
nano .env
```

**必须修改的配置：**

```bash
# ==================== 数据库配置 ====================
DATABASE_URL="postgresql://cs_app:your-strong-password@localhost:5432/cs_prod_db?schema=public"

# ==================== JWT 配置 ====================
# 使用 openssl rand -base64 32 生成
JWT_SECRET="生成的密钥1"
JWT_EXPIRES_IN="8h"

# ==================== Redis 配置 ====================
REDIS_URL="redis://localhost:6379"
METRICS_KEY="生成的密钥2"

# ==================== 服务器配置 ====================
PORT=21101
NODE_ENV="production"

# ==================== 日志配置 ====================
LOG_LEVEL="INFO"
LOG_SAMPLING_RATE="0.5"

# ==================== 前端 URL ====================
FRONTEND_URL="https://cs-admin.yourdomain.com"

# ==================== Dify API 配置 ====================
DIFY_API_KEY="your-production-dify-key"
DIFY_BASE_URL="https://your-dify-domain.com/v1"

# ==================== WebSocket 配置 ====================
WS_URL="wss://cs-api.yourdomain.com"

# ==================== 安全配置 ====================
# 使用 openssl rand -hex 32 生成
ENCRYPTION_SECRET_KEY="生成的密钥3"
ENCRYPTION_SALT="生成的密钥4"

# 使用 openssl rand -base64 32 生成
WS_TOKEN_SECRET="生成的密钥5"
UPLOAD_TOKEN_SECRET="生成的密钥6"
SESSION_TOKEN_SECRET="生成的密钥7"

# ==================== Token 有效期 ====================
PLAYER_API_WS_TOKEN_TTL=7200
PLAYER_API_UPLOAD_TOKEN_TTL=600
```

### 2. 管理后台前端配置（frontend/admin-portal/.env）

```bash
cd frontend/admin-portal
cp .env.example .env
nano .env
```

```bash
# API 配置
VITE_API_BASE_URL=https://cs-api.yourdomain.com/api/v1

# WebSocket 配置
VITE_WS_URL=wss://cs-api.yourdomain.com
```

### 3. 玩家端前端配置（webview-player/.env）

```bash
cd webview-player
nano .env
```

```bash
# API 配置（可选，推荐通过 URL 参数传递）
VITE_API_URL=https://cs-api.yourdomain.com
```

---

## 部署方式

### 方式 A: Docker 部署（推荐）

#### 1. 安装 Docker

```bash
# Ubuntu
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 安装 Docker Compose
sudo apt install docker-compose

# 启动 Docker
sudo systemctl start docker
sudo systemctl enable docker
```

#### 2. 设置必要环境变量

Docker Compose 需要以下必要环境变量（可创建 `.env` 文件或 export）：

```bash
# 创建 .env 文件（项目根目录）
cat > .env << 'EOF'
# 数据库配置（必须）
POSTGRES_PASSWORD=你的数据库强密码

# JWT 配置（必须）
JWT_SECRET=使用 openssl rand -base64 32 生成

# 加密配置（必须）
ENCRYPTION_SECRET_KEY=使用 openssl rand -hex 32 生成（至少32字符）
ENCRYPTION_SALT=使用 openssl rand -base64 32 生成

# WebSocket URL（必须，生产域名）
WS_URL=wss://cs-api.yourdomain.com

# Dify AI 配置（必须）
DIFY_API_KEY=你的 Dify API Key
DIFY_BASE_URL=https://your-dify-domain.com/v1

# 可选配置
FRONTEND_URL=https://cs-admin.yourdomain.com
LOG_LEVEL=INFO
EOF
```

#### 3. 端口映射说明

docker-compose.yml 中的默认端口映射：
- **PostgreSQL**: `22101:5432` (外部 22101 映射到容器 5432)
- **Redis**: `22102:6379` (外部 22102 映射到容器 6379)
- **Backend**: `21101:21101` (后端 API)
- **Admin Portal**: `20101:20101` (管理后台)

#### 4. 构建和启动

```bash
# 构建镜像
docker-compose build

# 启动服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f backend
```

---

### 方式 B: PM2 部署

#### 1. 安装依赖

```bash
# 安装 Node.js 20
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# 安装 PM2
sudo npm install -g pm2

# 安装 pnpm
sudo npm install -g pnpm
```

#### 2. 构建项目

```bash
# 后端
cd backend
pnpm install
pnpm build

# 管理后台
cd ../frontend/admin-portal
pnpm install
pnpm build

# 玩家端
cd ../webview-player
pnpm install
pnpm build
```

#### 3. 创建 PM2 配置文件

```bash
cd backend

# 创建 ecosystem.config.js
cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'game-ai-cs-backend',
    script: 'dist/main.js',
    instances: 1,
    exec_mode: 'fork',
    env_production: {
      NODE_ENV: 'production',
      PORT: 21101
    }
  }]
};
EOF
```

#### 4. 启动后端

```bash
# 使用 PM2 启动
pm2 start ecosystem.config.js --env production

# 保存 PM2 配置
pm2 save

# 设置开机自启
pm2 startup
```

#### 5. 部署前端

前端构建产物需要通过 Nginx 提供服务（见下一节）。

---

## Nginx 配置

### 1. 安装 Nginx

```bash
sudo apt install nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 2. 配置后端 API + WebSocket

创建配置文件：
```bash
sudo nano /etc/nginx/sites-available/cs-api
```

```nginx
# 后端 API + WebSocket
upstream backend_api {
    server 127.0.0.1:21101;
    keepalive 64;
}

server {
    listen 80;
    server_name cs-api.yourdomain.com;
    
    # 重定向到 HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name cs-api.yourdomain.com;
    
    # SSL 证书配置
    ssl_certificate /etc/letsencrypt/live/cs-api.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/cs-api.yourdomain.com/privkey.pem;
    
    # SSL 优化配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # 日志
    access_log /var/log/nginx/cs-api-access.log;
    error_log /var/log/nginx/cs-api-error.log;
    
    # 客户端上传大小限制
    client_max_body_size 10M;
    
    # API 请求
    location /api/ {
        proxy_pass http://backend_api;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # WebSocket 连接
    location /socket.io/ {
        proxy_pass http://backend_api;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 超时配置（保持长连接）
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }
    
    # 健康检查
    location /health {
        proxy_pass http://backend_api;
        access_log off;
    }
}
```

### 3. 配置管理后台

```bash
sudo nano /etc/nginx/sites-available/cs-admin
```

```nginx
server {
    listen 80;
    server_name cs-admin.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name cs-admin.yourdomain.com;
    
    # SSL 证书
    ssl_certificate /etc/letsencrypt/live/cs-admin.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/cs-admin.yourdomain.com/privkey.pem;
    
    # SSL 优化
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # 网站根目录
    root /var/www/admin-portal/dist;
    index index.html;
    
    # 日志
    access_log /var/log/nginx/cs-admin-access.log;
    error_log /var/log/nginx/cs-admin-error.log;
    
    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;
    
    # SPA 路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

### 4. 配置玩家端

```bash
sudo nano /etc/nginx/sites-available/cs-player
```

```nginx
server {
    listen 80;
    server_name cs-player.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name cs-player.yourdomain.com;
    
    # SSL 证书
    ssl_certificate /etc/letsencrypt/live/cs-player.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/cs-player.yourdomain.com/privkey.pem;
    
    # SSL 优化
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # 网站根目录
    root /var/www/webview-player/dist;
    index index.html;
    
    # 日志
    access_log /var/log/nginx/cs-player-access.log;
    error_log /var/log/nginx/cs-player-error.log;
    
    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;
    
    # SPA 路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

### 5. 启用配置

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/cs-api /etc/nginx/sites-enabled/
sudo ln -s /etc/nginx/sites-available/cs-admin /etc/nginx/sites-enabled/
sudo ln -s /etc/nginx/sites-available/cs-player /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

### 6. 部署前端文件

```bash
# 创建目录
sudo mkdir -p /var/www/admin-portal
sudo mkdir -p /var/www/webview-player

# 复制构建产物
sudo cp -r frontend/admin-portal/dist/* /var/www/admin-portal/
sudo cp -r webview-player/dist/* /var/www/webview-player/

# 设置权限
sudo chown -R www-data:www-data /var/www/admin-portal
sudo chown -R www-data:www-data /var/www/webview-player
```

---

## SSL 证书配置

### 自动续期（Let's Encrypt）

```bash
# 测试自动续期
sudo certbot renew --dry-run

# 设置定时任务
sudo crontab -e

# 添加以下行（每天凌晨 2 点检查续期）
0 2 * * * certbot renew --quiet --post-hook "systemctl reload nginx"
```

---

## 数据库初始化

### 1. 执行数据库迁移

```bash
cd backend

# 生产环境迁移（不会删除数据）
npx prisma migrate deploy

# 查看迁移状态
npx prisma migrate status
```

### 2. 创建初始管理员账号

```bash
# 执行 seed 脚本
npm run seed

# 或手动执行
node prisma/seed.js
```

默认账号：
- **管理员**: `admin` / `admin123`, `admin2` / `admin123`
- **客服**: `agent1` / `agent123`, `agent2` / `agent123`, `agent3` / `agent123`

**⚠️ 重要：首次登录后立即修改所有账户密码！**

---

## 启动服务

### Docker 方式

```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f backend
```

### PM2 方式

```bash
# 启动后端
cd backend
pm2 start ecosystem.config.js --env production

# 查看状态
pm2 status

# 查看日志
pm2 logs backend

# 重启服务
pm2 restart backend
```

---

## 验证部署

### 1. 检查服务状态

```bash
# 检查后端
curl https://cs-api.yourdomain.com/api/v1/health

# 检查 PostgreSQL
psql -U cs_app -d cs_prod_db -c "SELECT version();"

# 检查 Redis
redis-cli ping

# 检查 Nginx
sudo nginx -t
sudo systemctl status nginx
```

### 2. 测试管理后台

1. 访问：`https://cs-admin.yourdomain.com`
2. 使用默认账号登录
3. 修改管理员密码
4. 添加测试游戏

### 3. 测试玩家端

1. 访问：`https://cs-player.yourdomain.com?apiUrl=https://cs-api.yourdomain.com`
2. 检查是否能正常加载
3. 测试创建工单
4. 测试发送消息

### 4. 测试 WebSocket

```bash
# 使用 wscat 测试
npm install -g wscat

wscat -c "wss://cs-api.yourdomain.com/socket.io/?EIO=4&transport=websocket"
```

---

## 监控和维护

### 1. 日志管理

**查看日志：**
```bash
# PM2 日志
pm2 logs backend

# Nginx 日志
sudo tail -f /var/log/nginx/cs-api-access.log
sudo tail -f /var/log/nginx/cs-api-error.log

# 系统日志
journalctl -u nginx -f
```

**日志轮转：**
```bash
# 配置日志轮转
sudo nano /etc/logrotate.d/cs-system

# 添加以下内容
/var/log/nginx/cs-*.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 www-data adm
    sharedscripts
    postrotate
        [ -f /var/run/nginx.pid ] && kill -USR1 `cat /var/run/nginx.pid`
    endscript
}
```

### 2. 数据库备份

```bash
# 创建备份脚本
sudo nano /usr/local/bin/backup-cs-db.sh
```

```bash
#!/bin/bash
BACKUP_DIR="/var/backups/cs-database"
DATE=$(date +%Y%m%d_%H%M%S)
FILENAME="cs_prod_db_${DATE}.sql.gz"

mkdir -p $BACKUP_DIR

# 备份数据库
pg_dump -U cs_app cs_prod_db | gzip > $BACKUP_DIR/$FILENAME

# 保留最近 30 天的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete

echo "Backup completed: $FILENAME"
```

```bash
# 设置权限
sudo chmod +x /usr/local/bin/backup-cs-db.sh

# 设置定时任务（每天凌晨 3 点备份）
sudo crontab -e
0 3 * * * /usr/local/bin/backup-cs-db.sh
```

### 3. 性能监控

```bash
# 安装监控工具
sudo apt install htop iotop nethogs

# 监控 CPU 和内存
htop

# 监控磁盘 IO
sudo iotop

# 监控网络
sudo nethogs

# PM2 监控
pm2 monit
```

### 4. 定期维护任务

**每周：**
- 检查磁盘空间
- 检查日志文件大小
- 检查数据库备份

**每月：**
- 更新系统安全补丁
- 检查 SSL 证书有效期
- 审查错误日志

**每季度：**
- 数据库性能优化
- 清理过期数据
- 更新依赖包

---

## 常见问题

### 1. WebSocket 连接失败

**问题：** 玩家端无法连接 WebSocket

**解决方案：**
- 检查 Nginx WebSocket 配置
- 确认使用 `wss://` 而不是 `ws://`
- 检查防火墙规则
- 查看后端日志

### 2. CORS 错误

**问题：** 前端请求被 CORS 阻止

**解决方案：**
- 检查 `backend/.env` 中的 `FRONTEND_URL` 配置
- 确保包含所有前端域名
- 重启后端服务

### 3. 数据库连接失败

**问题：** 后端无法连接数据库

**解决方案：**
```bash
# 检查 PostgreSQL 状态
sudo systemctl status postgresql

# 检查连接
psql -U cs_app -d cs_prod_db

# 检查 DATABASE_URL 配置
cat backend/.env | grep DATABASE_URL
```

### 4. Redis 连接失败

**问题：** 后端无法连接 Redis

**解决方案：**
```bash
# 检查 Redis 状态
sudo systemctl status redis

# 测试连接
redis-cli ping

# 检查配置
cat backend/.env | grep REDIS_URL
```

### 5. 前端页面 404

**问题：** 刷新页面后出现 404

**解决方案：**
- 检查 Nginx 配置中的 `try_files` 指令
- 确保配置了 SPA 路由支持
- 重启 Nginx

### 6. SSL 证书错误

**问题：** 浏览器提示证书无效

**解决方案：**
```bash
# 检查证书有效期
sudo certbot certificates

# 手动续期
sudo certbot renew

# 重启 Nginx
sudo systemctl restart nginx
```

### 7. 性能问题

**问题：** 系统响应缓慢

**解决方案：**
- 检查数据库连接池配置
- 优化数据库查询
- 增加 Redis 缓存
- 检查服务器资源使用情况
- 考虑扩容

---

## 安全检查清单

部署完成后，请确认以下安全措施：

- [ ] 所有密钥已重新生成（不使用示例密钥）
- [ ] 数据库密码足够强（至少 16 位，包含大小写字母、数字、特殊字符）
- [ ] 已启用 HTTPS/WSS（所有连接加密）
- [ ] 防火墙已配置（只开放必要端口）
- [ ] SSH 已禁用密码登录（使用密钥登录）
- [ ] 已修改默认管理员密码
- [ ] CORS 配置正确（只允许自己的域名）
- [ ] 文件上传大小限制合理
- [ ] 日志不输出敏感信息
- [ ] 数据库备份已配置
- [ ] SSL 证书自动续期已配置
- [ ] 系统自动更新已启用

---

## 技术支持

如遇到问题，请：
1. 查看本文档的"常见问题"部分
2. 检查系统日志和错误信息
3. 查看项目 README.md
4. 联系技术支持团队

---

**文档版本**: v1.1
**最后更新**: 2026-01-22
**维护者**: 开发团队

### 更新记录
- v1.1 (2026-01-22): 修正默认密码、Node.js/Redis 版本、PM2 配置示例、Docker 环境变量说明
- v1.0 (2026-01-21): 初始版本
