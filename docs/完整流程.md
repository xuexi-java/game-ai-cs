# 游戏客服系统 - 玩家端接入完整流程

> 更新日期: 2026-01-07

---

## 一、名词解释

### 什么是 Bootstrap 接口？

**Bootstrap** (引导/启动) 接口是玩家端的**唯一HTTP入口**，一次调用返回所有初始化数据：

```
┌─────────────────────────────────────────────────────────────────┐
│                    Bootstrap 接口的作用                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   传统设计 (多个接口):                                           │
│   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│   │ 获取状态  │  │ 获取分类  │  │ 获取历史  │  │ 获取Token │       │
│   └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘       │
│        │             │             │             │              │
│        └─────────────┴─────────────┴─────────────┘              │
│                          4次请求                                 │
│                                                                 │
│   Bootstrap 设计 (单一接口):                                     │
│   ┌─────────────────────────────────────────────────────┐       │
│   │              POST /api/player/connect               │       │
│   │  返回: wsToken + 问题分类 + 活跃工单 + 历史消息 + ...  │       │
│   └─────────────────────────────────────────────────────┘       │
│                          1次请求                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**优势**：减少网络请求、降低延迟、简化前端逻辑

---

## 二、系统参与方

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           系统参与方                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌───────────────┐    ┌───────────────┐    ┌───────────────┐          │
│   │  游戏客户端    │    │   游戏服务器   │    │   客服服务器   │          │
│   │  (Unity)      │    │               │    │   (Backend)   │          │
│   └───────┬───────┘    └───────┬───────┘    └───────┬───────┘          │
│           │                    │                    │                   │
│   职责:                  职责:                 职责:                     │
│   • 打开WebView          • 计算签名             • 验证签名               │
│   • 提供Bridge接口       • 保护secret           • 管理工单               │
│   • 获取玩家信息                                • WebSocket通信          │
│                                                 • AI对话                │
│   ┌───────────────┐                             • 人工客服分配           │
│   │   WebView     │                                                     │
│   │  (Vue前端)    │                                                     │
│   └───────────────┘                                                     │
│   职责:                                                                 │
│   • 调用Bridge获取信息                                                   │
│   • 调用Bootstrap接口                                                    │
│   • 建立WebSocket连接                                                    │
│   • 聊天UI交互                                                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 三、完整流程图

### 3.1 玩家点击"客服中心"完整流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        玩家点击"客服中心" 完整流程                               │
└─────────────────────────────────────────────────────────────────────────────────┘

  玩家         游戏客户端(Unity)        WebView(Vue)         游戏服务器        客服服务器
   │                 │                     │                    │                │
   │  ① 点击客服按钮  │                     │                    │                │
   │────────────────>│                     │                    │                │
   │                 │                     │                    │                │
   │                 │  ② 打开WebView      │                    │                │
   │                 │  (加载H5页面)        │                    │                │
   │                 │────────────────────>│                    │                │
   │                 │                     │                    │                │
   │                 │                     │  ③ 调用Bridge       │                │
   │                 │                     │  getPlayerInfo()   │                │
   │                 │<────────────────────│                    │                │
   │                 │                     │                    │                │
   │                 │  ④ 返回玩家信息      │                    │                │
   │                 │  {gameid,uid,areaid}│                    │                │
   │                 │────────────────────>│                    │                │
   │                 │                     │                    │                │
   │                 │                     │  ⑤ 调用Bridge       │                │
   │                 │                     │  getSignedParams() │                │
   │                 │<────────────────────│                    │                │
   │                 │                     │                    │                │
   │                 │  ⑥ 请求签名          │                    │                │
   │                 │─────────────────────────────────────────>│                │
   │                 │                     │                    │                │
   │                 │  ⑦ 返回签名 (用固定nonce+secret计算)       │                │
   │                 │  {nonce, sign}      │                    │                │
   │                 │<─────────────────────────────────────────│                │
   │                 │                     │                    │                │
   │                 │  ⑧ 返回签名参数      │                    │                │
   │                 │────────────────────>│                    │                │
   │                 │                     │                    │                │
   │                 │                     │  ⑨ POST /api/player/connect        │
   │                 │                     │  {gameid,uid,areaid,nonce,sign}    │
   │                 │                     │───────────────────────────────────>│
   │                 │                     │                    │                │
   │                 │                     │                    │  ⑩ 验证签名    │
   │                 │                     │                    │  查询工单状态  │
   │                 │                     │                    │                │
   │                 │                     │  ⑪ 返回初始化数据                   │
   │                 │                     │  {wsUrl,wsToken,questList,         │
   │                 │                     │   activeTicket,history,...}        │
   │                 │                     │<───────────────────────────────────│
   │                 │                     │                    │                │
   │                 │                     │  ⑫ 建立WebSocket连接               │
   │                 │                     │  io(wsUrl, {auth:{token:wsToken}}) │
   │                 │                     │═══════════════════════════════════>│
   │                 │                     │                    │                │
   │                 │                     │  ⑬ 连接成功                         │
   │                 │                     │  emit: 'connected'                 │
   │                 │                     │<═══════════════════════════════════│
   │                 │                     │                    │                │
   │  ⑭ 显示客服界面  │                     │                    │                │
   │<─────────────────────────────────────│                    │                │
   │                 │                     │                    │                │

┌─────────────────────────────────────────────────────────────────────────────────┐
│  关键说明:                                                                      │
│  • 步骤②-⑧: WebView与游戏客户端的Bridge通信 (获取玩家信息和签名)                  │
│  • 步骤⑥-⑦: 游戏客户端调用游戏服务器计算签名 (secret不暴露给前端)                 │
│  • 步骤⑨-⑪: WebView调用客服服务器的Bootstrap接口                                │
│  • 步骤⑫-⑬: WebView与客服服务器建立WebSocket长连接                              │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

### 3.2 创建新工单流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           创建新工单流程                                         │
│                     (Bootstrap返回 activeTicket = null)                         │
└─────────────────────────────────────────────────────────────────────────────────┘

  玩家              WebView(Vue)                              客服服务器
   │                    │                                        │
   │                    │  ① Bootstrap返回无活跃工单              │
   │                    │  activeTicket = null                   │
   │                    │  questList = [账号问题, 充值问题, ...]   │
   │                    │                                        │
   │  ② 显示问题分类菜单 │                                        │
   │<───────────────────│                                        │
   │                    │                                        │
   │  ③ 选择"账号问题"   │                                        │
   │───────────────────>│                                        │
   │                    │                                        │
   │                    │  ④ emit('ticket:create')               │
   │                    │  {issueType: 'account-issue'}          │
   │                    │═══════════════════════════════════════>│
   │                    │                                        │
   │                    │                                        │  ⑤ 创建工单
   │                    │                                        │  创建会话
   │                    │                                        │  绑定Socket
   │                    │                                        │
   │                    │  ⑥ emit('ticket:created')              │
   │                    │  {tid: 'T-20260107-xxx', status: 'IN_PROGRESS'}
   │                    │<═══════════════════════════════════════│
   │                    │                                        │
   │  ⑦ 显示聊天界面    │                                        │
   │  解锁输入框        │                                        │
   │<───────────────────│                                        │
   │                    │                                        │
```

---

### 3.3 恢复旧工单流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           恢复旧工单流程                                         │
│                   (Bootstrap返回 activeTicket ≠ null)                           │
└─────────────────────────────────────────────────────────────────────────────────┘

  玩家              WebView(Vue)                              客服服务器
   │                    │                                        │
   │                    │  ① Bootstrap返回有活跃工单              │
   │                    │  activeTicket = {                      │
   │                    │    tid: 'T-xxx',                       │
   │                    │    status: 'IN_PROGRESS',              │
   │                    │    description: '账号被盗'              │
   │                    │  }                                     │
   │                    │  history = [消息1, 消息2, ...]          │
   │                    │                                        │
   │  ② 显示弹窗        │                                        │
   │  "您有未完成工单"   │                                        │
   │<───────────────────│                                        │
   │                    │                                        │
   │  ③ 点击[继续咨询]  │                                        │
   │───────────────────>│                                        │
   │                    │                                        │
   │                    │  ④ emit('ticket:resume')               │
   │                    │  {tid: 'T-xxx'}                        │
   │                    │═══════════════════════════════════════>│
   │                    │                                        │
   │                    │                                        │  ⑤ 绑定Socket
   │                    │                                        │  加载完整历史
   │                    │                                        │
   │                    │  ⑥ emit('ticket:resumed')              │
   │                    │  {tid, status, history: [...]}         │
   │                    │<═══════════════════════════════════════│
   │                    │                                        │
   │  ⑦ 显示历史消息    │                                        │
   │  继续聊天          │                                        │
   │<───────────────────│                                        │
   │                    │                                        │

┌─────────────────────────────────────────────────────────────────────────────────┐
│  如果玩家选择[新建工单]:                                                         │
│  • emit('ticket:create', {issueType: 'xxx', confirmClose: true})               │
│  • 服务端自动关闭旧工单，创建新工单                                               │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

### 3.4 发送消息流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            发送消息流程                                          │
└─────────────────────────────────────────────────────────────────────────────────┘

  玩家              WebView(Vue)                              客服服务器
   │                    │                                        │
   │  ① 输入消息        │                                        │
   │  "我的账号被盗了"   │                                        │
   │───────────────────>│                                        │
   │                    │                                        │
   │                    │  ② 生成 clientMsgId (UUID)             │
   │                    │  显示消息(状态:发送中)                   │
   │                    │                                        │
   │                    │  ③ emit('message:send')                │
   │                    │  {content, type:'TEXT', clientMsgId}   │
   │                    │═══════════════════════════════════════>│
   │                    │                                        │
   │                    │                                        │  ④ 保存消息
   │                    │                                        │  更新工单描述
   │                    │                                        │  调用AI/通知客服
   │                    │                                        │
   │                    │  ⑤ emit('message:ack')                 │
   │                    │  {clientMsgId, id:'msg-xxx', timestamp} │
   │                    │<═══════════════════════════════════════│
   │                    │                                        │
   │  ⑥ 消息状态更新    │                                        │
   │  发送中 → 已发送    │                                        │
   │<───────────────────│                                        │
   │                    │                                        │
   │                    │  ⑦ emit('message:receive')             │
   │                    │  {senderType:'AI', content:'您好...'}   │
   │                    │<═══════════════════════════════════════│
   │                    │                                        │
   │  ⑧ 显示AI回复      │                                        │
   │<───────────────────│                                        │
   │                    │                                        │

┌─────────────────────────────────────────────────────────────────────────────────┐
│  消息幂等性:                                                                    │
│  • 如果网络中断，客户端用相同的 clientMsgId 重发                                  │
│  • 服务端检测到重复的 clientMsgId，返回相同的 ack (不重复创建消息)                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

### 3.5 转人工流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            转人工完整流程                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

  玩家              WebView(Vue)                              客服服务器
   │                    │                                        │
   │  ① 点击[转人工]    │                                        │
   │───────────────────>│                                        │
   │                    │                                        │
   │                    │  ② emit('transfer:request')            │
   │                    │  {reason: '问题复杂'}                   │
   │                    │═══════════════════════════════════════>│
   │                    │                                        │
   │                    │                                        │  ③ 检查条件:
   │                    │                                        │  • 是否工作时间?
   │                    │                                        │  • 有客服在线?
   │                    │                                        │
   │                    │                                        │
   │           ┌────────┴────────────────────────────────────────┴────────┐
   │           │                      条件检查结果                          │
   │           ├───────────────────────────────────────────────────────────┤
   │           │                                                           │
   │           │  情况A: 非工作时间                                         │
   │           │  emit('transfer:result')                                  │
   │           │  {success:false, reason:'当前为非工作时间，请在...'}        │
   │           │                                                           │
   │           │  情况B: 无客服在线                                         │
   │           │  emit('transfer:result')                                  │
   │           │  {success:false, reason:'暂无客服在线'}                    │
   │           │                                                           │
   │           │  情况C: 成功入队                                           │
   │           │  emit('transfer:result')                                  │
   │           │  {success:true, queuePosition:3, waitTime:'约10分钟'}      │
   │           │                                                           │
   │           └───────────────────────────────────────────────────────────┘
   │                    │                                        │
   │                    │  ④ (成功入队后) 排队状态更新             │
   │                    │  emit('queue:update')                  │
   │                    │  {position:2, estimatedWaitTime:'5分钟'} │
   │                    │<═══════════════════════════════════════│
   │                    │                                        │
   │  ⑤ 显示排队进度    │                                        │
   │  "前面还有2人"      │                                        │
   │<───────────────────│                                        │
   │                    │                                        │
   │                    │  ⑥ emit('queue:update')                │
   │                    │  {position:1, estimatedWaitTime:'2分钟'} │
   │                    │<═══════════════════════════════════════│
   │                    │                                        │
   │                    │  ⑦ emit('agent:assigned')              │
   │                    │  {agentId:'xxx', agentName:'客服小王'}   │
   │                    │<═══════════════════════════════════════│
   │                    │                                        │
   │  ⑧ 显示"客服已接入" │                                        │
   │<───────────────────│                                        │
   │                    │                                        │
```

---

### 3.6 图片上传流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            图片上传流程                                          │
│                    (唯一需要额外HTTP请求的功能)                                   │
└─────────────────────────────────────────────────────────────────────────────────┘

  玩家         游戏客户端(Unity)        WebView(Vue)                  客服服务器
   │                 │                     │                              │
   │  ① 点击上传图片  │                     │                              │
   │─────────────────────────────────────>│                              │
   │                 │                     │                              │
   │                 │                     │  ② 调用Bridge                │
   │                 │                     │  selectImage()               │
   │                 │<────────────────────│                              │
   │                 │                     │                              │
   │                 │  ③ 打开系统相册      │                              │
   │                 │  或调用相机          │                              │
   │                 │                     │                              │
   │  ④ 选择图片      │                     │                              │
   │────────────────>│                     │                              │
   │                 │                     │                              │
   │                 │  ⑤ 返回图片数据      │                              │
   │                 │  (Base64/文件路径)   │                              │
   │                 │────────────────────>│                              │
   │                 │                     │                              │
   │                 │                     │  ⑥ 前端压缩图片               │
   │                 │                     │  • HEIC → JPEG              │
   │                 │                     │  • 压缩至1920px              │
   │                 │                     │  • quality=0.8              │
   │                 │                     │                              │
   │                 │                     │  ⑦ POST /api/player/upload   │
   │                 │                     │  Header: X-Upload-Token      │
   │                 │                     │  Body: FormData(file)        │
   │                 │                     │────────────────────────────>│
   │                 │                     │                              │
   │                 │                     │                              │  ⑧ 验证Token
   │                 │                     │                              │  保存文件
   │                 │                     │                              │  生成URL
   │                 │                     │                              │
   │                 │                     │  ⑨ 返回图片URL               │
   │                 │                     │  {url:'https://...jpg'}      │
   │                 │                     │<────────────────────────────│
   │                 │                     │                              │
   │                 │                     │  ⑩ emit('message:send')      │
   │                 │                     │  {content:url, type:'IMAGE'} │
   │                 │                     │══════════════════════════════>
   │                 │                     │                              │
   │  ⑪ 显示图片消息  │                     │                              │
   │<─────────────────────────────────────│                              │
   │                 │                     │                              │

┌─────────────────────────────────────────────────────────────────────────────────┐
│  Unity端需要的配置:                                                             │
│  • Android: AndroidManifest.xml 添加 READ_EXTERNAL_STORAGE 权限                │
│  • iOS: Info.plist 添加 NSPhotoLibraryUsageDescription                         │
│  • WebView: SetAllowFileAccessFromFileURLs(true)                               │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

### 3.7 关闭工单流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            关闭工单流程                                          │
└─────────────────────────────────────────────────────────────────────────────────┘

  玩家              WebView(Vue)                              客服服务器
   │                    │                                        │
   │  ① 点击[关闭工单]  │                                        │
   │───────────────────>│                                        │
   │                    │                                        │
   │  ② 显示确认弹窗    │                                        │
   │  "确定关闭工单?"   │                                        │
   │<───────────────────│                                        │
   │                    │                                        │
   │  ③ 点击[确定]      │                                        │
   │───────────────────>│                                        │
   │                    │                                        │
   │                    │  ④ emit('ticket:close')                │
   │                    │  {reason: 'RESOLVED'}                  │
   │                    │═══════════════════════════════════════>│
   │                    │                                        │
   │                    │                                        │  ⑤ 关闭工单
   │                    │                                        │  关闭会话
   │                    │                                        │  记录关闭原因
   │                    │                                        │
   │                    │  ⑥ emit('ticket:update')               │
   │                    │  {status:'RESOLVED', closeReason:...}  │
   │                    │<═══════════════════════════════════════│
   │                    │                                        │
   │  ⑦ 显示"工单已关闭" │                                        │
   │  输入框变为只读     │                                        │
   │<───────────────────│                                        │
   │                    │                                        │

┌─────────────────────────────────────────────────────────────────────────────────┐
│  关闭原因 (closeReason):                                                        │
│  • RESOLVED - 问题已解决                                                        │
│  • MANUAL_PLAYER - 玩家手动关闭                                                 │
│  • MANUAL_AGENT - 客服手动关闭                                                  │
│  • AUTO_TIMEOUT - 超时自动关闭                                                  │
│  • AUTO_CLOSED_BY_NEW_TICKET - 创建新工单时自动关闭旧工单                         │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、交互列表汇总

### 4.1 游戏客户端(Unity) ↔ 游戏服务器

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│  序号    时机              交互内容                      说明                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│   1     打开客服时        获取签名参数                  获取 {nonce, sign}       │
│                                                        (nonce为固定配置值)      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                         ⚠️ 只有这一次！后续通信不需要游戏服务器                    │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 游戏客户端(WebView) → 客服服务器

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              HTTP 接口                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│  序号    接口                          方向    说明                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│   1     POST /api/player/connect       →      Bootstrap: 获取初始化数据          │
│   2     POST /api/player/upload        →      上传图片 (可选)                    │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                           WebSocket 事件 (上行)                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│  序号    事件名              方向    说明                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│   3     ticket:create        →      创建新工单                                  │
│   4     ticket:resume        →      恢复旧工单                                  │
│   5     message:send         →      发送消息                                    │
│   6     transfer:request     →      请求转人工                                  │
│   7     ticket:close         →      关闭工单                                    │
│   8     history:load         →      加载更多历史                                │
│   9     typing:update        →      输入状态                                    │
│  10     ping                 →      心跳                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                           WebSocket 事件 (下行)                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│  序号    事件名              方向    说明                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│  11     connected            ←      连接成功                                    │
│  12     ticket:created       ←      工单创建成功                                │
│  13     ticket:resumed       ←      工单恢复成功                                │
│  14     message:ack          ←      消息发送确认                                │
│  15     message:receive      ←      收到新消息                                  │
│  16     transfer:result      ←      转人工结果                                  │
│  17     queue:update         ←      排队状态更新                                │
│  18     agent:assigned       ←      客服接入                                    │
│  19     ticket:update        ←      工单状态变更                                │
│  20     typing-status        ←      对方输入状态                                │
│  21     kicked               ←      被踢下线                                    │
│  22     pong                 ←      心跳响应                                    │
│  23     error                ←      错误通知                                    │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 4.3 游戏服务器 ↔ 客服服务器

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│  序号    时机              交互内容                      说明                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│   -     -                  无直接交互                   游戏服务器只负责签名计算   │
└─────────────────────────────────────────────────────────────────────────────────┘

签名验证流程:
┌─────────────┐                              ┌─────────────┐
│  游戏服务器  │                              │  客服服务器  │
│             │                              │             │
│  用 secret  │         WebView 转发          │  用 secret  │
│  计算签名   │  ─────────────────────────>   │  验证签名   │
│             │                              │             │
└─────────────┘                              └─────────────┘
        ↑                                           ↑
        └───────────── 使用相同的 secret ───────────┘
                    (双方都存储，不在网络传输)
```

---

## 五、签名认证详解

### 5.1 签名公式

```
sign = md5(gameid|uid|areaid|nonce|secret).toLowerCase()
```

### 5.2 参数说明

| 参数 | 说明 | 示例 | 来源 |
|------|------|------|------|
| gameid | 游戏ID | `弹弹堂` | 游戏客户端 |
| uid | 玩家UID | `player_12345` | 游戏客户端 |
| areaid | 区服ID | `server_01` | 游戏客户端 |
| nonce | 固定Nonce | `a1b2c3d4e5f6g7h8` | **游戏配置** (playerApiNonce) |
| secret | 游戏密钥 | `your-secret-key` | **游戏配置** (playerApiSecret) |

### 5.3 配置说明

**nonce 和 secret 都是固定值**，需要在客服系统后台的游戏配置中设置：

```
Game 表字段:
├── playerApiSecret  - 签名密钥 (双方约定，不在网络传输)
└── playerApiNonce   - 固定Nonce (16位随机字符串，双方约定)
```

### 5.4 签名示例代码

```javascript
// Node.js (游戏服务器)
const crypto = require('crypto');

// 配置 (与客服系统后台一致)
const CONFIG = {
  nonce: 'a1b2c3d4e5f6g7h8',  // 固定值，从游戏配置获取
  secret: 'your-secret-key',  // 固定值，从游戏配置获取
};

function generateSign(gameid, uid, areaid) {
  const signStr = `${gameid}|${uid}|${areaid}|${CONFIG.nonce}|${CONFIG.secret}`;
  const sign = crypto.createHash('md5').update(signStr).digest('hex');
  return { nonce: CONFIG.nonce, sign };
}
```

---

## 六、配置参数

| 配置项 | 值 | 说明 |
|--------|-----|------|
| wsToken有效期 | 1小时 | WebSocket连接认证 |
| uploadToken有效期 | 10分钟 | 图片上传认证 |
| 玩家限流 | 200条/分钟 | 消息发送限制 |
| 心跳间隔 | 15秒 | 服务端检测周期 |
| 心跳超时 | 45秒 | 3次超时断开 |
| 图片大小限制 | 5MB | 上传限制 |

---

## 七、测试工具

### HTML 测试页面
```
test-tools/player-api-test.html
```

### Node.js 命令行
```bash
cd test-tools
npm install socket.io-client
node player-api-test.js chat
```
