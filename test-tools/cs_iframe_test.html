<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>客服中心 Iframe 测试页</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111827;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 24px;
    }
    .page {
      display: flex;
      gap: 16px;
      max-width: 1200px;
      width: 100%;
    }
    .left, .right {
      background: #020617;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #1f2933;
    }
    .left { width: 360px; }
    .right {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 600px;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 4px;
      color: #f9fafb;
    }
    h2 {
      font-size: 16px;
      margin: 12px 0 8px;
      color: #e5e7eb;
    }
    p.desc {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 12px;
    }
    label {
      display: block;
      font-size: 13px;
      margin-top: 8px;
      margin-bottom: 4px;
      color: #9ca3af;
    }
    input, select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 1px #6366f1;
    }
    button {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      margin-top: 12px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
    }
    .btn-secondary {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
      margin-left: 8px;
    }
    .btn-primary:disabled {
      opacity: .6;
      cursor: not-allowed;
    }
    .field-row {
      display: flex;
      gap: 8px;
    }
    .field-row > div {
      flex: 1;
    }
    .info-box {
      margin-top: 12px;
      padding: 8px;
      border-radius: 8px;
      background: #020617;
      border: 1px solid #1f2937;
      font-size: 12px;
      color: #9ca3af;
      max-height: 160px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .info-box strong { color: #e5e7eb; }

    .cs-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(2, 6, 23, 0.55);
      z-index: 1000;
    }
    .cs-overlay.is-open {
      display: flex;
    }
    .cs-modal {
      position: relative;
      display: flex;
      flex-direction: column;
      width: min(820px, calc(100% - 48px));
      height: min(600px, calc(100% - 48px));
      border-radius: 8px;
      overflow: hidden;
      background: #020617;
      border: 1px solid #1f2937;
      box-shadow: 0 24px 64px rgba(0, 0, 0, 0.45);
    }
    .cs-header {
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 8px;
      background: #020617;
      border-bottom: 1px solid #1f2937;
      font-size: 13px;
      color: #9ca3af;
    }
    .cs-iframe-wrapper {
      flex: 1;
      background: #030712;
    }
    .cs-iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #030712;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      font-size: 11px;
      color: #9ca3af;
      gap: 4px;
    }
    #statusTag { margin-left: auto; }
    .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }
    .tag-dot.offline { background: #6b7280; }
    .cs-close-btn {
      margin: 0;
    }
    .footer {
      font-size: 11px;
      color: #6b7280;
      margin-top: 8px;
    }
    .log-line-ok { color: #22c55e; }
    .log-line-err { color: #f97316; }
  </style>
</head>
<body>
<div class="page">
  <div class="left">
    <h1>Iframe 客服测试</h1>
    <p class="desc">
      通过 iframe 嵌入客服 H5，用于 Flash / 网页平台联调。<br />
      下方表单模拟游戏侧“获取签名 → 打开客服”流程。
    </p>

    <!-- 配置区 -->
    <h2>环境配置</h2>
    <label>游戏服务器地址（获取签名接口）</label>
    <input
      id="gameServerUrl"
      type="text"
      value="http://localhost:3001/api/get-cs-auth"
    />

    <label style="margin-top: 6px;">说明</label>
    <div class="info-box" style="max-height: 80px;">
      <strong>说明：</strong><br />
      - 默认对接仓库里的 <code>test-tools/mock-game-server.js</code><br />
      - 如在测试服，请改成实际游戏服签名接口地址，例如：<br />
      <code>https://your-game-server.com/api/get-cs-auth</code><br />
    </div>

    <!-- 玩家信息 -->
    <h2>玩家信息</h2>
    <div class="field-row">
      <div>
        <label>UID</label>
        <input id="uidInput" type="text" value="player001" />
      </div>
      <div>
        <label>区服 ID (areaid)</label>
        <input id="areaInput" type="text" value="1" />
      </div>
    </div>

    <button id="openBtn" class="btn-primary">打开客服（Iframe）</button>
    <!-- <button id="closeBtn" class="btn-secondary">关闭客服</button> -->

    <div class="info-box" id="logBox"></div>

    <div class="footer">
      - H5 通过 <code>postMessage({ type: 'cs-close' })</code> 可主动关闭弹窗<br />
      - URL 参数会自动携带 <code>platform=iframe</code> 用于区分来源
    </div>
  </div>

  <div class="cs-overlay" id="csOverlay" aria-hidden="true">
    <div class="cs-modal" id="csModal">
      <div class="cs-header">
        <span>客服 Iframe 容器</span>
        <span class="tag" id="statusTag">
          <span class="tag-dot offline" id="statusDot"></span>
          <span id="statusText">未加载</span>
        </span>
      </div>
      <div class="cs-iframe-wrapper">
        <iframe id="csFrame" class="cs-iframe"></iframe>
      </div>
    </div>
  </div>
</div>

<script>
  // ================= 配置区域 =================
  // 如对接真实游戏服，这里只需要改成实际接口地址即可。
  function getGameServerUrl() {
    const el = document.getElementById("gameServerUrl");
    return el.value.trim();
  }

  // ================= 日志工具 =================
  const logBox = document.getElementById("logBox");
  function log(msg, type = "info") {
    const time = new Date().toISOString().substr(11, 8);
    const div = document.createElement("div");
    div.className = type === "error" ? "log-line-err" : "log-line-ok";
    div.textContent = `[${time}] ${msg}`;
    logBox.appendChild(div);
    logBox.scrollTop = logBox.scrollHeight;
  }

  // ================= Iframe 控制 =================
  const csModal = document.getElementById("csModal");
  const csOverlay = document.getElementById("csOverlay");
  const csFrame = document.getElementById("csFrame");
  const statusDot = document.getElementById("statusDot");
  const statusText = document.getElementById("statusText");
  const openBtn = document.getElementById("openBtn");
//   const closeBtn = document.getElementById("closeBtn");

  function setStatus(label, online) {
    statusText.textContent = label;
    if (online) {
      statusDot.classList.remove("offline");
    } else {
      statusDot.classList.add("offline");
    }
  }

  function openCustomerServiceWithUrl(h5Url, params) {
    const search = new URLSearchParams(params).toString();
    csFrame.src = `${h5Url.replace(/\/+$/, "")}/?${search}`;
    csOverlay.classList.add("is-open");
    csOverlay.setAttribute("aria-hidden", "false");
    setStatus("已加载", true);
    log(`打开客服：${csFrame.src}`);
  }

  function closeCustomerService() {
    csFrame.src = "about:blank";
    csOverlay.classList.remove("is-open");
    csOverlay.setAttribute("aria-hidden", "true");
    setStatus("已关闭", false);
    log("关闭客服 Iframe");
  }

//   closeBtn.addEventListener("click", () => {
//     closeCustomerService();
//   });

  // 监听 H5 通过 postMessage 发送的关闭指令
  window.addEventListener("message", (e) => {
    if (e && e.data && e.data.type === "cs-close") {
      log("收到 H5 发来的 cs-close 消息，关闭客服");
      closeCustomerService();
    }
  });

  // ================= 主流程：获取签名并打开客服 =================
  async function openCustomerService() {
    const uid = document.getElementById("uidInput").value.trim();
    const areaid = document.getElementById("areaInput").value.trim() || "1";
    if (!uid) {
      alert("UID 不能为空");
      return;
    }

    const authUrl = getGameServerUrl();
    openBtn.disabled = true;
    setStatus("获取签名中...", false);
    log(`请求签名：POST ${authUrl} uid=${uid}, areaid=${areaid}`);

    try {
      const res = await fetch(authUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ uid, areaid }),
      });

      if (!res.ok) {
        throw new Error("HTTP " + res.status);
      }

      const json = await res.json();
      if (!json.success) {
        throw new Error(json.error || "获取签名失败");
      }

      const data = json.data || {};
      // 期望字段：
      // gameid, uid, areaid, playerName, ts, nonce, sign, h5Url
      const h5Url = data.h5Url || data.csH5Url || "";
      if (!h5Url) {
        throw new Error("返回数据中缺少 h5Url");
      }

      const params = {
        gameid: data.gameid,
        uid: data.uid,
        areaid: data.areaid,
        ts: String(data.ts || ""),
        nonce: data.nonce,
        sign: data.sign,
        playerName: data.playerName || "",
        platform: "iframe",
      };

      log("签名获取成功：\n" + JSON.stringify(data, null, 2));
      setStatus("加载 H5 中...", false);
      openCustomerServiceWithUrl(h5Url, params);
    } catch (err) {
      console.error(err);
      log("获取签名失败：" + err.message, "error");
      alert("获取签名失败：" + err.message);
      setStatus("获取签名失败", false);
    } finally {
      openBtn.disabled = false;
    }
  }

  openBtn.addEventListener("click", () => {
    openCustomerService();
  });

  // 初始化状态
  (function init() {
    csOverlay.classList.remove("is-open");
    csOverlay.setAttribute("aria-hidden", "true");
    const csHeader = document.querySelector(".cs-header");
    // if (csHeader && closeBtn) {
    //   closeBtn.classList.add("cs-close-btn");
    //   csHeader.appendChild(closeBtn);
    // }
    setStatus("未加载", false);
    log("页面初始化完成，可点击“打开客服（Iframe）”开始测试");
  })();
</script>
</body>
</html>
