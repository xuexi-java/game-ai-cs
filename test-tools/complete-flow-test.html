<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®Œæ•´æµç¨‹æµ‹è¯• - æ¸¸æˆå®¢æˆ·ç«¯ â†’ æ¸¸æˆæœåŠ¡å™¨ â†’ å®¢æœç³»ç»Ÿ</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #fff;
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    h1 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 24px;
      background: linear-gradient(90deg, #00d2ff, #3a7bd5);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .subtitle {
      text-align: center;
      color: #888;
      margin-bottom: 30px;
      font-size: 14px;
    }

    /* æµç¨‹å›¾ */
    .flow-diagram {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    .flow-box {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 15px 25px;
      text-align: center;
      border: 2px solid transparent;
      transition: all 0.3s;
    }
    .flow-box.active {
      border-color: #00d2ff;
      box-shadow: 0 0 20px rgba(0,210,255,0.3);
    }
    .flow-box.completed {
      border-color: #00ff88;
      background: rgba(0,255,136,0.1);
    }
    .flow-box.error {
      border-color: #ff4757;
      background: rgba(255,71,87,0.1);
    }
    .flow-box h3 { font-size: 14px; margin-bottom: 5px; }
    .flow-box p { font-size: 12px; color: #aaa; }
    .flow-arrow {
      font-size: 24px;
      color: #555;
    }
    .flow-arrow.active { color: #00d2ff; }

    /* ä¸»è¦å†…å®¹åŒº */
    .main-content {
      display: grid;
      grid-template-columns: 350px 1fr 350px;
      gap: 20px;
    }
    @media (max-width: 1200px) {
      .main-content { grid-template-columns: 1fr; }
    }

    /* é¢æ¿æ ·å¼ */
    .panel {
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .panel h2 {
      font-size: 16px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .panel h2 .icon { font-size: 20px; }

    /* ç©å®¶é€‰æ‹© */
    .player-list { display: flex; flex-direction: column; gap: 10px; }
    .player-card {
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    .player-card:hover { background: rgba(255,255,255,0.1); }
    .player-card.selected {
      border-color: #00d2ff;
      background: rgba(0,210,255,0.1);
    }
    .player-card .name { font-weight: bold; margin-bottom: 5px; }
    .player-card .info { font-size: 12px; color: #888; }

    /* æŒ‰é’® */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.2s;
      width: 100%;
      margin-top: 15px;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-primary {
      background: linear-gradient(90deg, #00d2ff, #3a7bd5);
      color: white;
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0,210,255,0.4);
    }
    .btn-success {
      background: linear-gradient(90deg, #00ff88, #00b894);
      color: #1a1a2e;
    }
    .btn-danger {
      background: linear-gradient(90deg, #ff4757, #ff6b81);
      color: white;
    }

    /* èŠå¤©åŒºåŸŸ */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 500px;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      margin-bottom: 15px;
    }
    .message {
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
    }
    .message.player { align-items: flex-end; }
    .message.agent, .message.system, .message.ai { align-items: flex-start; }
    .message .bubble {
      max-width: 80%;
      padding: 10px 15px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
    }
    .message.player .bubble {
      background: linear-gradient(135deg, #00d2ff, #3a7bd5);
      border-bottom-right-radius: 4px;
    }
    .message.agent .bubble {
      background: rgba(255,255,255,0.15);
      border-bottom-left-radius: 4px;
    }
    .message.system .bubble {
      background: rgba(255,193,7,0.2);
      color: #ffc107;
      font-size: 12px;
    }
    .message.ai .bubble {
      background: rgba(156,39,176,0.2);
      border-bottom-left-radius: 4px;
    }
    .message .sender {
      font-size: 11px;
      color: #888;
      margin-bottom: 4px;
    }
    .message .time {
      font-size: 10px;
      color: #666;
      margin-top: 4px;
    }

    /* è¾“å…¥åŒºåŸŸ */
    .chat-input {
      display: flex;
      gap: 10px;
    }
    .chat-input input {
      flex: 1;
      padding: 12px 15px;
      border: none;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: white;
      font-size: 14px;
    }
    .chat-input input:focus {
      outline: none;
      background: rgba(255,255,255,0.15);
    }
    .chat-input button {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      background: #00d2ff;
      color: #1a1a2e;
      font-weight: bold;
      cursor: pointer;
    }
    .chat-input button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* æ—¥å¿—åŒºåŸŸ */
    .log-container {
      height: 500px;
      overflow-y: auto;
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      padding: 15px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 12px;
    }
    .log-entry {
      margin-bottom: 8px;
      padding: 8px 10px;
      border-radius: 6px;
      background: rgba(255,255,255,0.05);
      border-left: 3px solid #555;
    }
    .log-entry.info { border-left-color: #00d2ff; }
    .log-entry.success { border-left-color: #00ff88; }
    .log-entry.error { border-left-color: #ff4757; }
    .log-entry.warn { border-left-color: #ffc107; }
    .log-entry .time { color: #666; margin-right: 10px; }
    .log-entry .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      margin-right: 8px;
    }
    .log-entry.info .tag { background: rgba(0,210,255,0.2); color: #00d2ff; }
    .log-entry.success .tag { background: rgba(0,255,136,0.2); color: #00ff88; }
    .log-entry.error .tag { background: rgba(255,71,87,0.2); color: #ff4757; }
    .log-entry.warn .tag { background: rgba(255,193,7,0.2); color: #ffc107; }

    /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 15px;
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
      margin-bottom: 15px;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #666;
    }
    .status-dot.connected { background: #00ff88; box-shadow: 0 0 10px #00ff88; }
    .status-dot.connecting { background: #ffc107; animation: pulse 1s infinite; }
    .status-dot.error { background: #ff4757; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* é—®é¢˜åˆ†ç±» */
    .category-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .category-btn {
      padding: 8px 16px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 20px;
      background: transparent;
      color: white;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    .category-btn:hover {
      background: rgba(0,210,255,0.2);
      border-color: #00d2ff;
    }

    /* æ•°æ®å±•ç¤º */
    .data-display {
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      padding: 12px;
      margin-top: 10px;
      font-family: monospace;
      font-size: 11px;
      word-break: break-all;
      max-height: 150px;
      overflow-y: auto;
    }
    .data-display .key { color: #00d2ff; }
    .data-display .value { color: #00ff88; }
  </style>
</head>
<body>
  <div class="container">
    <h1>å®Œæ•´æµç¨‹æµ‹è¯•</h1>
    <p class="subtitle">æ¨¡æ‹Ÿ: æ¸¸æˆå®¢æˆ·ç«¯ â†’ æ¸¸æˆæœåŠ¡å™¨è·å–è®¤è¯ â†’ è¿æ¥å®¢æœç³»ç»Ÿ</p>

    <!-- æµç¨‹å›¾ -->
    <div class="flow-diagram">
      <div class="flow-box" id="step1">
        <h3>1. é€‰æ‹©ç©å®¶</h3>
        <p>æ¸¸æˆå®¢æˆ·ç«¯</p>
      </div>
      <span class="flow-arrow">â†’</span>
      <div class="flow-box" id="step2">
        <h3>2. è·å–è®¤è¯</h3>
        <p>æ¸¸æˆæœåŠ¡å™¨</p>
      </div>
      <span class="flow-arrow">â†’</span>
      <div class="flow-box" id="step3">
        <h3>3. Bootstrap</h3>
        <p>å®¢æœç³»ç»Ÿ API</p>
      </div>
      <span class="flow-arrow">â†’</span>
      <div class="flow-box" id="step4">
        <h3>4. WebSocket</h3>
        <p>å®æ—¶é€šä¿¡</p>
      </div>
      <span class="flow-arrow">â†’</span>
      <div class="flow-box" id="step5">
        <h3>5. åˆ›å»ºå·¥å•</h3>
        <p>å¼€å§‹å’¨è¯¢</p>
      </div>
    </div>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="main-content">
      <!-- å·¦ä¾§: ç©å®¶é€‰æ‹© -->
      <div class="panel">
        <h2><span class="icon">ğŸ®</span> æ¸¸æˆå®¢æˆ·ç«¯</h2>

        <div class="status-indicator">
          <div class="status-dot" id="gameServerStatus"></div>
          <span id="gameServerStatusText">æ£€æŸ¥æ¸¸æˆæœåŠ¡å™¨...</span>
        </div>

        <h3 style="font-size: 14px; margin-bottom: 10px;">é€‰æ‹©ç©å®¶:</h3>
        <div class="player-list" id="playerList">
          <!-- åŠ¨æ€å¡«å…… -->
        </div>

        <button class="btn btn-primary" id="btnGetAuth" disabled>
          è·å–å®¢æœè®¤è¯
        </button>

        <div id="authData" style="display: none;">
          <h3 style="font-size: 14px; margin: 15px 0 10px;">è®¤è¯æ•°æ®:</h3>
          <div class="data-display" id="authDataContent"></div>
        </div>

        <button class="btn btn-success" id="btnConnect" style="display: none;">
          è¿æ¥å®¢æœç³»ç»Ÿ
        </button>
      </div>

      <!-- ä¸­é—´: èŠå¤©åŒºåŸŸ -->
      <div class="panel">
        <h2><span class="icon">ğŸ’¬</span> å®¢æœå¯¹è¯</h2>

        <div class="status-indicator">
          <div class="status-dot" id="wsStatus"></div>
          <span id="wsStatusText">æœªè¿æ¥</span>
        </div>

        <div class="chat-container">
          <div class="chat-messages" id="chatMessages">
            <div class="message system">
              <div class="bubble">è¯·å…ˆé€‰æ‹©ç©å®¶å¹¶è·å–è®¤è¯</div>
            </div>
          </div>

          <div id="categorySection" style="display: none;">
            <p style="font-size: 13px; color: #aaa; margin-bottom: 8px;">è¯·é€‰æ‹©é—®é¢˜ç±»å‹:</p>
            <div class="category-list" id="categoryList"></div>
          </div>

          <div class="chat-input">
            <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." disabled>
            <button id="btnSend" disabled>å‘é€</button>
          </div>
        </div>
      </div>

      <!-- å³ä¾§: æ—¥å¿— -->
      <div class="panel">
        <h2><span class="icon">ğŸ“‹</span> è°ƒè¯•æ—¥å¿—</h2>
        <div class="log-container" id="logContainer"></div>
      </div>
    </div>
  </div>

  <script>
    // ============ é…ç½® ============
    const GAME_SERVER_URL = 'http://localhost:3001';
    const CS_API_URL = 'http://localhost:21101';

    // ============ çŠ¶æ€ ============
    let selectedPlayer = null;
    let authInfo = null;
    let bootstrapData = null;
    let socket = null;
    let currentTid = null;

    // ============ DOM å…ƒç´  ============
    const $ = id => document.getElementById(id);

    // ============ æ—¥å¿— ============
    function log(type, tag, message) {
      const container = $('logContainer');
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.innerHTML = `
        <span class="time">${time}</span>
        <span class="tag">${tag}</span>
        ${message}
      `;
      container.appendChild(entry);
      container.scrollTop = container.scrollHeight;
      console.log(`[${tag}] ${message}`);
    }

    // ============ æµç¨‹æ­¥éª¤é«˜äº® ============
    function setStepStatus(stepId, status) {
      const step = $(stepId);
      step.className = 'flow-box ' + status;
    }

    // ============ èŠå¤©æ¶ˆæ¯ ============
    function addChatMessage(sender, content, type = 'text') {
      const container = $('chatMessages');
      const senderClass = sender.toLowerCase();
      const senderName = {
        'player': 'æˆ‘',
        'agent': 'å®¢æœ',
        'system': 'ç³»ç»Ÿ',
        'ai': 'AIåŠ©æ‰‹'
      }[senderClass] || sender;

      const msg = document.createElement('div');
      msg.className = `message ${senderClass}`;
      msg.innerHTML = `
        <span class="sender">${senderName}</span>
        <div class="bubble">${content}</div>
        <span class="time">${new Date().toLocaleTimeString()}</span>
      `;
      container.appendChild(msg);
      container.scrollTop = container.scrollHeight;
    }

    // ============ åˆå§‹åŒ–: æ£€æŸ¥æ¸¸æˆæœåŠ¡å™¨ ============
    async function init() {
      setStepStatus('step1', 'active');
      log('info', 'INIT', 'æ­£åœ¨æ£€æŸ¥æ¸¸æˆæœåŠ¡å™¨...');

      try {
        const response = await fetch(`${GAME_SERVER_URL}/api/config`);
        const result = await response.json();

        if (result.success) {
          $('gameServerStatus').className = 'status-dot connected';
          $('gameServerStatusText').textContent = 'æ¸¸æˆæœåŠ¡å™¨å·²è¿æ¥';
          log('success', 'GAME', `æ¸¸æˆæœåŠ¡å™¨è¿æ¥æˆåŠŸ: ${result.data.gameId}`);

          // æ¸²æŸ“ç©å®¶åˆ—è¡¨
          renderPlayerList(result.data.players);
          setStepStatus('step1', 'completed');
        }
      } catch (error) {
        $('gameServerStatus').className = 'status-dot error';
        $('gameServerStatusText').textContent = 'æ¸¸æˆæœåŠ¡å™¨æœªå¯åŠ¨';
        log('error', 'GAME', `è¿æ¥å¤±è´¥: ${error.message}`);
        log('warn', 'TIP', 'è¯·å…ˆå¯åŠ¨æ¸¸æˆæœåŠ¡å™¨: node mock-game-server.js');
        setStepStatus('step1', 'error');
      }
    }

    // ============ æ¸²æŸ“ç©å®¶åˆ—è¡¨ ============
    function renderPlayerList(players) {
      const container = $('playerList');
      container.innerHTML = '';

      players.forEach(player => {
        const card = document.createElement('div');
        card.className = 'player-card';
        card.innerHTML = `
          <div class="name">${player.name} (${player.uid})</div>
          <div class="info">Lv.${player.level} | VIP${player.vip} | åŒºæœ: 1</div>
        `;
        card.onclick = () => selectPlayer(player, card);
        container.appendChild(card);
      });
    }

    // ============ é€‰æ‹©ç©å®¶ ============
    function selectPlayer(player, card) {
      // å–æ¶ˆä¹‹å‰çš„é€‰æ‹©
      document.querySelectorAll('.player-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');

      selectedPlayer = player;
      $('btnGetAuth').disabled = false;
      log('info', 'SELECT', `é€‰æ‹©ç©å®¶: ${player.name} (${player.uid})`);
    }

    // ============ è·å–å®¢æœè®¤è¯ ============
    async function getAuth() {
      if (!selectedPlayer) return;

      setStepStatus('step2', 'active');
      log('info', 'AUTH', `å‘æ¸¸æˆæœåŠ¡å™¨è¯·æ±‚è®¤è¯: uid=${selectedPlayer.uid}`);

      try {
        const response = await fetch(`${GAME_SERVER_URL}/api/get-cs-auth`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            uid: selectedPlayer.uid,
            areaid: '1'
          })
        });

        const result = await response.json();

        if (result.success) {
          authInfo = result.data;
          log('success', 'AUTH', 'è·å–è®¤è¯æˆåŠŸ');
          log('info', 'DATA', `gameid=${authInfo.gameid}, sign=${authInfo.sign.substring(0, 16)}...`);

          // æ˜¾ç¤ºè®¤è¯æ•°æ®
          $('authData').style.display = 'block';
          $('authDataContent').innerHTML = `
            <div><span class="key">gameid:</span> <span class="value">${authInfo.gameid}</span></div>
            <div><span class="key">uid:</span> <span class="value">${authInfo.uid}</span></div>
            <div><span class="key">areaid:</span> <span class="value">${authInfo.areaid}</span></div>
            <div><span class="key">playerName:</span> <span class="value">${authInfo.playerName}</span></div>
            <div><span class="key">nonce:</span> <span class="value">${authInfo.nonce}</span></div>
            <div><span class="key">sign:</span> <span class="value">${authInfo.sign}</span></div>
          `;

          $('btnConnect').style.display = 'block';
          $('btnGetAuth').disabled = true;
          setStepStatus('step2', 'completed');
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        log('error', 'AUTH', `è·å–è®¤è¯å¤±è´¥: ${error.message}`);
        setStepStatus('step2', 'error');
      }
    }

    // ============ è¿æ¥å®¢æœç³»ç»Ÿ ============
    async function connectCS() {
      if (!authInfo) return;

      setStepStatus('step3', 'active');
      log('info', 'CS', 'è°ƒç”¨å®¢æœç³»ç»Ÿ Bootstrap API...');

      try {
        // 1. è°ƒç”¨ Bootstrap API
        const response = await fetch(`${CS_API_URL}/api/v1/player/connect`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            gameid: authInfo.gameid,
            uid: authInfo.uid,
            areaid: authInfo.areaid,
            playerName: authInfo.playerName,
            nonce: authInfo.nonce,
            sign: authInfo.sign
          })
        });

        const result = await response.json();
        log('info', 'CS', `API å“åº”çŠ¶æ€: ${response.status}`);

        // å¤„ç†åµŒå¥—å“åº”
        const apiResult = result.data || result;
        const apiData = apiResult.data || apiResult;

        if (apiResult.result || result.success) {
          bootstrapData = apiData;
          log('success', 'CS', 'Bootstrap æˆåŠŸ');
          log('info', 'DATA', `wsUrl=${bootstrapData.wsUrl}`);
          log('info', 'DATA', `wsToken=${bootstrapData.wsToken?.substring(0, 20)}...`);
          log('info', 'DATA', `é—®é¢˜ç±»å‹: ${bootstrapData.questList?.length || 0} ä¸ª`);

          setStepStatus('step3', 'completed');
          $('btnConnect').style.display = 'none';

          // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
          $('chatMessages').innerHTML = '';
          if (bootstrapData.bootstrapMessages) {
            bootstrapData.bootstrapMessages.forEach(msg => {
              addChatMessage(msg.senderType, msg.content);
            });
          }

          // 2. è¿æ¥ WebSocket
          connectWebSocket();
        } else {
          throw new Error(apiResult.error || result.error || 'æœªçŸ¥é”™è¯¯');
        }
      } catch (error) {
        log('error', 'CS', `Bootstrap å¤±è´¥: ${error.message}`);
        setStepStatus('step3', 'error');
      }
    }

    // ============ è¿æ¥ WebSocket ============
    function connectWebSocket() {
      setStepStatus('step4', 'active');
      log('info', 'WS', `è¿æ¥ WebSocket: ${bootstrapData.wsUrl}`);

      $('wsStatus').className = 'status-dot connecting';
      $('wsStatusText').textContent = 'è¿æ¥ä¸­...';

      socket = io(bootstrapData.wsUrl, {
        auth: { token: bootstrapData.wsToken },
        transports: ['websocket', 'polling']
      });

      socket.on('connect', () => {
        log('success', 'WS', `è¿æ¥æˆåŠŸ: ${socket.id}`);
        $('wsStatus').className = 'status-dot connected';
        $('wsStatusText').textContent = 'å·²è¿æ¥';
        setStepStatus('step4', 'completed');

        // æ˜¾ç¤ºé—®é¢˜åˆ†ç±»
        showCategories();
      });

      socket.on('disconnect', (reason) => {
        log('warn', 'WS', `æ–­å¼€è¿æ¥: ${reason}`);
        $('wsStatus').className = 'status-dot';
        $('wsStatusText').textContent = 'å·²æ–­å¼€';
      });

      socket.on('error', (data) => {
        log('error', 'WS', `é”™è¯¯: ${data.message || JSON.stringify(data)}`);
      });

      socket.on('connection:ready', (data) => {
        log('success', 'WS', `è¿æ¥å°±ç»ª: gameid=${data.gameid}, uid=${data.uid}`);
        showCategories();
      });

      socket.on('ticket:created', (data) => {
        log('success', 'WS', `å·¥å•å·²åˆ›å»º: ${data.tid}`);
        currentTid = data.tid;
        addChatMessage('system', `å·¥å• ${data.tid} å·²åˆ›å»ºï¼Œç­‰å¾…å®¢æœæ¥å…¥...`);
        setStepStatus('step5', 'completed');
        enableInput();
      });

      socket.on('agent_assigned', (data) => {
        log('success', 'WS', `å®¢æœå·²åˆ†é…: ${data.agentName}`);
        addChatMessage('system', `å®¢æœ ${data.agentName} ä¸ºæ‚¨æœåŠ¡`);
      });

      socket.on('message', (data) => {
        log('info', 'MSG', `æ”¶åˆ°æ¶ˆæ¯: [${data.senderType}] ${data.content?.substring(0, 50) || ''}...`);
        addChatMessage(data.senderType || 'system', data.content || '');
      });

      socket.on('message:ack', (data) => {
        log('info', 'ACK', `æ¶ˆæ¯ç¡®è®¤: ${data.clientMsgId}`);
      });

      socket.on('queue-update', (data) => {
        log('info', 'QUEUE', `æ’é˜Ÿä½ç½®: ${data.position}`);
        if (data.position > 0) {
          addChatMessage('system', `æ­£åœ¨æ’é˜Ÿï¼Œå½“å‰ç¬¬ ${data.position} ä½`);
        }
      });

      socket.on('typing:status', (data) => {
        if (data.isTyping && data.senderType !== 'PLAYER') {
          log('info', 'TYPING', `${data.senderType} æ­£åœ¨è¾“å…¥...`);
        }
      });
    }

    // ============ æ˜¾ç¤ºé—®é¢˜åˆ†ç±» ============
    function showCategories() {
      if (!bootstrapData.questList || bootstrapData.questList.length === 0) {
        log('warn', 'CS', 'æ²¡æœ‰é—®é¢˜åˆ†ç±»');
        return;
      }

      setStepStatus('step5', 'active');
      const container = $('categoryList');
      container.innerHTML = '';

      bootstrapData.questList.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'category-btn';
        btn.textContent = cat.name;
        btn.onclick = () => selectCategory(cat);
        container.appendChild(btn);
      });

      $('categorySection').style.display = 'block';
      log('info', 'CS', 'è¯·é€‰æ‹©é—®é¢˜ç±»å‹');
    }

    // ============ é€‰æ‹©é—®é¢˜åˆ†ç±» ============
    function selectCategory(category) {
      log('info', 'CS', `é€‰æ‹©åˆ†ç±»: ${category.name}`);
      addChatMessage('player', `æˆ‘è¦å’¨è¯¢: ${category.name}`);
      $('categorySection').style.display = 'none';

      // åˆ›å»ºå·¥å•
      socket.emit('ticket:create', {
        issueType: category.id,
        confirmClose: true
      });

      log('info', 'WS', `åˆ›å»ºå·¥å•: issueType=${category.id}`);
    }

    // ============ å¯ç”¨è¾“å…¥ ============
    function enableInput() {
      $('messageInput').disabled = false;
      $('btnSend').disabled = false;
      $('messageInput').focus();
    }

    // ============ å‘é€æ¶ˆæ¯ ============
    function sendMessage() {
      const input = $('messageInput');
      const content = input.value.trim();
      if (!content || !socket) return;

      const clientMsgId = `msg_${Date.now()}`;
      socket.emit('message:send', {
        clientMsgId,
        content,
        type: 'TEXT'
      });

      addChatMessage('player', content);
      log('info', 'MSG', `å‘é€æ¶ˆæ¯: ${content.substring(0, 50)}...`);
      input.value = '';
    }

    // ============ äº‹ä»¶ç»‘å®š ============
    $('btnGetAuth').onclick = getAuth;
    $('btnConnect').onclick = connectCS;
    $('btnSend').onclick = sendMessage;
    $('messageInput').onkeypress = (e) => {
      if (e.key === 'Enter') sendMessage();
    };

    // ============ å¯åŠ¨ ============
    init();
  </script>
</body>
</html>
