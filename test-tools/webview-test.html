<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebView-Player 测试工具</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    .log-entry { font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; }
    .log-info { color: #3b82f6; }
    .log-success { color: #22c55e; }
    .log-error { color: #ef4444; }
    .log-warn { color: #f59e0b; }
    .log-event { color: #8b5cf6; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-2xl font-bold text-gray-800 mb-6">WebView-Player 测试工具</h1>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- 左侧：配置和操作 -->
      <div class="space-y-4">
        <!-- 配置区域 -->
        <div class="bg-white rounded-lg shadow p-4">
          <h2 class="text-lg font-semibold mb-4 text-gray-700">配置参数</h2>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">API Base URL</label>
              <input type="text" id="apiUrl" value="http://localhost:21101"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">Game ID</label>
                <input type="text" id="gameid" value="弹弹堂"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">Player UID</label>
                <input type="text" id="uid" value="player_001"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">Area ID</label>
                <input type="text" id="areaid" value="1"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">Player Name</label>
                <input type="text" id="playerName" value="测试玩家"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">Nonce (从游戏配置获取)</label>
                <input type="text" id="nonce" placeholder="固定nonce值"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">Secret (s3cr3t_k7m9n2p4q6x8w1e5r0t2y4u6)</label>
                <input type="password" id="secret" placeholder="签名密钥"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
            </div>
          </div>
        </div>

        <!-- 操作按钮 -->
        <div class="bg-white rounded-lg shadow p-4">
          <h2 class="text-lg font-semibold mb-4 text-gray-700">操作</h2>
          <div class="flex flex-wrap gap-2">
            <button onclick="generateAndShowSign()"
              class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition">
              生成签名
            </button>
            <button onclick="callBootstrap()"
              class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
              调用 Bootstrap
            </button>
            <button onclick="connectWebSocket()" id="btnConnect"
              class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              连接 WebSocket
            </button>
            <button onclick="disconnectWebSocket()" id="btnDisconnect"
              class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              断开连接
            </button>
            <button onclick="clearLogs()"
              class="px-4 py-2 bg-gray-400 text-white rounded-md hover:bg-gray-500 transition">
              清空日志
            </button>
          </div>

          <!-- 连接状态 -->
          <div class="mt-4 flex items-center gap-2">
            <span class="text-sm text-gray-600">连接状态:</span>
            <span id="connectionStatus" class="px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-600">未连接</span>
          </div>
        </div>

        <!-- 工单和消息 -->
        <div class="bg-white rounded-lg shadow p-4">
          <h2 class="text-lg font-semibold mb-4 text-gray-700">工单和消息</h2>

          <!-- 问题分类选择 -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-600 mb-1">问题分类</label>
            <div class="flex gap-2">
              <select id="issueType" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">-- 先调用 Bootstrap 获取分类 --</option>
              </select>
              <button onclick="createTicket()" id="btnCreateTicket"
                class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                创建工单
              </button>
            </div>
          </div>

          <!-- 当前工单 -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-600 mb-1">当前工单 ID</label>
            <input type="text" id="currentTid" readonly placeholder="创建工单后显示"
              class="w-full px-3 py-2 border border-gray-200 rounded-md bg-gray-50 text-gray-600">
          </div>

          <!-- 发送消息 -->
          <div>
            <label class="block text-sm font-medium text-gray-600 mb-1">发送消息</label>
            <div class="flex gap-2">
              <input type="text" id="messageText" placeholder="输入消息内容..."
                class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                onkeypress="if(event.key==='Enter') sendMessage()">
              <button onclick="sendMessage()" id="btnSendMessage"
                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                发送
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 右侧：日志 -->
      <div class="bg-white rounded-lg shadow p-4 h-[calc(100vh-8rem)] flex flex-col">
        <h2 class="text-lg font-semibold mb-4 text-gray-700">日志</h2>
        <div id="logContainer" class="flex-1 overflow-y-auto bg-gray-900 rounded-md p-3 space-y-1">
          <div class="log-entry text-gray-400">等待操作...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 全局状态
    let socket = null;
    let wsUrl = null;
    let wsToken = null;
    let currentTid = null;
    let questList = [];

    // 日志函数
    function log(type, message, data = null) {
      const container = document.getElementById('logContainer');
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;

      let content = `[${time}] ${message}`;
      if (data) {
        content += '\n' + JSON.stringify(data, null, 2);
      }
      entry.textContent = content;
      container.appendChild(entry);
      container.scrollTop = container.scrollHeight;
    }

    function clearLogs() {
      document.getElementById('logContainer').innerHTML = '<div class="log-entry text-gray-400">日志已清空</div>';
    }

    // 获取配置值
    function getConfig() {
      return {
        apiUrl: document.getElementById('apiUrl').value.trim(),
        gameid: document.getElementById('gameid').value.trim(),
        uid: document.getElementById('uid').value.trim(),
        areaid: document.getElementById('areaid').value.trim(),
        playerName: document.getElementById('playerName').value.trim(),
        nonce: document.getElementById('nonce').value.trim(),
        secret: document.getElementById('secret').value.trim()
      };
    }

    // 生成签名
    function generateSign(gameid, uid, areaid, nonce, secret) {
      const signStr = `${gameid}|${uid}|${areaid}|${nonce}|${secret}`;
      const sign = CryptoJS.MD5(signStr).toString().toLowerCase();
      return sign;
    }

    function generateAndShowSign() {
      const config = getConfig();
      if (!config.nonce || !config.secret) {
        log('warn', '请先填写 Nonce 和 Secret');
        return;
      }
      const sign = generateSign(config.gameid, config.uid, config.areaid, config.nonce, config.secret);
      log('info', '签名生成成功', {
        signString: `${config.gameid}|${config.uid}|${config.areaid}|${config.nonce}|***`,
        sign: sign
      });
    }

    // 调用 Bootstrap API
    async function callBootstrap() {
      const config = getConfig();

      if (!config.nonce || !config.secret) {
        log('error', '请先填写 Nonce 和 Secret');
        return;
      }

      log('info', '正在调用 Bootstrap API...');

      const sign = generateSign(config.gameid, config.uid, config.areaid, config.nonce, config.secret);

      const body = {
        gameid: config.gameid,
        uid: config.uid,
        areaid: config.areaid,
        playerName: config.playerName,
        nonce: config.nonce,
        sign: sign
      };

      try {
        const url = `${config.apiUrl}/api/v1/player/connect`;
        log('info', '请求 URL: ' + url);

        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        log('info', '响应状态: ' + response.status + ' ' + response.statusText);

        const result = await response.json();
        log('info', '响应数据', result);

        // 处理嵌套响应结构: { success, data: { result, data } }
        const actualResult = result.data || result;
        const actualData = actualResult.data || actualResult;

        if (actualResult.result || result.success) {
          log('success', 'Bootstrap 成功', actualData);

          // 保存连接信息
          wsUrl = actualData.wsUrl;
          wsToken = actualData.wsToken;
          questList = actualData.questList || [];

          // 更新问题分类下拉框
          const select = document.getElementById('issueType');
          select.innerHTML = '<option value="">-- 选择问题分类 --</option>';
          questList.forEach(q => {
            const option = document.createElement('option');
            option.value = q.id;
            option.textContent = `${q.name} (${q.routeMode})`;
            select.appendChild(option);
          });

          // 启用连接按钮
          document.getElementById('btnConnect').disabled = false;

          log('info', `获取到 ${questList.length} 个问题分类`);
          log('info', `WebSocket URL: ${wsUrl}`);
        } else {
          log('error', 'Bootstrap 失败', { error: result.error, errorCode: result.errorCode });
        }
      } catch (error) {
        log('error', 'Bootstrap 请求失败', {
          message: error.message,
          name: error.name,
          stack: error.stack?.split('\n').slice(0, 3).join('\n')
        });
      }
    }

    // 连接 WebSocket
    function connectWebSocket() {
      if (!wsUrl || !wsToken) {
        log('error', '请先调用 Bootstrap 获取连接信息');
        return;
      }

      log('info', '正在连接 WebSocket...');

      socket = io(wsUrl, {
        transports: ['websocket'],
        auth: { token: wsToken }
      });

      // 连接事件
      socket.on('connect', () => {
        log('success', 'WebSocket 连接成功', { socketId: socket.id });
        updateConnectionStatus('已连接', 'bg-green-100 text-green-700');
        document.getElementById('btnConnect').disabled = true;
        document.getElementById('btnDisconnect').disabled = false;
        document.getElementById('btnCreateTicket').disabled = false;
      });

      socket.on('disconnect', (reason) => {
        log('warn', 'WebSocket 断开连接', { reason });
        updateConnectionStatus('已断开', 'bg-red-100 text-red-700');
        document.getElementById('btnConnect').disabled = false;
        document.getElementById('btnDisconnect').disabled = true;
        document.getElementById('btnCreateTicket').disabled = true;
        document.getElementById('btnSendMessage').disabled = true;
      });

      socket.on('connect_error', (error) => {
        log('error', 'WebSocket 连接错误', { message: error.message });
        updateConnectionStatus('连接错误', 'bg-red-100 text-red-700');
      });

      // 业务事件
      socket.on('connection:ready', (data) => {
        log('event', '收到事件: connection:ready', data);
      });

      socket.on('ticket:created', (data) => {
        log('event', '收到事件: ticket:created', data);
        currentTid = data.tid;
        document.getElementById('currentTid').value = currentTid;
        document.getElementById('btnSendMessage').disabled = false;
      });

      socket.on('message:ack', (data) => {
        log('event', '收到事件: message:ack', data);
      });

      socket.on('message', (data) => {
        log('event', '收到消息', data);
      });

      socket.on('queue:update', (data) => {
        log('event', '收到事件: queue:update', data);
      });

      socket.on('agent:assigned', (data) => {
        log('event', '收到事件: agent:assigned', data);
      });

      socket.on('ticket:update', (data) => {
        log('event', '收到事件: ticket:update', data);
      });

      socket.on('typing:status', (data) => {
        log('event', '收到事件: typing:status', data);
      });

      socket.on('connection:kicked', (data) => {
        log('warn', '收到事件: connection:kicked', data);
      });

      socket.on('error', (data) => {
        log('error', '收到错误事件', data);
      });
    }

    function disconnectWebSocket() {
      if (socket) {
        socket.disconnect();
        socket = null;
        log('info', '已手动断开连接');
      }
    }

    function updateConnectionStatus(text, className) {
      const status = document.getElementById('connectionStatus');
      status.textContent = text;
      status.className = `px-2 py-1 text-xs rounded-full ${className}`;
    }

    // 创建工单
    function createTicket() {
      const issueTypeId = document.getElementById('issueType').value;
      if (!issueTypeId) {
        log('warn', '请选择问题分类');
        return;
      }

      if (!socket || !socket.connected) {
        log('error', '请先连接 WebSocket');
        return;
      }

      log('info', '正在创建工单...', { issueType: issueTypeId });
      socket.emit('ticket:create', { issueType: issueTypeId });
    }

    // 发送消息
    function sendMessage() {
      const text = document.getElementById('messageText').value.trim();
      if (!text) {
        log('warn', '请输入消息内容');
        return;
      }

      if (!socket || !socket.connected) {
        log('error', '请先连接 WebSocket');
        return;
      }

      if (!currentTid) {
        log('error', '请先创建工单');
        return;
      }

      const clientMsgId = `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

      log('info', '发送消息', { content: text, clientMsgId, type: 'TEXT' });

      socket.emit('message:send', {
        content: text,
        clientMsgId: clientMsgId,
        type: 'TEXT'
      });

      document.getElementById('messageText').value = '';
    }

    // 页面加载完成
    document.addEventListener('DOMContentLoaded', () => {
      log('info', '测试工具已加载');
      log('info', '请填写配置参数后点击"调用 Bootstrap"开始测试');
    });
  </script>
</body>
</html>
