server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # 后端应用日志（JSON 格式）
  - job_name: backend-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: backend
          service: game-ai-backend
          __path__: /var/log/backend/*.log
    pipeline_stages:
      # 解析 JSON 日志
      - json:
          expressions:
            level: level
            lv: lv
            traceId: traceId
            tid: tid
            userId: userId
            uid: uid
            context: context
            ctx: ctx
            message: message
            msg: msg
            timestamp: timestamp
            t: t
      # 提取标签
      - labels:
          level:
          lv:
          context:
          ctx:
      # 使用日志中的时间戳
      - timestamp:
          source: timestamp
          format: RFC3339Nano
          fallback_formats:
            - "2006-01-02T15:04:05.000Z07:00"
            - "2006-01-02 15:04:05.000"
      # 重写标签（统一 level 和 lv）
      - template:
          source: level
          template: '{{ if .lv }}{{ .lv }}{{ else }}{{ .level }}{{ end }}'
      - labels:
          level:

  # 错误日志单独采集（便于告警）
  - job_name: backend-error-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: backend-errors
          service: game-ai-backend
          severity: error
          __path__: /var/log/backend/*.error.log
    pipeline_stages:
      - json:
          expressions:
            level: level
            traceId: traceId
            errorCode: errorCode
            errorMessage: errorMessage
            stack: stack
      - labels:
          level:
          errorCode:
