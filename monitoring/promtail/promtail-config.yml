server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push
    batchwait: 1s
    batchsize: 1048576
    timeout: 10s

scrape_configs:
  # 后端应用日志（JSON 格式）
  - job_name: backend-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: backend
          service: game-ai-backend
          env: production
          __path__: /var/log/backend/backend-*.log
    pipeline_stages:
      # 解析 JSON 日志
      - json:
          expressions:
            level: level
            traceId: traceId
            userId: userId
            context: context
            message: message
            timestamp: timestamp
            method: method
            path: path
            statusCode: statusCode
            duration: duration
            action: action
      # 提取标签
      - labels:
          level:
          context:
          method:
          statusCode:
      # 使用日志中的时间戳
      - timestamp:
          source: timestamp
          format: RFC3339Nano
          fallback_formats:
            - "2006-01-02T15:04:05.000Z07:00"
            - "2006-01-02T15:04:05.000Z"
            - "2006-01-02 15:04:05.000"
      # 标准化日志级别
      - template:
          source: level
          template: '{{ ToLower .level }}'
      - labels:
          level:
      # 添加 traceId 到日志行用于关联
      - output:
          source: message

  # 错误日志单独采集（便于告警）
  - job_name: backend-error-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: backend-errors
          service: game-ai-backend
          severity: error
          env: production
          __path__: /var/log/backend/backend-*.error.log
    pipeline_stages:
      - json:
          expressions:
            level: level
            traceId: traceId
            userId: userId
            context: context
            errorCode: errorCode
            errorMessage: errorMessage
            stack: stack
            timestamp: timestamp
      - labels:
          level:
          context:
          errorCode:
      - timestamp:
          source: timestamp
          format: RFC3339Nano
          fallback_formats:
            - "2006-01-02T15:04:05.000Z07:00"
            - "2006-01-02T15:04:05.000Z"
      # 格式化错误日志输出
      - template:
          source: formatted
          template: '[{{ .errorCode }}] {{ .errorMessage }}'
      - output:
          source: formatted

  # Docker 容器日志（可选）
  - job_name: docker-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: docker
          __path__: /var/lib/docker/containers/*/*.log
    pipeline_stages:
      - json:
          expressions:
            log: log
            stream: stream
            time: time
      - labels:
          stream:
      - timestamp:
          source: time
          format: RFC3339Nano
      - output:
          source: log
