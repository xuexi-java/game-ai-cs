groups:
  - name: game-ai-backend-alerts
    rules:
      # ========== 服务可用性告警 ==========
      - alert: BackendServiceDown
        expr: up{job="game-ai-backend"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "后端服务不可用"
          description: "后端服务已经离线超过1分钟"

      # ========== HTTP 请求告警 ==========
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(game_ai_cs_http_requests_total{status_code=~"5.."}[5m]))
            /
            sum(rate(game_ai_cs_http_requests_total[5m]))
          ) > 0.05
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "HTTP 5xx 错误率过高"
          description: "HTTP 5xx 错误率超过 5%，当前值: {{ $value | humanizePercentage }}"

      - alert: HighLatencyP95
        expr: |
          histogram_quantile(0.95,
            sum(rate(game_ai_cs_http_request_duration_seconds_bucket[5m])) by (le)
          ) > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "HTTP 请求延迟过高"
          description: "HTTP P95 延迟超过 3 秒，当前值: {{ $value | humanizeDuration }}"

      - alert: HighRequestRate
        expr: sum(rate(game_ai_cs_http_requests_total[1m])) > 1000
        for: 5m
        labels:
          severity: info
        annotations:
          summary: "请求量激增"
          description: "每秒请求数超过 1000，当前值: {{ $value }}"

      # ========== WebSocket 告警 ==========
      - alert: HighWebSocketConnections
        expr: sum(game_ai_cs_ws_connections_active) > 5000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "WebSocket 连接数过高"
          description: "WebSocket 活跃连接数超过 5000，当前值: {{ $value }}"

      - alert: NoWebSocketConnections
        expr: sum(game_ai_cs_ws_connections_active) == 0
        for: 10m
        labels:
          severity: info
        annotations:
          summary: "无 WebSocket 连接"
          description: "10分钟内没有 WebSocket 连接，可能服务异常"

      # ========== Dify AI 告警 ==========
      - alert: DifyAPIHighErrorRate
        expr: |
          (
            sum(rate(game_ai_cs_dify_requests_total{status="error"}[5m]))
            /
            sum(rate(game_ai_cs_dify_requests_total[5m]))
          ) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Dify API 错误率过高"
          description: "Dify API 错误率超过 10%，当前值: {{ $value | humanizePercentage }}"

      - alert: DifyAPIRateLimited
        expr: sum(rate(game_ai_cs_dify_requests_total{status="rate_limited"}[5m])) > 0
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Dify API 触发限流"
          description: "Dify API 正在被限流"

      - alert: DifyAPIHighLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(game_ai_cs_dify_request_duration_seconds_bucket[5m])) by (le)
          ) > 30
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Dify API 响应过慢"
          description: "Dify API P95 延迟超过 30 秒，当前值: {{ $value | humanizeDuration }}"

      # ========== 队列告警 ==========
      - alert: HighQueueLength
        expr: game_ai_cs_queue_length > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "队列积压"
          description: "队列 {{ $labels.queue_name }} 积压超过 100，当前值: {{ $value }}"

      - alert: HighQueueWaitTime
        expr: |
          histogram_quantile(0.95,
            sum(rate(game_ai_cs_queue_wait_time_seconds_bucket[5m])) by (le, queue_name)
          ) > 300
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "队列等待时间过长"
          description: "队列等待 P95 时间超过 5 分钟，当前值: {{ $value | humanizeDuration }}"

      # ========== 数据库告警 ==========
      - alert: SlowDatabaseQueries
        expr: |
          histogram_quantile(0.95,
            sum(rate(game_ai_cs_db_query_duration_seconds_bucket[5m])) by (le)
          ) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "数据库查询过慢"
          description: "数据库 P95 查询延迟超过 1 秒，当前值: {{ $value | humanizeDuration }}"

      # ========== 资源告警 ==========
      - alert: HighMemoryUsage
        expr: |
          (
            game_ai_cs_nodejs_heap_size_used_bytes
            /
            game_ai_cs_nodejs_heap_size_total_bytes
          ) > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "内存使用率过高"
          description: "Node.js 堆内存使用率超过 85%，当前值: {{ $value | humanizePercentage }}"

      - alert: HighEventLoopLag
        expr: game_ai_cs_nodejs_eventloop_lag_seconds > 0.5
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "事件循环延迟过高"
          description: "Node.js 事件循环延迟超过 500ms，当前值: {{ $value | humanizeDuration }}"

      # ========== 业务告警 ==========
      - alert: HighActiveTickets
        expr: sum(game_ai_cs_tickets_active) > 500
        for: 10m
        labels:
          severity: info
        annotations:
          summary: "活跃工单数量过多"
          description: "活跃工单数量超过 500，当前值: {{ $value }}"

      - alert: NoNewTickets
        expr: sum(rate(game_ai_cs_tickets_created_total[1h])) == 0
        for: 2h
        labels:
          severity: info
        annotations:
          summary: "长时间无新工单"
          description: "2小时内没有新工单创建，请检查服务是否正常"
